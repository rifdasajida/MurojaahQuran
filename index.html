<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Murajaah â€” Hafalan Al-Quran (Smart Recognition)</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Scheherazade+New:wght@400;500;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
@font-face {
  font-family: 'UthmanicHafs';
  src: url('https://verses.quran.foundation/fonts/quran/hafs/uthmanic_hafs/UthmanicHafs1Ver18.woff2') format('woff2');
  font-display: swap;
}
</style>
<style>
:root {
  --gold: #C9A84C; --gold-light: #E8C97A; --gold-dark: #8B6914;
  --emerald: #1B5E42; --emerald-light: #2E8B5B;
  --cream: #F8F3EA;
  --bg: #0C1D14; --card: #111F18; --card2: #162B1E;
  --border: rgba(201,168,76,0.18);
  --text: #F0EAD8; --muted: rgba(240,234,216,0.5);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  background: var(--bg);
  font-family: 'Inter', sans-serif;
  color: var(--text);
  display: flex; flex-direction: column;
}
body::before {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background:
    radial-gradient(ellipse at 15% 0%,   rgba(201,168,76,0.07) 0%, transparent 55%),
    radial-gradient(ellipse at 85% 100%, rgba(27,94,66,0.13)  0%, transparent 55%);
}
body::after {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0; opacity: .5;
  background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg stroke='%23C9A84C' stroke-width='.35' fill='none' opacity='.09'%3E%3Cpath d='M40 0L80 40L40 80L0 40Z'/%3E%3Cpath d='M40 14L66 40L40 66L14 40Z'/%3E%3C/g%3E%3C/svg%3E");
}

/* â”€â”€ LAYOUT â”€â”€ */
.layout { position: relative; z-index: 1; display: grid; grid-template-columns: 1fr 360px; gap: 0; height: 100vh; }
@media(max-width:900px){ .layout{ grid-template-columns:1fr; grid-template-rows:auto 1fr; height:auto; } }

/* â”€â”€ LEFT: MUSHAF â”€â”€ */
.mushaf-panel {
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  height: 100vh; overflow: hidden;
}
@media(max-width:900px){ .mushaf-panel{ height:auto; border-right:none; border-bottom:1px solid var(--border); } }

.mushaf-header {
  padding: 16px 24px 12px;
  border-bottom: 1px solid var(--border);
  background: rgba(17,31,24,0.9);
  backdrop-filter: blur(8px);
  display: flex; flex-direction: column; gap: 12px;
  flex-shrink: 0;
}
.mushaf-header-top {
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
}
.mushaf-title-area { display: flex; flex-direction: column; gap: 2px; }
.mushaf-label { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--gold); font-weight: 600; }
.mushaf-surah { font-family: 'Amiri', serif; font-size: 22px; color: var(--gold-light); }
.page-info { font-size: 11px; color: var(--muted); }

.mushaf-controls {
  display: flex; gap: 12px; align-items: flex-end;
}
.control-group { flex: 1; }
.control-group-label { font-size: 10px; color: var(--muted); margin-bottom: 4px; }

.page-select-row { display: flex; gap: 8px; align-items: center; }
.page-select-row select, .page-select-row input {
  background: var(--card2); border: 1px solid var(--border); color: var(--text);
  border-radius: 8px; padding: 7px 12px; font-family: 'Inter', sans-serif; font-size: 12px;
  outline: none; cursor: pointer; -webkit-appearance: none; width: 100%;
}
.page-select-row input { width: 60px; text-align: center; }
.page-select-row select:focus, .page-select-row input:focus { border-color: var(--gold); }

/* DISPLAY MODE TOGGLE */
.display-toggle {
  display: flex;
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}
.display-toggle-btn {
  flex: 1;
  padding: 7px 12px;
  background: transparent;
  border: none;
  color: var(--muted);
  font-size: 11px;
  font-family: 'Inter', sans-serif;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 500;
}
.display-toggle-btn:hover {
  color: var(--text);
}
.display-toggle-btn.active {
  background: var(--gold);
  color: var(--bg);
  font-weight: 600;
}

/* MUSHAF BODY */
.mushaf-body {
  flex: 1; overflow-y: auto;
  padding: 28px 32px 40px;
  scrollbar-width: thin; scrollbar-color: var(--border) transparent;
}
.mushaf-body::-webkit-scrollbar { width: 4px; }
.mushaf-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* BISMILLAH */
.bismillah {
  text-align: center;
  font-family: 'UthmanicHafs', 'Scheherazade New', serif;
  font-size: clamp(28px, 3.5vw, 38px);
  color: var(--gold-light);
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
  line-height: 2.2;
}

/* AYAH ROW - Word by Word Mode */
.ayah-row {
  direction: rtl; text-align: justify;
  margin-bottom: 16px;
  line-height: 2.8;
  padding: 8px;
  border-radius: 8px;
  transition: background 0.3s;
}
.ayah-row.playing {
  background: rgba(201,168,76,0.12);
  box-shadow: 0 0 0 2px rgba(201,168,76,0.3);
}
.ayah-row.current-reading {
  background: rgba(46,139,91,0.08);
  border-left: 3px solid var(--emerald-light);
}

/* AYAH ROW - Mushaf Madani Mode */
.ayah-row.madani-mode {
  direction: rtl;
  text-align: justify;
  padding: 16px 20px;
  margin-bottom: 0;
  border-bottom: 1px solid rgba(201,168,76,0.08);
  line-height: 2.6;
  background: transparent;
  border-radius: 0;
}
.ayah-row.madani-mode:hover {
  background: rgba(201,168,76,0.04);
}
.ayah-row.madani-mode.playing {
  background: rgba(201,168,76,0.12);
  box-shadow: none;
  border-bottom-color: var(--gold);
}

.ayah-number {
  display: inline-flex; align-items: center; justify-content: center;
  width: 28px; height: 28px;
  border: 1px solid rgba(201,168,76,0.3);
  border-radius: 50%; font-size: 10px; color: var(--gold);
  margin-right: 4px; vertical-align: middle;
  font-family: 'Inter', sans-serif;
}

/* Madani mode - ayah number di kanan */
.madani-mode .ayah-number {
  margin-right: 0;
  margin-left: 8px;
}

/* WORD STYLING */
.w {
  font-family: 'UthmanicHafs', 'Scheherazade New', serif;
  font-size: clamp(28px, 3.4vw, 40px);
  cursor: default;
  padding: 1px 3px;
  border-radius: 5px;
  display: inline;
  transition: background .2s, color .2s;
  line-height: 2.6;
}
.w.idle    { color: var(--text); }
.w.cursor  { 
  color: var(--gold-light); 
  background: rgba(201,168,76,0.35); 
  animation: blink-cursor 1s ease-in-out infinite;
  font-weight: 600;
  box-shadow: 0 0 0 2px rgba(201,168,76,0.3);
}
.w.correct { color: #5dba7d; background: rgba(76,175,80,0.1); }
.w.wrong   { color: #ef6b5a; background: rgba(239,83,80,0.14); text-decoration: underline wavy rgba(239,83,80,0.5); }
.w.passed  { color: rgba(240,234,216,0.38); }
.w.skipped { color: rgba(201,168,76,0.4); background: rgba(201,168,76,0.05); }
/* Retry cursor: shown on top of a correct (green) word â€” yellow border + pulse */
.w.retry-cursor {
  color: #5dba7d;
  background: rgba(201,168,76,0.30);
  box-shadow: 0 0 0 2px rgba(201,168,76,0.7);
  animation: blink-cursor 0.8s ease-in-out infinite;
}
@keyframes blink-cursor { 0%,100%{background:rgba(201,168,76,.25)} 50%{background:rgba(201,168,76,.5)} }

/* MADANI MODE - Full text styling */
.ayah-text-madani {
  font-family: 'UthmanicHafs', 'Scheherazade New', serif;
  font-size: clamp(30px, 3.6vw, 42px);
  color: var(--text);
  line-height: 2.6;
  display: inline;
}

/* â”€â”€ RIGHT: CONTROL PANEL â”€â”€ */
.ctrl-panel {
  background: var(--card);
  display: flex; flex-direction: column;
  height: 100vh; overflow-y: auto;
}
@media(max-width:900px){ .ctrl-panel{ height:auto; } }

.ctrl-header {
  padding: 20px 20px 14px;
  border-bottom: 1px solid var(--border);
  text-align: center;
}
.app-title { font-family: 'Amiri', serif; font-size: 32px; font-weight: 700; color: var(--gold-light); }
.app-sub { font-size: 10px; letter-spacing: 2.5px; text-transform: uppercase; color: var(--muted); margin-top: 3px; }
.divider-line { width: 60px; height: 1px; background: linear-gradient(90deg,transparent,var(--gold),transparent); margin: 10px auto 0; }

.ctrl-body { flex: 1; padding: 18px 18px 24px; display: flex; flex-direction: column; gap: 14px; }

/* AUDIO PLAYER SECTION */
.audio-player-sec {
  background: linear-gradient(135deg, rgba(27,94,66,0.15), rgba(201,168,76,0.08));
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 15px;
}
.audio-controls { display: flex; flex-direction: column; gap: 10px; }
.audio-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-items: center; }
.audio-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--gold); font-weight: 600; }
.audio-input {
  background: var(--card2);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 13px;
  width: 100%;
  text-align: center;
  font-family: 'Inter', sans-serif;
}
.audio-input:focus { border-color: var(--gold); outline: none; }

.play-btn {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  background: linear-gradient(135deg, var(--emerald-light), var(--emerald));
  color: white;
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(27,94,66,0.3);
}
.play-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(27,94,66,0.4); }
.play-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
.play-btn.playing {
  background: linear-gradient(135deg, #b03020, #7a1f14);
  animation: pulse 1.5s ease-in-out infinite;
}
@keyframes pulse { 0%,100%{box-shadow:0 4px 12px rgba(192,57,43,0.3)} 50%{box-shadow:0 6px 20px rgba(192,57,43,0.6)} }

.audio-status {
  text-align: center;
  font-size: 12px;
  color: var(--muted);
  padding: 8px;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  min-height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.audio-status.active { color: var(--gold-light); }

/* MIC BUTTON */
.mic-center { display: flex; flex-direction: column; align-items: center; gap: 10px; }
.btn-mic {
  width: 90px; height: 90px; border-radius: 50%; border: none; cursor: pointer;
  background: linear-gradient(135deg, var(--emerald-light), var(--emerald));
  color: white; font-size: 34px;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 22px rgba(27,94,66,0.55);
  transition: all .3s; position: relative;
}
.btn-mic:hover:not(:disabled) { transform: scale(1.05); }
.btn-mic:disabled { opacity: .35; cursor: not-allowed; }
.btn-mic.live {
  background: linear-gradient(135deg,#b03020,#7a1f14);
  box-shadow: 0 4px 22px rgba(192,57,43,0.55);
  animation: mpulse 1.5s ease-in-out infinite;
}
.btn-mic.live::after {
  content:''; position:absolute; inset:-7px; border-radius:50%;
  border:2px solid rgba(192,57,43,.35);
  animation:rout 1.5s ease-out infinite;
}
@keyframes mpulse { 0%,100%{box-shadow:0 4px 22px rgba(192,57,43,.5),0 0 0 0 rgba(192,57,43,.25)}55%{box-shadow:0 4px 22px rgba(192,57,43,.6),0 0 0 15px rgba(192,57,43,0)} }
@keyframes rout { 0%{inset:-7px;opacity:.6}100%{inset:-22px;opacity:0} }

.mic-label { font-size: 12px; color: var(--muted); text-align: center; line-height: 1.5; }
.mic-label strong { display: block; font-size: 13px; color: var(--text); }

/* WAVE */
.wave { display: flex; align-items: center; justify-content: center; gap: 2.5px; height: 26px; opacity: 0; transition: opacity .3s; }
.wave.show { opacity: 1; }
.wb { width: 3px; border-radius: 2px; background: var(--gold); animation: wv .75s ease-in-out infinite; }
.wb:nth-child(1){animation-delay:0s}.wb:nth-child(2){animation-delay:.09s}.wb:nth-child(3){animation-delay:.18s}
.wb:nth-child(4){animation-delay:.27s}.wb:nth-child(5){animation-delay:.36s}.wb:nth-child(6){animation-delay:.27s}
.wb:nth-child(7){animation-delay:.18s}.wb:nth-child(8){animation-delay:.09s}.wb:nth-child(9){animation-delay:0s}
@keyframes wv { 0%,100%{height:3px}50%{height:18px} }

/* SECTION CARD */
.sec { background: var(--card2); border: 1px solid var(--border); border-radius: 12px; padding: 13px 15px; }
.sec-label { font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--gold); font-weight: 600; margin-bottom: 9px; }

/* STATS */
.stats-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 7px; }
.stat { text-align: center; background: rgba(0,0,0,.2); border-radius: 8px; border: 1px solid var(--border); padding: 8px 4px; }
.sv { font-size: 20px; font-weight: 700; }
.sv.g{color:#5dba7d}.sv.r{color:#ef6b5a}.sv.b{color:var(--gold)}
.sl { font-size: 9px; text-transform: uppercase; letter-spacing: .8px; color: var(--muted); margin-top: 2px; }

/* PROGRESS */
.prog-bar-bg { height: 6px; background: rgba(0,0,0,.3); border-radius: 3px; overflow: hidden; margin-top: 8px; }
.prog-bar-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg,var(--emerald-light),var(--gold)); transition: width .5s ease; }

/* TRANSCRIPT */
.t-box { background: rgba(0,0,0,.18); border: 1px solid var(--border); border-radius: 9px; padding: 10px 13px; min-height: 46px; }
.t-arabic { font-family: 'Amiri',serif; font-size: 19px; direction: rtl; text-align: right; color: var(--text); line-height: 1.5; }
.t-arabic.live { color: var(--gold-light); }

/* STATUS */
.status-row { display: flex; align-items: center; gap: 7px; }
.sdot { width: 7px; height: 7px; border-radius: 50%; background: var(--muted); flex-shrink: 0; }
.sdot.rec  { background: #ef6b5a; animation: dp .6s infinite; box-shadow:0 0 7px rgba(239,107,90,.6); }
.sdot.ok   { background: #5dba7d; animation: dp 1s infinite; }
.sdot.warn { background: var(--gold); animation: dp .8s infinite; }
@keyframes dp { 0%,100%{opacity:1}50%{opacity:.25} }
.stext { font-size: 11.5px; color: var(--muted); }

/* LOG */
.log-bar { font-size: 11px; font-family: monospace; color: rgba(180,230,180,.8); padding: 8px 12px; background: rgba(0,0,0,.25); border: 1px solid rgba(100,220,100,.12); border-radius: 8px; min-height: 32px; line-height: 1.45; }
.log-bar.err { color: rgba(255,180,180,.9); border-color: rgba(255,100,100,.2); }

/* BUTTONS ROW */
.btn-row { display: flex; gap: 7px; }
.btn-sm { flex:1; padding: 9px 10px; border-radius: 8px; border: 1px solid var(--border); background: rgba(0,0,0,.2); color: var(--text); font-family:'Inter',sans-serif; font-size: 12px; font-weight: 500; cursor: pointer; transition: all .2s; text-align: center; }
.btn-sm:hover { border-color: var(--gold); color: var(--gold); }
.btn-sm.red:hover { border-color:rgba(239,107,90,.5); color:#ef6b5a; }
.btn-sm.green { background: rgba(93,186,125,0.15); border-color: rgba(93,186,125,0.3); }
.btn-sm.green:hover { border-color:#5dba7d; color:#5dba7d; background: rgba(93,186,125,0.25); }

/* â”€â”€ TABS â”€â”€ */
.tab-bar {
  display: flex;
  border-bottom: 1px solid var(--border);
  background: rgba(0,0,0,0.2);
  flex-shrink: 0;
}
.tab-btn {
  flex: 1;
  padding: 12px 8px;
  background: none;
  border: none;
  color: var(--muted);
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}
.tab-btn:hover { color: var(--text); }
.tab-btn.active {
  color: var(--gold-light);
  border-bottom-color: var(--gold);
  font-weight: 600;
}
.tab-content {
  display: none;
  flex: 1;
  overflow-y: auto;
  padding: 16px 18px 24px;
  flex-direction: column;
  gap: 14px;
}
.tab-content.active { display: flex; }

/* â”€â”€ RETRY BANNER â”€â”€ */
.retry-banner {
  background: linear-gradient(135deg, rgba(239,107,90,0.15), rgba(239,83,80,0.08));
  border: 1px solid rgba(239,107,90,0.4);
  border-radius: 12px;
  padding: 14px 16px;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  animation: pulse-red 1.5s ease-in-out infinite;
}
@keyframes pulse-red {
  0%,100% { box-shadow: 0 0 0 0 rgba(239,107,90,0); }
  50% { box-shadow: 0 0 0 6px rgba(239,107,90,0.15); }
}
.retry-ayah-label {
  font-size: 10px;
  letter-spacing: 2px;
  font-weight: 700;
  color: #ef6b5a;
  text-transform: uppercase;
}
.retry-word-row {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  background: rgba(0,0,0,0.25);
  border-radius: 8px;
  padding: 8px 16px;
  width: 100%;
}
.retry-word-hint {
  font-size: 10px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.8px;
}
.retry-word {
  font-family: 'UthmanicHafs', 'Scheherazade New', serif;
  font-size: 32px;
  color: #ef6b5a;
  line-height: 1.5;
  direction: rtl;
}
.retry-label {
  font-size: 12px;
  color: #ef6b5a;
  font-weight: 600;
}
.retry-skip-btn {
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(239,107,90,0.4);
  border-radius: 8px;
  color: var(--muted);
  font-family: 'Inter', sans-serif;
  font-size: 11px;
  padding: 6px 14px;
  cursor: pointer;
  transition: all 0.2s;
}
.retry-skip-btn:hover { color: var(--text); border-color: var(--gold); }

/* â”€â”€ CTRL-BODY (keep for compatibility but tab-content replaces it) â”€â”€ */
.ctrl-body { display: none; }

/* MODE NOTE */
.mode-note {
  font-size: 10px;
  color: var(--muted);
  text-align: center;
  padding: 6px;
  background: rgba(0,0,0,0.15);
  border-radius: 6px;
}

/* Smart Recognition Badge */
.smart-badge {
  display: inline-block;
  background: linear-gradient(135deg, var(--emerald-light), var(--emerald));
  color: white;
  font-size: 9px;
  padding: 3px 8px;
  border-radius: 12px;
  font-weight: 600;
  letter-spacing: 0.5px;
  margin-left: 8px;
  box-shadow: 0 2px 6px rgba(27,94,66,0.3);
}

/* START POSITION CONTROLS */
.start-position-controls {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.start-input-group {
  display: flex;
  align-items: center;
  gap: 10px;
}
.start-label {
  font-size: 12px;
  color: var(--text);
  font-weight: 500;
  min-width: 60px;
}
.start-input {
  flex: 1;
  background: var(--card);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 14px;
  font-family: 'Inter', sans-serif;
  text-align: center;
}
.start-input:focus {
  border-color: var(--gold);
  outline: none;
}
.btn-set-start {
  width: 100%;
  padding: 10px;
  background: linear-gradient(135deg, var(--gold-dark), var(--gold));
  border: none;
  border-radius: 8px;
  color: white;
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(201,168,76,0.3);
}
.btn-set-start:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(201,168,76,0.5);
}
.start-info {
  font-size: 11px;
  color: var(--muted);
  text-align: center;
  padding: 6px;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
  margin-top: 4px;
}

/* COLOR LEGEND */
.color-legend {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 8px;
  background: rgba(0,0,0,0.15);
  border-radius: 6px;
}
.legend-sample {
  font-family: 'UthmanicHafs', 'Scheherazade New', serif;
  font-size: 18px;
  padding: 2px 8px;
  border-radius: 4px;
  min-width: 40px;
  text-align: center;
}
.legend-text {
  font-size: 11px;
  color: var(--text);
  flex: 1;
}
.cursor-sample {
  color: var(--gold-light);
  background: rgba(201,168,76,0.35);
  font-weight: 600;
  box-shadow: 0 0 0 2px rgba(201,168,76,0.3);
}
.correct-sample {
  color: #5dba7d;
  background: rgba(76,175,80,0.1);
}
.wrong-sample {
  color: #ef6b5a;
  background: rgba(239,83,80,0.14);
  text-decoration: underline wavy rgba(239,83,80,0.5);
}
.skipped-sample {
  color: rgba(201,168,76,0.6);
  background: rgba(201,168,76,0.08);
}
.passed-sample {
  color: rgba(240,234,216,0.38);
}
.legend-note {
  font-size: 10px;
  color: var(--gold);
  text-align: center;
  padding: 8px;
  background: rgba(201,168,76,0.08);
  border-radius: 6px;
  margin-top: 8px;
  border: 1px dashed rgba(201,168,76,0.3);
}
</style>
</head>
<body>
<div class="layout">

  <!-- â•â•â•â•â•â• LEFT: MUSHAF PAGE â•â•â•â•â•â• -->
  <div class="mushaf-panel">
    <div class="mushaf-header">
      <div class="mushaf-header-top">
        <div class="mushaf-title-area">
          <span class="mushaf-label">Halaman</span>
          <span class="mushaf-surah" id="pageTitle">Al-Qalam</span>
          <span class="page-info" id="pageInfo">â€”</span>
        </div>
      </div>

      <div class="mushaf-controls">
        <div class="control-group" style="flex:1">
          <div class="control-group-label">Pilih Surah</div>
          <select id="surahSel" onchange="loadSurah()"></select>
        </div>
      </div>
    </div>

    <div class="mushaf-body" id="mushafBody">
      <!-- Rendered by JS -->
    </div>
  </div>

  <!-- â•â•â•â•â•â• RIGHT: CONTROL PANEL â•â•â•â•â•â• -->
  <div class="ctrl-panel">
    <div class="ctrl-header">
      <div class="app-title">Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
      <div class="app-sub">Smart Hafalan Tracker <span class="smart-badge">AI POWERED</span></div>
      <div class="divider-line"></div>
    </div>

    <!-- TABS -->
    <div class="tab-bar">
      <button class="tab-btn active" id="tab-voice" onclick="switchTab('voice')">ğŸ™ï¸ Voice</button>
      <button class="tab-btn" id="tab-audio" onclick="switchTab('audio')">ğŸ”Š Audio</button>
      <button class="tab-btn" id="tab-sambung" onclick="switchTab('sambung')">ğŸ”— Sambung</button>
    </div>

    <!-- TAB: VOICE -->
    <div class="tab-content active" id="tabcontent-voice">

      <!-- MIC -->
      <div class="mic-center">
        <div class="wave" id="wave">
          <div class="wb"></div><div class="wb"></div><div class="wb"></div>
          <div class="wb"></div><div class="wb"></div><div class="wb"></div>
          <div class="wb"></div><div class="wb"></div><div class="wb"></div>
        </div>
        <button class="btn-mic" id="btnMic" onclick="toggleSession()">ğŸ™ï¸</button>
        <div class="mic-label">
          <strong id="micLabel">Mulai Sesi</strong>
          <span id="micSub">Tekan untuk aktifkan mikrofon</span>
        </div>
        <div class="mode-note">ğŸ§  Smart tracking: otomatis mengikuti bacaan Anda</div>
      </div>

      <!-- RETRY BANNER (hidden by default) -->
      <div class="retry-banner" id="retryBanner" style="display:none">
        <div class="retry-ayah-label" id="retryAyahNum">AYAT â€”</div>
        <div class="retry-label">âš ï¸ ULANGI DARI KURSOR KUNING â†‘</div>
        <div class="retry-word-row">
          <span class="retry-word-hint">Kata yang salah:</span>
          <div class="retry-word" id="retryWord">â€”</div>
        </div>
        <button class="retry-skip-btn" onclick="skipWrongWord()">Lewati ayat ini â†’</button>
      </div>

      <!-- START POSITION -->
      <div class="sec">
        <div class="sec-label">ğŸ“ Mulai Dari Ayat</div>
        <div class="start-position-controls">
          <div class="start-input-group">
            <label class="start-label">Ayat ke</label>
            <input type="number" id="startAyahNum" class="start-input" value="1" min="1" onchange="updateStartPosition()">
          </div>
          <button class="btn-set-start" onclick="goToStartPosition()">
            ğŸ“ Pindah ke Posisi Ini
          </button>
        </div>
        <div class="start-info" id="startInfo">Akan mulai dari ayat 1</div>
      </div>

      <!-- STATUS -->
      <div class="sec">
        <div class="sec-label">Status</div>
        <div class="status-row" style="margin-bottom:8px">
          <div class="sdot" id="sdot"></div>
          <span class="stext" id="stext">Belum aktif</span>
        </div>
        <div class="t-box">
          <div class="t-arabic" id="tText">â€”</div>
        </div>
      </div>

      <!-- STATS -->
      <div class="sec">
        <div class="sec-label">Statistik Sesi</div>
        <div class="stats-grid">
          <div class="stat"><div class="sv g" id="stOk">0</div><div class="sl">âœ“ Benar</div></div>
          <div class="stat"><div class="sv r" id="stErr">0</div><div class="sl">âœ— Salah</div></div>
          <div class="stat"><div class="sv b" id="stPos">0</div><div class="sl">Kata ke</div></div>
        </div>
        <div class="prog-bar-bg"><div class="prog-bar-fill" id="progFill" style="width:0%"></div></div>
      </div>

      <!-- LOG -->
      <div class="log-bar" id="logBar">ğŸ§  Smart Recognition siap</div>

      <!-- BUTTONS -->
      <div class="btn-row">
        <button class="btn-sm red" onclick="resetSession()">â†º Reset</button>
        <button class="btn-sm green" onclick="markCorrect()">âœ“ Benar</button>
        <button class="btn-sm" onclick="jumpBack()">â® -5</button>
        <button class="btn-sm" onclick="skipForward()">â­ Skip</button>
      </div>

    </div><!-- end tab-voice -->

    <!-- TAB: AUDIO -->
    <div class="tab-content" id="tabcontent-audio">
      <div class="audio-player-sec" style="border:none; background:none; padding: 18px 18px 0;">
        <div class="sec-label">ğŸ”Š Audio Muroja'ah</div>
        <div class="audio-controls">
          <div class="audio-row">
            <div>
              <div class="audio-label">Dari Ayat</div>
              <input type="number" id="audioStartAyah" class="audio-input" value="1" min="1">
            </div>
            <div>
              <div class="audio-label">Sampai Ayat</div>
              <input type="number" id="audioEndAyah" class="audio-input" value="5" min="1">
            </div>
          </div>
          <div>
            <div class="audio-label">Jumlah Pengulangan</div>
            <input type="number" id="audioRepeatCount" class="audio-input" value="3" min="1" max="100">
          </div>
          <div>
            <div class="audio-label">Jeda Antar Ayat (detik)</div>
            <input type="number" id="audioPause" class="audio-input" value="2" min="0" max="10" step="0.5">
          </div>
          <button class="play-btn" id="audioPlayBtn" onclick="toggleAudioPlayer()">
            <span id="audioPlayIcon">â–¶ï¸</span>
            <span id="audioPlayText">Putar Audio</span>
          </button>
          <div class="audio-status" id="audioStatus">Siap memutar audio</div>
        </div>
      </div>
    </div><!-- end tab-audio -->

    <!-- TAB: SAMBUNG AYAT -->
    <div class="tab-content" id="tabcontent-sambung">
      
      <!-- SAMBUNG STATE: SETUP -->
      <div id="sambungSetup">
        <div class="sec">
          <div class="sec-label">ğŸ”— Sambung Ayat</div>
          <div class="mode-note" style="margin-bottom:12px">Sistem membaca 1 ayat acak, kamu sambung ayat berikutnya</div>

          <!-- Surah multi-select list -->
          <div style="font-size:11px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.8px">Pilih Surah (bisa lebih dari satu)</div>
          <div id="sambungSurahList" style="display:flex;flex-direction:column;gap:4px;max-height:220px;overflow-y:auto;background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:10px;padding:6px 4px">
            <!-- Populated by JS -->
          </div>

          <!-- Per-surah range config (shown when surah is selected) -->
          <div id="sambungRangeConfig" style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
            <!-- Populated by JS when a surah checkbox is toggled -->
          </div>

          <button class="btn-set-start" style="margin-top:12px" onclick="startSambungMode()">
            ğŸ² Mulai Sambung Ayat
          </button>
        </div>
      </div>

      <!-- SAMBUNG STATE: ACTIVE -->
      <div id="sambungActive" style="display:none;flex-direction:column;gap:12px">

        <!-- Ayat yang dibacakan sistem -->
        <div class="sec" id="sambungPromptSec">
          <div class="sec-label" style="color:var(--gold)">ğŸ”Š Sistem Membaca</div>
          <div id="sambungAyahInfo" style="font-size:11px;color:var(--muted);margin-bottom:6px">â€”</div>
          <div id="sambungAyahText" style="font-family:'UthmanicHafs','Scheherazade New',serif;font-size:26px;line-height:1.9;direction:rtl;text-align:right;color:var(--text);padding:10px 12px;background:rgba(0,0,0,0.2);border-radius:10px;border:1px solid var(--border)">â€”</div>
          <button id="sambungReplayBtn" onclick="sambungReplayAudio()" style="margin-top:8px;background:rgba(201,168,76,0.12);border:1px solid rgba(201,168,76,0.3);border-radius:8px;color:var(--gold-light);font-size:12px;padding:7px 14px;cursor:pointer;width:100%">
            ğŸ” Putar Ulang
          </button>
        </div>

        <!-- Status validasi user -->
        <div class="sec">
          <div class="sec-label">Status</div>
          <div class="status-row" style="margin-bottom:8px">
            <div class="sdot" id="sambungDot"></div>
            <span class="stext" id="sambungText">Siap â€” tekan mikrofon untuk sambung</span>
          </div>
          <div class="t-box" style="min-height:40px">
            <div class="t-arabic" id="sambungTranscript">â€”</div>
          </div>
        </div>

        <!-- Mic button -->
        <div class="mic-center" style="padding:8px 0">
          <button class="btn-mic" id="sambungMicBtn" onclick="toggleSambungSession()" style="width:64px;height:64px;font-size:26px">ğŸ™ï¸</button>
          <div class="mic-label">
            <strong id="sambungMicLabel">Sambung Ayat</strong>
            <span id="sambungMicSub">Tekan untuk bicara</span>
          </div>
        </div>

        <!-- Hasil -->
        <div id="sambungResult" style="display:none" class="sec">
          <div class="sec-label" id="sambungResultLabel">Hasil</div>
          <div id="sambungExpected" style="font-family:'UthmanicHafs','Scheherazade New',serif;font-size:22px;direction:rtl;text-align:right;line-height:1.9;padding:10px 12px;background:rgba(0,0,0,0.2);border-radius:10px;border:1px solid var(--border);margin-bottom:8px">â€”</div>
          <div id="sambungResultMsg" style="font-size:13px;font-weight:600;text-align:center;padding:10px;border-radius:8px;margin-bottom:8px">â€”</div>
          <div style="display:flex;gap:8px">
            <button onclick="nextSambung()" style="flex:1;padding:10px;background:linear-gradient(135deg,var(--gold-dark),var(--gold));border:none;border-radius:8px;color:white;font-weight:600;cursor:pointer;font-size:13px">ğŸ² Soal Baru</button>
            <button onclick="stopSambungMode()" style="flex:1;padding:10px;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:8px;color:var(--muted);cursor:pointer;font-size:13px">âœ• Selesai</button>
          </div>
        </div>

        <!-- Skor sesi -->
        <div class="sec">
          <div class="sec-label">Skor Sesi</div>
          <div class="stats-grid">
            <div class="stat"><div class="sv g" id="sambungOk">0</div><div class="sl">âœ“ Benar</div></div>
            <div class="stat"><div class="sv r" id="sambungErr">0</div><div class="sl">âœ— Salah</div></div>
            <div class="stat"><div class="sv b" id="sambungTotal">0</div><div class="sl">Total</div></div>
          </div>
        </div>

        <button onclick="stopSambungMode()" style="background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:12px;padding:8px;cursor:pointer">
          â† Ubah Pengaturan
        </button>
      </div>

    </div><!-- end tab-sambung -->

  </div><!-- end ctrl-panel -->
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QURAN DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SURAHS = {
  1: {
    name:"Al-Fatihah", num:1, bismillah: true,
    ayahs:[
      {n:1, words:["Ø¨ÙØ³Ù’Ù…Ù","Ø§Ù„Ù„ÙÙ‘Ù‡Ù","Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù","Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù"]},
      {n:2, words:["Ø§Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù","Ù„ÙÙ„ÙÙ‘Ù‡Ù","Ø±ÙØ¨ÙÙ‘","Ø§Ù„Ù’Ø¹ÙØ§Ù„ÙÙ…ÙÙŠÙ†Ù"]},
      {n:3, words:["Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù","Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù"]},
      {n:4, words:["Ù…ÙØ§Ù„ÙÙƒÙ","ÙŠÙÙˆÙ’Ù…Ù","Ø§Ù„Ø¯ÙÙ‘ÙŠÙ†Ù"]},
      {n:5, words:["Ø¥ÙÙŠÙÙ‘Ø§ÙƒÙ","Ù†ÙØ¹Ù’Ø¨ÙØ¯Ù","ÙˆÙØ¥ÙÙŠÙÙ‘Ø§ÙƒÙ","Ù†ÙØ³Ù’ØªÙØ¹ÙÙŠÙ†Ù"]},
      {n:6, words:["Ø§Ù‡Ù’Ø¯ÙÙ†ÙØ§","Ø§Ù„ØµÙÙ‘Ø±ÙØ§Ø·Ù","Ø§Ù„Ù’Ù…ÙØ³Ù’ØªÙÙ‚ÙÙŠÙ…Ù"]},
      {n:7, words:["ØµÙØ±ÙØ§Ø·Ù","Ø§Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù","Ø£ÙÙ†Ù’Ø¹ÙÙ…Ù’ØªÙ","Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’","ØºÙÙŠÙ’Ø±Ù","Ø§Ù„Ù’Ù…ÙØºÙ’Ø¶ÙÙˆØ¨Ù","Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’","ÙˆÙÙ„ÙØ§","Ø§Ù„Ø¶ÙÙ‘Ø§Ù„ÙÙ‘ÙŠÙ†Ù"]}
    ]
  },
  68: {
    name:"Al-Qalam", num:68, bismillah: true,
    ayahs:[
      {n:1,  words:["Ù†Ù“","ÙˆÙØ§Ù„Ù’Ù‚ÙÙ„ÙÙ…Ù","ÙˆÙÙ…ÙØ§","ÙŠÙØ³Ù’Ø·ÙØ±ÙÙˆÙ†Ù"]},
      {n:2,  words:["Ù…ÙØ§","Ø£ÙÙ†ØªÙ","Ø¨ÙÙ†ÙØ¹Ù’Ù…ÙØªÙ","Ø±ÙØ¨ÙÙ‘ÙƒÙ","Ø¨ÙÙ…ÙØ¬Ù’Ù†ÙÙˆÙ†Ù"]},
      {n:3,  words:["ÙˆÙØ¥ÙÙ†ÙÙ‘","Ù„ÙÙƒÙ","Ù„ÙØ£ÙØ¬Ù’Ø±Ù‹Ø§","ØºÙÙŠÙ’Ø±Ù","Ù…ÙÙ…Ù’Ù†ÙÙˆÙ†Ù"]},
      {n:4,  words:["ÙˆÙØ¥ÙÙ†ÙÙ‘ÙƒÙ","Ù„ÙØ¹ÙÙ„ÙÙ‰Ù°","Ø®ÙÙ„ÙÙ‚Ù","Ø¹ÙØ¸ÙÙŠÙ…Ù"]},
      {n:5,  words:["ÙÙØ³ÙØªÙØ¨Ù’ØµÙØ±Ù","ÙˆÙÙŠÙØ¨Ù’ØµÙØ±ÙÙˆÙ†Ù"]},
      {n:6,  words:["Ø¨ÙØ£ÙÙŠÙÙ‘ÙƒÙÙ…Ù","Ø§Ù„Ù’Ù…ÙÙÙ’ØªÙÙˆÙ†Ù"]},
      {n:7,  words:["Ø¥ÙÙ†ÙÙ‘","Ø±ÙØ¨ÙÙ‘ÙƒÙ","Ù‡ÙÙˆÙ","Ø£ÙØ¹Ù’Ù„ÙÙ…Ù","Ø¨ÙÙ…ÙÙ†","Ø¶ÙÙ„ÙÙ‘","Ø¹ÙÙ†","Ø³ÙØ¨ÙÙŠÙ„ÙÙ‡Ù","ÙˆÙÙ‡ÙÙˆÙ","Ø£ÙØ¹Ù’Ù„ÙÙ…Ù","Ø¨ÙØ§Ù„Ù’Ù…ÙÙ‡Ù’ØªÙØ¯ÙÙŠÙ†Ù"]},
      {n:8,  words:["ÙÙÙ„ÙØ§","ØªÙØ·ÙØ¹Ù","Ø§Ù„Ù’Ù…ÙÙƒÙØ°ÙÙ‘Ø¨ÙÙŠÙ†Ù"]},
      {n:9,  words:["ÙˆÙØ¯ÙÙ‘ÙˆØ§","Ù„ÙÙˆÙ’","ØªÙØ¯Ù’Ù‡ÙÙ†Ù","ÙÙÙŠÙØ¯Ù’Ù‡ÙÙ†ÙÙˆÙ†Ù"]},
      {n:10, words:["ÙˆÙÙ„ÙØ§","ØªÙØ·ÙØ¹Ù’","ÙƒÙÙ„ÙÙ‘","Ø­ÙÙ„ÙÙ‘Ø§ÙÙ","Ù…ÙÙ‘Ù‡ÙÙŠÙ†Ù"]},
      {n:11, words:["Ù‡ÙÙ…ÙÙ‘Ø§Ø²Ù","Ù…ÙÙ‘Ø´ÙÙ‘Ø§Ø¡Ù","Ø¨ÙÙ†ÙÙ…ÙÙŠÙ…Ù"]},
      {n:12, words:["Ù…ÙÙ‘Ù†ÙÙ‘Ø§Ø¹Ù","Ù„ÙÙ‘Ù„Ù’Ø®ÙÙŠÙ’Ø±Ù","Ù…ÙØ¹Ù’ØªÙØ¯Ù","Ø£ÙØ«ÙÙŠÙ…Ù"]},
      {n:13, words:["Ø¹ÙØªÙÙ„ÙÙ‘","Ø¨ÙØ¹Ù’Ø¯Ù","Ø°ÙÙ°Ù„ÙÙƒÙ","Ø²ÙÙ†ÙÙŠÙ…Ù"]},
      {n:14, words:["Ø£ÙÙ†","ÙƒÙØ§Ù†Ù","Ø°ÙØ§","Ù…ÙØ§Ù„Ù","ÙˆÙØ¨ÙÙ†ÙÙŠÙ†Ù"]},
      {n:15, words:["Ø¥ÙØ°ÙØ§","ØªÙØªÙ’Ù„ÙÙ‰Ù°","Ø¹ÙÙ„ÙÙŠÙ’Ù‡Ù","Ø¢ÙŠÙØ§ØªÙÙ†ÙØ§","Ù‚ÙØ§Ù„Ù","Ø£ÙØ³ÙØ§Ø·ÙÙŠØ±Ù","Ø§Ù„Ù’Ø£ÙÙˆÙÙ‘Ù„ÙÙŠÙ†Ù"]},
      {n:16, words:["Ø³ÙÙ†ÙØ³ÙÙ…ÙÙ‡Ù","Ø¹ÙÙ„ÙÙ‰","Ø§Ù„Ù’Ø®ÙØ±Ù’Ø·ÙÙˆÙ…Ù"]},
      {n:17, words:["Ø¥ÙÙ†ÙÙ‘Ø§","Ø¨ÙÙ„ÙÙˆÙ’Ù†ÙØ§Ù‡ÙÙ…Ù’","ÙƒÙÙ…ÙØ§","Ø¨ÙÙ„ÙÙˆÙ’Ù†ÙØ§","Ø£ÙØµÙ’Ø­ÙØ§Ø¨Ù","Ø§Ù„Ù’Ø¬ÙÙ†ÙÙ‘Ø©Ù","Ø¥ÙØ°Ù’","Ø£ÙÙ‚Ù’Ø³ÙÙ…ÙÙˆØ§","Ù„ÙÙŠÙØµÙ’Ø±ÙÙ…ÙÙ†ÙÙ‘Ù‡ÙØ§","Ù…ÙØµÙ’Ø¨ÙØ­ÙÙŠÙ†Ù"]},
      {n:18, words:["ÙˆÙÙ„ÙØ§","ÙŠÙØ³Ù’ØªÙØ«Ù’Ù†ÙÙˆÙ†Ù"]},
      {n:19, words:["ÙÙØ·ÙØ§ÙÙ","Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙØ§","Ø·ÙØ§Ø¦ÙÙÙŒ","Ù…ÙÙ‘Ù†","Ø±ÙÙ‘Ø¨ÙÙ‘ÙƒÙ","ÙˆÙÙ‡ÙÙ…Ù’","Ù†ÙØ§Ø¦ÙÙ…ÙÙˆÙ†Ù"]},
      {n:20, words:["ÙÙØ£ÙØµÙ’Ø¨ÙØ­ÙØªÙ’","ÙƒÙØ§Ù„ØµÙÙ‘Ø±ÙÙŠÙ…Ù"]},
      {n:21, words:["ÙÙØªÙÙ†ÙØ§Ø¯ÙÙˆÙ’Ø§","Ù…ÙØµÙ’Ø¨ÙØ­ÙÙŠÙ†Ù"]},
      {n:22, words:["Ø£ÙÙ†Ù","Ø§ØºÙ’Ø¯ÙÙˆØ§","Ø¹ÙÙ„ÙÙ‰Ù°","Ø­ÙØ±Ù’Ø«ÙÙƒÙÙ…Ù’","Ø¥ÙÙ†","ÙƒÙÙ†ØªÙÙ…Ù’","ØµÙØ§Ø±ÙÙ…ÙÙŠÙ†Ù"]},
      {n:23, words:["ÙÙØ§Ù†Ø·ÙÙ„ÙÙ‚ÙÙˆØ§","ÙˆÙÙ‡ÙÙ…Ù’","ÙŠÙØªÙØ®ÙØ§ÙÙØªÙÙˆÙ†Ù"]},
      {n:24, words:["Ø£ÙÙ†","Ù„ÙÙ‘Ø§","ÙŠÙØ¯Ù’Ø®ÙÙ„ÙÙ†ÙÙ‘Ù‡ÙØ§","Ø§Ù„Ù’ÙŠÙÙˆÙ’Ù…Ù","Ø¹ÙÙ„ÙÙŠÙ’ÙƒÙÙ…","Ù…ÙÙ‘Ø³Ù’ÙƒÙÙŠÙ†ÙŒ"]},
      {n:25, words:["ÙˆÙØºÙØ¯ÙÙˆÙ’Ø§","Ø¹ÙÙ„ÙÙ‰Ù°","Ø­ÙØ±Ù’Ø¯Ù","Ù‚ÙØ§Ø¯ÙØ±ÙÙŠÙ†Ù"]},
      {n:26, words:["ÙÙÙ„ÙÙ…ÙÙ‘Ø§","Ø±ÙØ£ÙÙˆÙ’Ù‡ÙØ§","Ù‚ÙØ§Ù„ÙÙˆØ§","Ø¥ÙÙ†ÙÙ‘Ø§","Ù„ÙØ¶ÙØ§Ù„ÙÙ‘ÙˆÙ†Ù"]},
      {n:27, words:["Ø¨ÙÙ„Ù’","Ù†ÙØ­Ù’Ù†Ù","Ù…ÙØ­Ù’Ø±ÙÙˆÙ…ÙÙˆÙ†Ù"]},
      {n:28, words:["Ù‚ÙØ§Ù„Ù","Ø£ÙÙˆÙ’Ø³ÙØ·ÙÙ‡ÙÙ…Ù’","Ø£ÙÙ„ÙÙ…Ù’","Ø£ÙÙ‚ÙÙ„","Ù„ÙÙ‘ÙƒÙÙ…Ù’","Ù„ÙÙˆÙ’Ù„ÙØ§","ØªÙØ³ÙØ¨ÙÙ‘Ø­ÙÙˆÙ†Ù"]},
      {n:29, words:["Ù‚ÙØ§Ù„ÙÙˆØ§","Ø³ÙØ¨Ù’Ø­ÙØ§Ù†Ù","Ø±ÙØ¨ÙÙ‘Ù†ÙØ§","Ø¥ÙÙ†ÙÙ‘Ø§","ÙƒÙÙ†ÙÙ‘Ø§","Ø¸ÙØ§Ù„ÙÙ…ÙÙŠÙ†Ù"]},
      {n:30, words:["ÙÙØ£ÙÙ‚Ù’Ø¨ÙÙ„Ù","Ø¨ÙØ¹Ù’Ø¶ÙÙ‡ÙÙ…Ù’","Ø¹ÙÙ„ÙÙ‰Ù°","Ø¨ÙØ¹Ù’Ø¶Ù","ÙŠÙØªÙÙ„ÙØ§ÙˆÙÙ…ÙÙˆÙ†Ù"]},
      {n:31, words:["Ù‚ÙØ§Ù„ÙÙˆØ§","ÙŠÙØ§","ÙˆÙÙŠÙ’Ù„ÙÙ†ÙØ§","Ø¥ÙÙ†ÙÙ‘Ø§","ÙƒÙÙ†ÙÙ‘Ø§","Ø·ÙØ§ØºÙÙŠÙ†Ù"]},
      {n:32, words:["Ø¹ÙØ³ÙÙ‰Ù°","Ø±ÙØ¨ÙÙ‘Ù†ÙØ§","Ø£ÙÙ†","ÙŠÙØ¨Ù’Ø¯ÙÙ„ÙÙ†ÙØ§","Ø®ÙÙŠÙ’Ø±Ù‹Ø§","Ù…ÙÙ‘Ù†Ù’Ù‡ÙØ§","Ø¥ÙÙ†ÙÙ‘Ø§","Ø¥ÙÙ„ÙÙ‰Ù°","Ø±ÙØ¨ÙÙ‘Ù†ÙØ§","Ø±ÙØ§ØºÙØ¨ÙÙˆÙ†Ù"]},
      {n:33, words:["ÙƒÙØ°ÙÙ°Ù„ÙÙƒÙ","Ø§Ù„Ù’Ø¹ÙØ°ÙØ§Ø¨Ù","ÙˆÙÙ„ÙØ¹ÙØ°ÙØ§Ø¨Ù","Ø§Ù„Ù’Ø¢Ø®ÙØ±ÙØ©Ù","Ø£ÙÙƒÙ’Ø¨ÙØ±Ù","Ù„ÙÙˆÙ’","ÙƒÙØ§Ù†ÙÙˆØ§","ÙŠÙØ¹Ù’Ù„ÙÙ…ÙÙˆÙ†Ù"]},
      {n:34, words:["Ø¥ÙÙ†ÙÙ‘","Ù„ÙÙ„Ù’Ù…ÙØªÙÙ‘Ù‚ÙÙŠÙ†Ù","Ø¹ÙÙ†Ø¯Ù","Ø±ÙØ¨ÙÙ‘Ù‡ÙÙ…Ù’","Ø¬ÙÙ†ÙÙ‘Ø§ØªÙ","Ø§Ù„Ù†ÙÙ‘Ø¹ÙÙŠÙ…Ù"]},
      {n:35, words:["Ø£ÙÙÙÙ†ÙØ¬Ù’Ø¹ÙÙ„Ù","Ø§Ù„Ù’Ù…ÙØ³Ù’Ù„ÙÙ…ÙÙŠÙ†Ù","ÙƒÙØ§Ù„Ù’Ù…ÙØ¬Ù’Ø±ÙÙ…ÙÙŠÙ†Ù"]},
      {n:36, words:["Ù…ÙØ§","Ù„ÙÙƒÙÙ…Ù’","ÙƒÙÙŠÙ’ÙÙ","ØªÙØ­Ù’ÙƒÙÙ…ÙÙˆÙ†Ù"]},
      {n:37, words:["Ø£ÙÙ…Ù’","Ù„ÙÙƒÙÙ…Ù’","ÙƒÙØªÙØ§Ø¨ÙŒ","ÙÙÙŠÙ‡Ù","ØªÙØ¯Ù’Ø±ÙØ³ÙÙˆÙ†Ù"]},
      {n:38, words:["Ø¥ÙÙ†ÙÙ‘","Ù„ÙÙƒÙÙ…Ù’","ÙÙÙŠÙ‡Ù","Ù„ÙÙ…ÙØ§","ØªÙØ®ÙÙŠÙÙ‘Ø±ÙÙˆÙ†Ù"]},
      {n:39, words:["Ø£ÙÙ…Ù’","Ù„ÙÙƒÙÙ…Ù’","Ø£ÙÙŠÙ’Ù…ÙØ§Ù†ÙŒ","Ø¹ÙÙ„ÙÙŠÙ’Ù†ÙØ§","Ø¨ÙØ§Ù„ÙØºÙØ©ÙŒ","Ø¥ÙÙ„ÙÙ‰Ù°","ÙŠÙÙˆÙ’Ù…Ù","Ø§Ù„Ù’Ù‚ÙÙŠÙØ§Ù…ÙØ©Ù","Ø¥ÙÙ†ÙÙ‘","Ù„ÙÙƒÙÙ…Ù’","Ù„ÙÙ…ÙØ§","ØªÙØ­Ù’ÙƒÙÙ…ÙÙˆÙ†Ù"]},
      {n:40, words:["Ø³ÙÙ„Ù’Ù‡ÙÙ…Ù’","Ø£ÙÙŠÙÙ‘Ù‡ÙÙ…","Ø¨ÙØ°ÙÙ°Ù„ÙÙƒÙ","Ø²ÙØ¹ÙÙŠÙ…ÙŒ"]},
      {n:41, words:["Ø£ÙÙ…Ù’","Ù„ÙÙ‡ÙÙ…Ù’","Ø´ÙØ±ÙÙƒÙØ§Ø¡Ù","ÙÙÙ„Ù’ÙŠÙØ£Ù’ØªÙÙˆØ§","Ø¨ÙØ´ÙØ±ÙÙƒÙØ§Ø¦ÙÙ‡ÙÙ…Ù’","Ø¥ÙÙ†","ÙƒÙØ§Ù†ÙÙˆØ§","ØµÙØ§Ø¯ÙÙ‚ÙÙŠÙ†Ù"]},
      {n:42, words:["ÙŠÙÙˆÙ’Ù…Ù","ÙŠÙÙƒÙ’Ø´ÙÙÙ","Ø¹ÙÙ†","Ø³ÙØ§Ù‚Ù","ÙˆÙÙŠÙØ¯Ù’Ø¹ÙÙˆÙ’Ù†Ù","Ø¥ÙÙ„ÙÙ‰","Ø§Ù„Ø³ÙÙ‘Ø¬ÙÙˆØ¯Ù","ÙÙÙ„ÙØ§","ÙŠÙØ³Ù’ØªÙØ·ÙÙŠØ¹ÙÙˆÙ†Ù"]},
      {n:43, words:["Ø®ÙØ§Ø´ÙØ¹ÙØ©Ù‹","Ø£ÙØ¨Ù’ØµÙØ§Ø±ÙÙ‡ÙÙ…Ù’","ØªÙØ±Ù’Ù‡ÙÙ‚ÙÙ‡ÙÙ…Ù’","Ø°ÙÙ„ÙÙ‘Ø©ÙŒ","ÙˆÙÙ‚ÙØ¯Ù’","ÙƒÙØ§Ù†ÙÙˆØ§","ÙŠÙØ¯Ù’Ø¹ÙÙˆÙ’Ù†Ù","Ø¥ÙÙ„ÙÙ‰","Ø§Ù„Ø³ÙÙ‘Ø¬ÙÙˆØ¯Ù","ÙˆÙÙ‡ÙÙ…Ù’","Ø³ÙØ§Ù„ÙÙ…ÙÙˆÙ†Ù"]},
      {n:44, words:["ÙÙØ°ÙØ±Ù’Ù†ÙÙŠ","ÙˆÙÙ…ÙÙ†","ÙŠÙÙƒÙØ°ÙÙ‘Ø¨Ù","Ø¨ÙÙ‡ÙÙ°Ø°ÙØ§","Ø§Ù„Ù’Ø­ÙØ¯ÙÙŠØ«Ù","Ø³ÙÙ†ÙØ³Ù’ØªÙØ¯Ù’Ø±ÙØ¬ÙÙ‡ÙÙ…","Ù…ÙÙ‘Ù†Ù’","Ø­ÙÙŠÙ’Ø«Ù","Ù„ÙØ§","ÙŠÙØ¹Ù’Ù„ÙÙ…ÙÙˆÙ†Ù"]},
      {n:45, words:["ÙˆÙØ£ÙÙ…Ù’Ù„ÙÙŠ","Ù„ÙÙ‡ÙÙ…Ù’","Ø¥ÙÙ†ÙÙ‘","ÙƒÙÙŠÙ’Ø¯ÙÙŠ","Ù…ÙØªÙÙŠÙ†ÙŒ"]},
      {n:46, words:["Ø£ÙÙ…Ù’","ØªÙØ³Ù’Ø£ÙÙ„ÙÙ‡ÙÙ…Ù’","Ø£ÙØ¬Ù’Ø±Ù‹Ø§","ÙÙÙ‡ÙÙ…","Ù…ÙÙ‘Ù†","Ù…ÙÙ‘ØºÙ’Ø±ÙÙ…Ù","Ù…ÙÙ‘Ø«Ù’Ù‚ÙÙ„ÙÙˆÙ†Ù"]},
      {n:47, words:["Ø£ÙÙ…Ù’","Ø¹ÙÙ†Ø¯ÙÙ‡ÙÙ…Ù","Ø§Ù„Ù’ØºÙÙŠÙ’Ø¨Ù","ÙÙÙ‡ÙÙ…Ù’","ÙŠÙÙƒÙ’ØªÙØ¨ÙÙˆÙ†Ù"]},
      {n:48, words:["ÙÙØ§ØµÙ’Ø¨ÙØ±Ù’","Ù„ÙØ­ÙÙƒÙ’Ù…Ù","Ø±ÙØ¨ÙÙ‘ÙƒÙ","ÙˆÙÙ„ÙØ§","ØªÙÙƒÙÙ†","ÙƒÙØµÙØ§Ø­ÙØ¨Ù","Ø§Ù„Ù’Ø­ÙÙˆØªÙ","Ø¥ÙØ°Ù’","Ù†ÙØ§Ø¯ÙÙ‰Ù°","ÙˆÙÙ‡ÙÙˆÙ","Ù…ÙÙƒÙ’Ø¸ÙÙˆÙ…ÙŒ"]},
      {n:49, words:["Ù„ÙÙ‘ÙˆÙ’Ù„ÙØ§","Ø£ÙÙ†","ØªÙØ¯ÙØ§Ø±ÙÙƒÙÙ‡Ù","Ù†ÙØ¹Ù’Ù…ÙØ©ÙŒ","Ù…ÙÙ‘Ù†","Ø±ÙÙ‘Ø¨ÙÙ‘Ù‡Ù","Ù„ÙÙ†ÙØ¨ÙØ°Ù","Ø¨ÙØ§Ù„Ù’Ø¹ÙØ±ÙØ§Ø¡Ù","ÙˆÙÙ‡ÙÙˆÙ","Ù…ÙØ°Ù’Ù…ÙÙˆÙ…ÙŒ"]},
      {n:50, words:["ÙÙØ§Ø¬Ù’ØªÙØ¨ÙØ§Ù‡Ù","Ø±ÙØ¨ÙÙ‘Ù‡Ù","ÙÙØ¬ÙØ¹ÙÙ„ÙÙ‡Ù","Ù…ÙÙ†Ù","Ø§Ù„ØµÙÙ‘Ø§Ù„ÙØ­ÙÙŠÙ†Ù"]},
      {n:51, words:["ÙˆÙØ¥ÙÙ†","ÙŠÙÙƒÙØ§Ø¯Ù","Ø§Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù","ÙƒÙÙÙØ±ÙÙˆØ§","Ù„ÙÙŠÙØ²Ù’Ù„ÙÙ‚ÙÙˆÙ†ÙÙƒÙ","Ø¨ÙØ£ÙØ¨Ù’ØµÙØ§Ø±ÙÙ‡ÙÙ…Ù’","Ù„ÙÙ…ÙÙ‘Ø§","Ø³ÙÙ…ÙØ¹ÙÙˆØ§","Ø§Ù„Ø°ÙÙ‘ÙƒÙ’Ø±Ù","ÙˆÙÙŠÙÙ‚ÙÙˆÙ„ÙÙˆÙ†Ù","Ø¥ÙÙ†ÙÙ‘Ù‡Ù","Ù„ÙÙ…ÙØ¬Ù’Ù†ÙÙˆÙ†ÙŒ"]},
      {n:52, words:["ÙˆÙÙ…ÙØ§","Ù‡ÙÙˆÙ","Ø¥ÙÙ„ÙÙ‘Ø§","Ø°ÙÙƒÙ’Ø±ÙŒ","Ù„ÙÙ‘Ù„Ù’Ø¹ÙØ§Ù„ÙÙ…ÙÙŠÙ†Ù"]}
    ]
  },
  112: {
    name:"Al-Ikhlas", num:112, bismillah: true,
    ayahs:[
      {n:1, words:["Ù‚ÙÙ„Ù’","Ù‡ÙÙˆÙ","Ø§Ù„Ù„ÙÙ‘Ù‡Ù","Ø£ÙØ­ÙØ¯ÙŒ"]},
      {n:2, words:["Ø§Ù„Ù„ÙÙ‘Ù‡Ù","Ø§Ù„ØµÙÙ‘Ù…ÙØ¯Ù"]},
      {n:3, words:["Ù„ÙÙ…Ù’","ÙŠÙÙ„ÙØ¯Ù’","ÙˆÙÙ„ÙÙ…Ù’","ÙŠÙÙˆÙ„ÙØ¯Ù’"]},
      {n:4, words:["ÙˆÙÙ„ÙÙ…Ù’","ÙŠÙÙƒÙÙ†","Ù„ÙÙ‘Ù‡Ù","ÙƒÙÙÙÙˆÙ‹Ø§","Ø£ÙØ­ÙØ¯ÙŒ"]}
    ]
  },
  113: {
    name:"Al-Falaq", num:113, bismillah: true,
    ayahs:[
      {n:1, words:["Ù‚ÙÙ„Ù’","Ø£ÙØ¹ÙÙˆØ°Ù","Ø¨ÙØ±ÙØ¨ÙÙ‘","Ø§Ù„Ù’ÙÙÙ„ÙÙ‚Ù"]},
      {n:2, words:["Ù…ÙÙ†","Ø´ÙØ±ÙÙ‘","Ù…ÙØ§","Ø®ÙÙ„ÙÙ‚Ù"]},
      {n:3, words:["ÙˆÙÙ…ÙÙ†","Ø´ÙØ±ÙÙ‘","ØºÙØ§Ø³ÙÙ‚Ù","Ø¥ÙØ°ÙØ§","ÙˆÙÙ‚ÙØ¨Ù"]},
      {n:4, words:["ÙˆÙÙ…ÙÙ†","Ø´ÙØ±ÙÙ‘","Ø§Ù„Ù†ÙÙ‘ÙÙÙ‘Ø§Ø«ÙØ§ØªÙ","ÙÙÙŠ","Ø§Ù„Ù’Ø¹ÙÙ‚ÙØ¯Ù"]},
      {n:5, words:["ÙˆÙÙ…ÙÙ†","Ø´ÙØ±ÙÙ‘","Ø­ÙØ§Ø³ÙØ¯Ù","Ø¥ÙØ°ÙØ§","Ø­ÙØ³ÙØ¯Ù"]}
    ]
  },
  114: {
    name:"An-Nas", num:114, bismillah: true,
    ayahs:[
      {n:1, words:["Ù‚ÙÙ„Ù’","Ø£ÙØ¹ÙÙˆØ°Ù","Ø¨ÙØ±ÙØ¨ÙÙ‘","Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù"]},
      {n:2, words:["Ù…ÙÙ„ÙÙƒÙ","Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù"]},
      {n:3, words:["Ø¥ÙÙ„ÙÙ°Ù‡Ù","Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù"]},
      {n:4, words:["Ù…ÙÙ†","Ø´ÙØ±ÙÙ‘","Ø§Ù„Ù’ÙˆÙØ³Ù’ÙˆÙØ§Ø³Ù","Ø§Ù„Ù’Ø®ÙÙ†ÙÙ‘Ø§Ø³Ù"]},
      {n:5, words:["Ø§Ù„ÙÙ‘Ø°ÙÙŠ","ÙŠÙÙˆÙØ³Ù’ÙˆÙØ³Ù","ÙÙÙŠ","ØµÙØ¯ÙÙˆØ±Ù","Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù"]},
      {n:6, words:["Ù…ÙÙ†Ù","Ø§Ù„Ù’Ø¬ÙÙ†ÙÙ‘Ø©Ù","ÙˆÙØ§Ù„Ù†ÙÙ‘Ø§Ø³Ù"]}
    ]
  },
  32: {
    name:"As-Sajdah", num:32, bismillah: true,
    ayahs:[
      {n:1,  words:["Ø§Ù„Ù“Ù…Ù“"]},
      {n:2,  words:["ØªÙÙ†Ø²ÙÙŠÙ„Ù","Ø§Ù„Ù’ÙƒÙØªÙÙ°Ø¨Ù","Ù„ÙØ§","Ø±ÙÙŠÙ’Ø¨Ù","ÙÙÙŠÙ‡Ù","Ù…ÙÙ†","Ø±ÙÙ‘Ø¨ÙÙ‘","Ø§Ù„Ù’Ø¹ÙØ§Ù„ÙÙ…ÙÙŠÙ†Ù"]},
      {n:3,  words:["Ø£ÙÙ…Ù’","ÙŠÙÙ‚ÙÙˆÙ„ÙÙˆÙ†Ù","Ø§ÙÙ’ØªÙØ±ÙÙ‰Ù°Ù‡Ù","Ø¨ÙÙ„Ù’","Ù‡ÙÙˆÙ","Ø§Ù„Ù’Ø­ÙÙ‚ÙÙ‘","Ù…ÙÙ†","Ø±ÙÙ‘Ø¨ÙÙ‘ÙƒÙ","Ù„ÙØªÙÙ†Ø°ÙØ±Ù","Ù‚ÙÙˆÙ’Ù…Ù‹Ø§","Ù…ÙÙ‘Ø§","Ø£ÙØªÙØ§Ù‡ÙÙ…","Ù…ÙÙ‘Ù†","Ù†ÙÙ‘Ø°ÙÙŠØ±Ù","Ù…ÙÙ‘Ù†","Ù‚ÙØ¨Ù’Ù„ÙÙƒÙ","Ù„ÙØ¹ÙÙ„ÙÙ‘Ù‡ÙÙ…Ù’","ÙŠÙÙ‡Ù’ØªÙØ¯ÙÙˆÙ†Ù"]},
      {n:4,  words:["Ø§Ù„Ù„ÙÙ‘Ù‡Ù","Ø§Ù„ÙÙ‘Ø°ÙÙŠ","Ø®ÙÙ„ÙÙ‚Ù","Ø§Ù„Ø³ÙÙ‘Ù…ÙØ§ÙˆÙØ§ØªÙ","ÙˆÙØ§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù","ÙˆÙÙ…ÙØ§","Ø¨ÙÙŠÙ’Ù†ÙÙ‡ÙÙ…ÙØ§","ÙÙÙŠ","Ø³ÙØªÙÙ‘Ø©Ù","Ø£ÙÙŠÙÙ‘Ø§Ù…Ù","Ø«ÙÙ…ÙÙ‘","Ø§Ø³Ù’ØªÙÙˆÙÙ‰Ù°","Ø¹ÙÙ„ÙÙ‰","Ø§Ù„Ù’Ø¹ÙØ±Ù’Ø´Ù","Ù…ÙØ§","Ù„ÙÙƒÙÙ…","Ù…ÙÙ‘Ù†","Ø¯ÙÙˆÙ†ÙÙ‡Ù","Ù…ÙÙ†","ÙˆÙÙ„ÙÙŠÙÙ‘","ÙˆÙÙ„ÙØ§","Ø´ÙÙÙÙŠØ¹Ù","Ø£ÙÙÙÙ„ÙØ§","ØªÙØªÙØ°ÙÙƒÙÙ‘Ø±ÙÙˆÙ†Ù"]},
      {n:5,  words:["ÙŠÙØ¯ÙØ¨ÙÙ‘Ø±Ù","Ø§Ù„Ù’Ø£ÙÙ…Ù’Ø±Ù","Ù…ÙÙ†Ù","Ø§Ù„Ø³ÙÙ‘Ù…ÙØ§Ø¡Ù","Ø¥ÙÙ„ÙÙ‰","Ø§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù","Ø«ÙÙ…ÙÙ‘","ÙŠÙØ¹Ù’Ø±ÙØ¬Ù","Ø¥ÙÙ„ÙÙŠÙ’Ù‡Ù","ÙÙÙŠ","ÙŠÙÙˆÙ’Ù…Ù","ÙƒÙØ§Ù†Ù","Ù…ÙÙ‚Ù’Ø¯ÙØ§Ø±ÙÙ‡Ù","Ø£ÙÙ„Ù’ÙÙ","Ø³ÙÙ†ÙØ©Ù","Ù…ÙÙ‘Ù…ÙÙ‘Ø§","ØªÙØ¹ÙØ¯ÙÙ‘ÙˆÙ†Ù"]},
      {n:6,  words:["Ø°ÙÙ°Ù„ÙÙƒÙ","Ø¹ÙØ§Ù„ÙÙ…Ù","Ø§Ù„Ù’ØºÙÙŠÙ’Ø¨Ù","ÙˆÙØ§Ù„Ø´ÙÙ‘Ù‡ÙØ§Ø¯ÙØ©Ù","Ø§Ù„Ù’Ø¹ÙØ²ÙÙŠØ²Ù","Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù"]},
      {n:7,  words:["Ø§Ù„ÙÙ‘Ø°ÙÙŠ","Ø£ÙØ­Ù’Ø³ÙÙ†Ù","ÙƒÙÙ„ÙÙ‘","Ø´ÙÙŠÙ’Ø¡Ù","Ø®ÙÙ„ÙÙ‚ÙÙ‡Ù","ÙˆÙØ¨ÙØ¯ÙØ£Ù","Ø®ÙÙ„Ù’Ù‚Ù","Ø§Ù„Ù’Ø¥ÙÙ†Ø³ÙØ§Ù†Ù","Ù…ÙÙ†","Ø·ÙÙŠÙ†Ù"]},
      {n:8,  words:["Ø«ÙÙ…ÙÙ‘","Ø¬ÙØ¹ÙÙ„Ù","Ù†ÙØ³Ù’Ù„ÙÙ‡Ù","Ù…ÙÙ†","Ø³ÙÙ„ÙØ§Ù„ÙØ©Ù","Ù…ÙÙ‘Ù†","Ù…ÙÙ‘Ø§Ø¡Ù","Ù…ÙÙ‘Ù‡ÙÙŠÙ†Ù"]},
      {n:9,  words:["Ø«ÙÙ…ÙÙ‘","Ø³ÙÙˆÙÙ‘Ø§Ù‡Ù","ÙˆÙÙ†ÙÙÙØ®Ù","ÙÙÙŠÙ‡Ù","Ù…ÙÙ†","Ø±ÙÙ‘ÙˆØ­ÙÙ‡Ù","ÙˆÙØ¬ÙØ¹ÙÙ„Ù","Ù„ÙÙƒÙÙ…Ù","Ø§Ù„Ø³ÙÙ‘Ù…Ù’Ø¹Ù","ÙˆÙØ§Ù„Ù’Ø£ÙØ¨Ù’ØµÙØ§Ø±Ù","ÙˆÙØ§Ù„Ù’Ø£ÙÙÙ’Ø¦ÙØ¯ÙØ©Ù","Ù‚ÙÙ„ÙÙŠÙ„Ù‹Ø§","Ù…ÙÙ‘Ø§","ØªÙØ´Ù’ÙƒÙØ±ÙÙˆÙ†Ù"]},
      {n:10, words:["ÙˆÙÙ‚ÙØ§Ù„ÙÙˆØ§","Ø£ÙØ¥ÙØ°ÙØ§","Ø¶ÙÙ„ÙÙ„Ù’Ù†ÙØ§","ÙÙÙŠ","Ø§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù","Ø£ÙØ¥ÙÙ†ÙÙ‘Ø§","Ù„ÙÙÙÙŠ","Ø®ÙÙ„Ù’Ù‚Ù","Ø¬ÙØ¯ÙÙŠØ¯Ù","Ø¨ÙÙ„Ù’","Ù‡ÙÙ…","Ø¨ÙÙ„ÙÙ‚ÙØ§Ø¡Ù","Ø±ÙØ¨ÙÙ‘Ù‡ÙÙ…Ù’","ÙƒÙØ§ÙÙØ±ÙÙˆÙ†Ù"]},
      {n:11, words:["Ù‚ÙÙ„Ù’","ÙŠÙØªÙÙˆÙÙÙÙ‘Ø§ÙƒÙÙ…","Ù…ÙÙ‘Ù„ÙÙƒÙ","Ø§Ù„Ù’Ù…ÙÙˆÙ’ØªÙ","Ø§Ù„ÙÙ‘Ø°ÙÙŠ","ÙˆÙÙƒÙÙ‘Ù„Ù","Ø¨ÙÙƒÙÙ…Ù’","Ø«ÙÙ…ÙÙ‘","Ø¥ÙÙ„ÙÙ‰Ù°","Ø±ÙØ¨ÙÙ‘ÙƒÙÙ…Ù’","ØªÙØ±Ù’Ø¬ÙØ¹ÙÙˆÙ†Ù"]},
      {n:12, words:["ÙˆÙÙ„ÙÙˆÙ’","ØªÙØ±ÙÙ‰Ù°","Ø¥ÙØ°Ù","Ø§Ù„Ù’Ù…ÙØ¬Ù’Ø±ÙÙ…ÙÙˆÙ†Ù","Ù†ÙØ§ÙƒÙØ³ÙÙˆ","Ø±ÙØ¡ÙÙˆØ³ÙÙ‡ÙÙ…Ù’","Ø¹ÙÙ†Ø¯Ù","Ø±ÙØ¨ÙÙ‘Ù‡ÙÙ…Ù’","Ø±ÙØ¨ÙÙ‘Ù†ÙØ§","Ø£ÙØ¨Ù’ØµÙØ±Ù’Ù†ÙØ§","ÙˆÙØ³ÙÙ…ÙØ¹Ù’Ù†ÙØ§","ÙÙØ§Ø±Ù’Ø¬ÙØ¹Ù’Ù†ÙØ§","Ù†ÙØ¹Ù’Ù…ÙÙ„Ù’","ØµÙØ§Ù„ÙØ­Ù‹Ø§","Ø¥ÙÙ†ÙÙ‘Ø§","Ù…ÙÙˆÙ‚ÙÙ†ÙÙˆÙ†Ù"]},
      {n:13, words:["ÙˆÙÙ„ÙÙˆÙ’","Ø´ÙØ¦Ù’Ù†ÙØ§","Ù„ÙØ¢ØªÙÙŠÙ’Ù†ÙØ§","ÙƒÙÙ„ÙÙ‘","Ù†ÙÙÙ’Ø³Ù","Ù‡ÙØ¯ÙØ§Ù‡ÙØ§","ÙˆÙÙ„ÙÙ°ÙƒÙÙ†Ù’","Ø­ÙÙ‚ÙÙ‘","Ø§Ù„Ù’Ù‚ÙÙˆÙ’Ù„Ù","Ù…ÙÙ†ÙÙ‘ÙŠ","Ù„ÙØ£ÙÙ…Ù’Ù„ÙØ£ÙÙ†ÙÙ‘","Ø¬ÙÙ‡ÙÙ†ÙÙ‘Ù…Ù","Ù…ÙÙ†Ù","Ø§Ù„Ù’Ø¬ÙÙ†ÙÙ‘Ø©Ù","ÙˆÙØ§Ù„Ù†ÙÙ‘Ø§Ø³Ù","Ø£ÙØ¬Ù’Ù…ÙØ¹ÙÙŠÙ†Ù"]},
      {n:14, words:["ÙÙØ°ÙÙˆÙ‚ÙÙˆØ§","Ø¨ÙÙ…ÙØ§","Ù†ÙØ³ÙÙŠØªÙÙ…Ù’","Ù„ÙÙ‚ÙØ§Ø¡Ù","ÙŠÙÙˆÙ’Ù…ÙÙƒÙÙ…Ù’","Ù‡ÙÙ°Ø°ÙØ§","Ø¥ÙÙ†ÙÙ‘Ø§","Ù†ÙØ³ÙÙŠÙ†ÙØ§ÙƒÙÙ…Ù’","ÙˆÙØ°ÙÙˆÙ‚ÙÙˆØ§","Ø¹ÙØ°ÙØ§Ø¨Ù","Ø§Ù„Ù’Ø®ÙÙ„Ù’Ø¯Ù","Ø¨ÙÙ…ÙØ§","ÙƒÙÙ†ØªÙÙ…Ù’","ØªÙØ¹Ù’Ù…ÙÙ„ÙÙˆÙ†Ù"]},
      {n:15, words:["Ø¥ÙÙ†ÙÙ‘Ù…ÙØ§","ÙŠÙØ¤Ù’Ù…ÙÙ†Ù","Ø¨ÙØ¢ÙŠÙØ§ØªÙÙ†ÙØ§","Ø§Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù","Ø¥ÙØ°ÙØ§","Ø°ÙÙƒÙÙ‘Ø±ÙÙˆØ§","Ø¨ÙÙ‡ÙØ§","Ø®ÙØ±ÙÙ‘ÙˆØ§","Ø³ÙØ¬ÙÙ‘Ø¯Ù‹Ø§","ÙˆÙØ³ÙØ¨ÙÙ‘Ø­ÙÙˆØ§","Ø¨ÙØ­ÙÙ…Ù’Ø¯Ù","Ø±ÙØ¨ÙÙ‘Ù‡ÙÙ…Ù’","ÙˆÙÙ‡ÙÙ…Ù’","Ù„ÙØ§","ÙŠÙØ³Ù’ØªÙÙƒÙ’Ø¨ÙØ±ÙÙˆÙ†Ù"]},
      {n:16, words:["ØªÙØªÙØ¬ÙØ§ÙÙÙ‰Ù°","Ø¬ÙÙ†ÙÙˆØ¨ÙÙ‡ÙÙ…Ù’","Ø¹ÙÙ†Ù","Ø§Ù„Ù’Ù…ÙØ¶ÙØ§Ø¬ÙØ¹Ù","ÙŠÙØ¯Ù’Ø¹ÙÙˆÙ†Ù","Ø±ÙØ¨ÙÙ‘Ù‡ÙÙ…Ù’","Ø®ÙÙˆÙ’ÙÙ‹Ø§","ÙˆÙØ·ÙÙ…ÙØ¹Ù‹Ø§","ÙˆÙÙ…ÙÙ…ÙÙ‘Ø§","Ø±ÙØ²ÙÙ‚Ù’Ù†ÙØ§Ù‡ÙÙ…Ù’","ÙŠÙÙ†ÙÙÙ‚ÙÙˆÙ†Ù"]},
      {n:17, words:["ÙÙÙ„ÙØ§","ØªÙØ¹Ù’Ù„ÙÙ…Ù","Ù†ÙÙÙ’Ø³ÙŒ","Ù…ÙÙ‘Ø§","Ø£ÙØ®Ù’ÙÙÙŠÙ","Ù„ÙÙ‡ÙÙ…","Ù…ÙÙ‘Ù†","Ù‚ÙØ±ÙÙ‘Ø©Ù","Ø£ÙØ¹Ù’ÙŠÙÙ†Ù","Ø¬ÙØ²ÙØ§Ø¡Ù‹","Ø¨ÙÙ…ÙØ§","ÙƒÙØ§Ù†ÙÙˆØ§","ÙŠÙØ¹Ù’Ù…ÙÙ„ÙÙˆÙ†Ù"]},
      {n:18, words:["Ø£ÙÙÙÙ…ÙÙ†","ÙƒÙØ§Ù†Ù","Ù…ÙØ¤Ù’Ù…ÙÙ†Ù‹Ø§","ÙƒÙÙ…ÙÙ†","ÙƒÙØ§Ù†Ù","ÙÙØ§Ø³ÙÙ‚Ù‹Ø§","Ù„ÙÙ‘Ø§","ÙŠÙØ³Ù’ØªÙÙˆÙÙˆÙ†Ù"]},
      {n:19, words:["Ø£ÙÙ…ÙÙ‘Ø§","Ø§Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù","Ø¢Ù…ÙÙ†ÙÙˆØ§","ÙˆÙØ¹ÙÙ…ÙÙ„ÙÙˆØ§","Ø§Ù„ØµÙÙ‘Ø§Ù„ÙØ­ÙÙ°ØªÙ","ÙÙÙ„ÙÙ‡ÙÙ…Ù’","Ø¬ÙÙ†ÙÙ‘Ø§ØªÙ","Ø§Ù„Ù’Ù…ÙØ£Ù’ÙˆÙÙ‰Ù°","Ù†ÙØ²ÙÙ„Ù‹Ø§","Ø¨ÙÙ…ÙØ§","ÙƒÙØ§Ù†ÙÙˆØ§","ÙŠÙØ¹Ù’Ù…ÙÙ„ÙÙˆÙ†Ù"]},
      {n:20, words:["ÙˆÙØ£ÙÙ…ÙÙ‘Ø§","Ø§Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù","ÙÙØ³ÙÙ‚ÙÙˆØ§","ÙÙÙ…ÙØ£Ù’ÙˆÙØ§Ù‡ÙÙ…Ù","Ø§Ù„Ù†ÙÙ‘Ø§Ø±Ù","ÙƒÙÙ„ÙÙ‘Ù…ÙØ§","Ø£ÙØ±ÙØ§Ø¯ÙÙˆØ§","Ø£ÙÙ†","ÙŠÙØ®Ù’Ø±ÙØ¬ÙÙˆØ§","Ù…ÙÙ†Ù’Ù‡ÙØ§","Ø£ÙØ¹ÙÙŠØ¯ÙÙˆØ§","ÙÙÙŠÙ‡ÙØ§","ÙˆÙÙ‚ÙÙŠÙ„Ù","Ù„ÙÙ‡ÙÙ…Ù’","Ø°ÙÙˆÙ‚ÙÙˆØ§","Ø¹ÙØ°ÙØ§Ø¨Ù","Ø§Ù„Ù†ÙÙ‘Ø§Ø±Ù","Ø§Ù„ÙÙ‘Ø°ÙÙŠ","ÙƒÙÙ†ØªÙÙ…","Ø¨ÙÙ‡Ù","ØªÙÙƒÙØ°ÙÙ‘Ø¨ÙÙˆÙ†Ù"]},
      {n:21, words:["ÙˆÙÙ„ÙÙ†ÙØ°ÙÙŠÙ‚ÙÙ†ÙÙ‘Ù‡ÙÙ…","Ù…ÙÙ‘Ù†Ù","Ø§Ù„Ù’Ø¹ÙØ°ÙØ§Ø¨Ù","Ø§Ù„Ù’Ø£ÙØ¯Ù’Ù†ÙÙ‰Ù°","Ø¯ÙÙˆÙ†Ù","Ø§Ù„Ù’Ø¹ÙØ°ÙØ§Ø¨Ù","Ø§Ù„Ù’Ø£ÙÙƒÙ’Ø¨ÙØ±Ù","Ù„ÙØ¹ÙÙ„ÙÙ‘Ù‡ÙÙ…Ù’","ÙŠÙØ±Ù’Ø¬ÙØ¹ÙÙˆÙ†Ù"]},
      {n:22, words:["ÙˆÙÙ…ÙÙ†Ù’","Ø£ÙØ¸Ù’Ù„ÙÙ…Ù","Ù…ÙÙ…ÙÙ‘Ù†","Ø°ÙÙƒÙÙ‘Ø±Ù","Ø¨ÙØ¢ÙŠÙØ§ØªÙ","Ø±ÙØ¨ÙÙ‘Ù‡Ù","Ø«ÙÙ…ÙÙ‘","Ø£ÙØ¹Ù’Ø±ÙØ¶Ù","Ø¹ÙÙ†Ù’Ù‡ÙØ§","Ø¥ÙÙ†ÙÙ‘Ø§","Ù…ÙÙ†Ù","Ø§Ù„Ù’Ù…ÙØ¬Ù’Ø±ÙÙ…ÙÙŠÙ†Ù","Ù…ÙÙ†ØªÙÙ‚ÙÙ…ÙÙˆÙ†Ù"]},
      {n:23, words:["ÙˆÙÙ„ÙÙ‚ÙØ¯Ù’","Ø¢ØªÙÙŠÙ’Ù†ÙØ§","Ù…ÙÙˆØ³ÙÙ‰","Ø§Ù„Ù’ÙƒÙØªÙÙ°Ø¨Ù","ÙÙÙ„ÙØ§","ØªÙÙƒÙÙ†","ÙÙÙŠ","Ù…ÙØ±Ù’ÙŠÙØ©Ù","Ù…ÙÙ‘Ù†","Ù„ÙÙ‘Ù‚ÙØ§Ø¦ÙÙ‡Ù","ÙˆÙØ¬ÙØ¹ÙÙ„Ù’Ù†ÙØ§Ù‡Ù","Ù‡ÙØ¯Ù‹Ù‰","Ù„ÙÙ‘Ø¨ÙÙ†ÙÙŠ","Ø¥ÙØ³Ù’Ø±ÙØ§Ø¦ÙÙŠÙ„Ù"]},
      {n:24, words:["ÙˆÙØ¬ÙØ¹ÙÙ„Ù’Ù†ÙØ§","Ù…ÙÙ†Ù’Ù‡ÙÙ…Ù’","Ø£ÙØ¦ÙÙ…ÙÙ‘Ø©Ù‹","ÙŠÙÙ‡Ù’Ø¯ÙÙˆÙ†Ù","Ø¨ÙØ£ÙÙ…Ù’Ø±ÙÙ†ÙØ§","Ù„ÙÙ…ÙÙ‘Ø§","ØµÙØ¨ÙØ±ÙÙˆØ§","ÙˆÙÙƒÙØ§Ù†ÙÙˆØ§","Ø¨ÙØ¢ÙŠÙØ§ØªÙÙ†ÙØ§","ÙŠÙÙˆÙ‚ÙÙ†ÙÙˆÙ†Ù"]},
      {n:25, words:["Ø¥ÙÙ†ÙÙ‘","Ø±ÙØ¨ÙÙ‘ÙƒÙ","Ù‡ÙÙˆÙ","ÙŠÙÙÙ’ØµÙÙ„Ù","Ø¨ÙÙŠÙ’Ù†ÙÙ‡ÙÙ…Ù’","ÙŠÙÙˆÙ’Ù…Ù","Ø§Ù„Ù’Ù‚ÙÙŠÙØ§Ù…ÙØ©Ù","ÙÙÙŠÙ…ÙØ§","ÙƒÙØ§Ù†ÙÙˆØ§","ÙÙÙŠÙ‡Ù","ÙŠÙØ®Ù’ØªÙÙ„ÙÙÙÙˆÙ†Ù"]},
      {n:26, words:["Ø£ÙÙˆÙÙ„ÙÙ…Ù’","ÙŠÙÙ‡Ù’Ø¯Ù","Ù„ÙÙ‡ÙÙ…Ù’","ÙƒÙÙ…Ù’","Ø£ÙÙ‡Ù’Ù„ÙÙƒÙ’Ù†ÙØ§","Ù…ÙÙ†","Ù‚ÙØ¨Ù’Ù„ÙÙ‡ÙÙ…","Ù…ÙÙ‘Ù†Ù","Ø§Ù„Ù’Ù‚ÙØ±ÙÙˆÙ†Ù","ÙŠÙÙ…Ù’Ø´ÙÙˆÙ†Ù","ÙÙÙŠ","Ù…ÙØ³ÙØ§ÙƒÙÙ†ÙÙ‡ÙÙ…Ù’","Ø¥ÙÙ†ÙÙ‘","ÙÙÙŠ","Ø°ÙÙ°Ù„ÙÙƒÙ","Ù„ÙØ¢ÙŠÙØ§ØªÙ","Ø£ÙÙÙÙ„ÙØ§","ÙŠÙØ³Ù’Ù…ÙØ¹ÙÙˆÙ†Ù"]},
      {n:27, words:["Ø£ÙÙˆÙÙ„ÙÙ…Ù’","ÙŠÙØ±ÙÙˆÙ’Ø§","Ø£ÙÙ†ÙÙ‘Ø§","Ù†ÙØ³ÙÙˆÙ‚Ù","Ø§Ù„Ù’Ù…ÙØ§Ø¡Ù","Ø¥ÙÙ„ÙÙ‰","Ø§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù","Ø§Ù„Ù’Ø¬ÙØ±ÙØ²Ù","ÙÙÙ†ÙØ®Ù’Ø±ÙØ¬Ù","Ø¨ÙÙ‡Ù","Ø²ÙØ±Ù’Ø¹Ù‹Ø§","ØªÙØ£Ù’ÙƒÙÙ„Ù","Ù…ÙÙ†Ù’Ù‡Ù","Ø£ÙÙ†Ù’Ø¹ÙØ§Ù…ÙÙ‡ÙÙ…Ù’","ÙˆÙØ£ÙÙ†ÙÙØ³ÙÙ‡ÙÙ…Ù’","Ø£ÙÙÙÙ„ÙØ§","ÙŠÙØ¨Ù’ØµÙØ±ÙÙˆÙ†Ù"]},
      {n:28, words:["ÙˆÙÙŠÙÙ‚ÙÙˆÙ„ÙÙˆÙ†Ù","Ù…ÙØªÙÙ‰Ù°","Ù‡ÙÙ°Ø°ÙØ§","Ø§Ù„Ù’ÙÙØªÙ’Ø­Ù","Ø¥ÙÙ†","ÙƒÙÙ†ØªÙÙ…Ù’","ØµÙØ§Ø¯ÙÙ‚ÙÙŠÙ†Ù"]},
      {n:29, words:["Ù‚ÙÙ„Ù’","ÙŠÙÙˆÙ’Ù…Ù","Ø§Ù„Ù’ÙÙØªÙ’Ø­Ù","Ù„ÙØ§","ÙŠÙÙ†ÙÙØ¹Ù","Ø§Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù","ÙƒÙÙÙØ±ÙÙˆØ§","Ø¥ÙÙŠÙ…ÙØ§Ù†ÙÙ‡ÙÙ…Ù’","ÙˆÙÙ„ÙØ§","Ù‡ÙÙ…Ù’","ÙŠÙÙ†Ø¸ÙØ±ÙÙˆÙ†Ù"]},
      {n:30, words:["ÙÙØ£ÙØ¹Ù’Ø±ÙØ¶Ù’","Ø¹ÙÙ†Ù’Ù‡ÙÙ…Ù’","ÙˆÙØ§Ù†ØªÙØ¸ÙØ±Ù’","Ø¥ÙÙ†ÙÙ‘Ù‡ÙÙ…","Ù…ÙÙ‘Ù†ØªÙØ¸ÙØ±ÙÙˆÙ†Ù"]}
    ]
  },
  69: {
    name:"Al-Haqqah", num:69, bismillah: true,
    ayahs:[
      {n:1,  words:["Ø§Ù„Ù’Ø­ÙØ§Ù‚ÙÙ‘Ø©Ù"]},
      {n:2,  words:["Ù…ÙØ§","Ø§Ù„Ù’Ø­ÙØ§Ù‚ÙÙ‘Ø©Ù"]},
      {n:3,  words:["ÙˆÙÙ…ÙØ§","Ø£ÙØ¯Ù’Ø±ÙØ§ÙƒÙ","Ù…ÙØ§","Ø§Ù„Ù’Ø­ÙØ§Ù‚ÙÙ‘Ø©Ù"]},
      {n:4,  words:["ÙƒÙØ°ÙÙ‘Ø¨ÙØªÙ’","Ø«ÙÙ…ÙÙˆØ¯Ù","ÙˆÙØ¹ÙØ§Ø¯ÙŒ","Ø¨ÙØ§Ù„Ù’Ù‚ÙØ§Ø±ÙØ¹ÙØ©Ù"]},
      {n:5,  words:["ÙÙØ£ÙÙ…ÙÙ‘Ø§","Ø«ÙÙ…ÙÙˆØ¯Ù","ÙÙØ£ÙÙ‡Ù’Ù„ÙÙƒÙÙˆØ§","Ø¨ÙØ§Ù„Ø·ÙÙ‘Ø§ØºÙÙŠÙØ©Ù"]},
      {n:6,  words:["ÙˆÙØ£ÙÙ…ÙÙ‘Ø§","Ø¹ÙØ§Ø¯ÙŒ","ÙÙØ£ÙÙ‡Ù’Ù„ÙÙƒÙÙˆØ§","Ø¨ÙØ±ÙÙŠØ­Ù","ØµÙØ±Ù’ØµÙØ±Ù","Ø¹ÙØ§ØªÙÙŠÙØ©Ù"]},
      {n:7,  words:["Ø³ÙØ®ÙÙ‘Ø±ÙÙ‡ÙØ§","Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’","Ø³ÙØ¨Ù’Ø¹Ù","Ù„ÙÙŠÙØ§Ù„Ù","ÙˆÙØ«ÙÙ…ÙØ§Ù†ÙÙŠÙØ©Ù","Ø£ÙÙŠÙÙ‘Ø§Ù…Ù","Ø­ÙØ³ÙÙˆÙ…Ù‹Ø§","ÙÙØªÙØ±ÙÙ‰","Ø§Ù„Ù’Ù‚ÙÙˆÙ’Ù…Ù","ÙÙÙŠÙ‡ÙØ§","ØµÙØ±Ù’Ø¹ÙÙ‰Ù°","ÙƒÙØ£ÙÙ†ÙÙ‘Ù‡ÙÙ…Ù’","Ø£ÙØ¹Ù’Ø¬ÙØ§Ø²Ù","Ù†ÙØ®Ù’Ù„Ù","Ø®ÙØ§ÙˆÙÙŠÙØ©Ù"]},
      {n:8,  words:["ÙÙÙ‡ÙÙ„Ù’","ØªÙØ±ÙÙ‰Ù°","Ù„ÙÙ‡ÙÙ…","Ù…ÙÙ‘Ù†","Ø¨ÙØ§Ù‚ÙÙŠÙØ©Ù"]},
      {n:9,  words:["ÙˆÙØ¬ÙØ§Ø¡Ù","ÙÙØ±Ù’Ø¹ÙÙˆÙ’Ù†Ù","ÙˆÙÙ…ÙÙ†","Ù‚ÙØ¨Ù’Ù„ÙÙ‡Ù","ÙˆÙØ§Ù„Ù’Ù…ÙØ¤Ù’ØªÙÙÙÙƒÙØ§ØªÙ","Ø¨ÙØ§Ù„Ù’Ø®ÙØ§Ø·ÙØ¦ÙØ©Ù"]},
      {n:10, words:["ÙÙØ¹ÙØµÙÙˆÙ’Ø§","Ø±ÙØ³ÙÙˆÙ„Ù","Ø±ÙØ¨ÙÙ‘Ù‡ÙÙ…Ù’","ÙÙØ£ÙØ®ÙØ°ÙÙ‡ÙÙ…Ù’","Ø£ÙØ®Ù’Ø°ÙØ©Ù‹","Ø±ÙÙ‘Ø§Ø¨ÙÙŠÙØ©Ù‹"]},
      {n:11, words:["Ø¥ÙÙ†ÙÙ‘Ø§","Ù„ÙÙ…ÙÙ‘Ø§","Ø·ÙØºÙØ§","Ø§Ù„Ù’Ù…ÙØ§Ø¡Ù","Ø­ÙÙ…ÙÙ„Ù’Ù†ÙØ§ÙƒÙÙ…Ù’","ÙÙÙŠ","Ø§Ù„Ù’Ø¬ÙØ§Ø±ÙÙŠÙØ©Ù"]},
      {n:12, words:["Ù„ÙÙ†ÙØ¬Ù’Ø¹ÙÙ„ÙÙ‡ÙØ§","Ù„ÙÙƒÙÙ…Ù’","ØªÙØ°Ù’ÙƒÙØ±ÙØ©Ù‹","ÙˆÙØªÙØ¹ÙÙŠÙÙ‡ÙØ§","Ø£ÙØ°ÙÙ†ÙŒ","ÙˆÙØ§Ø¹ÙÙŠÙØ©ÙŒ"]},
      {n:13, words:["ÙÙØ¥ÙØ°ÙØ§","Ù†ÙÙÙØ®Ù","ÙÙÙŠ","Ø§Ù„ØµÙÙ‘ÙˆØ±Ù","Ù†ÙÙÙ’Ø®ÙØ©ÙŒ","ÙˆÙØ§Ø­ÙØ¯ÙØ©ÙŒ"]},
      {n:14, words:["ÙˆÙØ­ÙÙ…ÙÙ„ÙØªÙ","Ø§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù","ÙˆÙØ§Ù„Ù’Ø¬ÙØ¨ÙØ§Ù„Ù","ÙÙØ¯ÙÙƒÙÙ‘ØªÙØ§","Ø¯ÙÙƒÙÙ‘Ø©Ù‹","ÙˆÙØ§Ø­ÙØ¯ÙØ©Ù‹"]},
      {n:15, words:["ÙÙÙŠÙÙˆÙ’Ù…ÙØ¦ÙØ°Ù","ÙˆÙÙ‚ÙØ¹ÙØªÙ","Ø§Ù„Ù’ÙˆÙØ§Ù‚ÙØ¹ÙØ©Ù"]},
      {n:16, words:["ÙˆÙØ§Ù†Ø´ÙÙ‚ÙÙ‘ØªÙ","Ø§Ù„Ø³ÙÙ‘Ù…ÙØ§Ø¡Ù","ÙÙÙ‡ÙÙŠÙ","ÙŠÙÙˆÙ’Ù…ÙØ¦ÙØ°Ù","ÙˆÙØ§Ù‡ÙÙŠÙØ©ÙŒ"]},
      {n:17, words:["ÙˆÙØ§Ù„Ù’Ù…ÙÙ„ÙÙƒÙ","Ø¹ÙÙ„ÙÙ‰Ù°","Ø£ÙØ±Ù’Ø¬ÙØ§Ø¦ÙÙ‡ÙØ§","ÙˆÙÙŠÙØ­Ù’Ù…ÙÙ„Ù","Ø¹ÙØ±Ù’Ø´Ù","Ø±ÙØ¨ÙÙ‘ÙƒÙ","ÙÙÙˆÙ’Ù‚ÙÙ‡ÙÙ…Ù’","ÙŠÙÙˆÙ’Ù…ÙØ¦ÙØ°Ù","Ø«ÙÙ…ÙØ§Ù†ÙÙŠÙØ©ÙŒ"]},
      {n:18, words:["ÙŠÙÙˆÙ’Ù…ÙØ¦ÙØ°Ù","ØªÙØ¹Ù’Ø±ÙØ¶ÙÙˆÙ†Ù","Ù„ÙØ§","ØªÙØ®Ù’ÙÙÙ‰Ù°","Ù…ÙÙ†ÙƒÙÙ…Ù’","Ø®ÙØ§ÙÙÙŠÙØ©ÙŒ"]},
      {n:19, words:["ÙÙØ£ÙÙ…ÙÙ‘Ø§","Ù…ÙÙ†Ù’","Ø£ÙÙˆØªÙÙŠÙ","ÙƒÙØªÙØ§Ø¨ÙÙ‡Ù","Ø¨ÙÙŠÙÙ…ÙÙŠÙ†ÙÙ‡Ù","ÙÙÙŠÙÙ‚ÙÙˆÙ„Ù","Ù‡ÙØ§Ø¤ÙÙ…Ù","Ø§Ù‚Ù’Ø±ÙØ¡ÙÙˆØ§","ÙƒÙØªÙÙ°Ø¨ÙÙŠÙÙ‡Ù’"]},
      {n:20, words:["Ø¥ÙÙ†ÙÙ‘ÙŠ","Ø¸ÙÙ†ÙÙ†ØªÙ","Ø£ÙÙ†ÙÙ‘ÙŠ","Ù…ÙÙ„ÙØ§Ù‚Ù","Ø­ÙØ³ÙÙ°Ø¨ÙÙŠÙÙ‡Ù’"]},
      {n:21, words:["ÙÙÙ‡ÙÙˆÙ","ÙÙÙŠ","Ø¹ÙÙŠØ´ÙØ©Ù","Ø±ÙÙ‘Ø§Ø¶ÙÙŠÙØ©Ù"]},
      {n:22, words:["ÙÙÙŠ","Ø¬ÙÙ†ÙÙ‘Ø©Ù","Ø¹ÙØ§Ù„ÙÙŠÙØ©Ù"]},
      {n:23, words:["Ù‚ÙØ·ÙÙˆÙÙÙ‡ÙØ§","Ø¯ÙØ§Ù†ÙÙŠÙØ©ÙŒ"]},
      {n:24, words:["ÙƒÙÙ„ÙÙˆØ§","ÙˆÙØ§Ø´Ù’Ø±ÙØ¨ÙÙˆØ§","Ù‡ÙÙ†ÙÙŠØ¦Ù‹Ø§","Ø¨ÙÙ…ÙØ§","Ø£ÙØ³Ù’Ù„ÙÙÙ’ØªÙÙ…Ù’","ÙÙÙŠ","Ø§Ù„Ù’Ø£ÙÙŠÙÙ‘Ø§Ù…Ù","Ø§Ù„Ù’Ø®ÙØ§Ù„ÙÙŠÙØ©Ù"]},
      {n:25, words:["ÙˆÙØ£ÙÙ…ÙÙ‘Ø§","Ù…ÙÙ†Ù’","Ø£ÙÙˆØªÙÙŠÙ","ÙƒÙØªÙØ§Ø¨ÙÙ‡Ù","Ø¨ÙØ´ÙÙ…ÙØ§Ù„ÙÙ‡Ù","ÙÙÙŠÙÙ‚ÙÙˆÙ„Ù","ÙŠÙØ§","Ù„ÙÙŠÙ’ØªÙÙ†ÙÙŠ","Ù„ÙÙ…Ù’","Ø£ÙÙˆØªÙ","ÙƒÙØªÙÙ°Ø¨ÙÙŠÙÙ‡Ù’"]},
      {n:26, words:["ÙˆÙÙ„ÙÙ…Ù’","Ø£ÙØ¯Ù’Ø±Ù","Ù…ÙØ§","Ø­ÙØ³ÙÙ°Ø¨ÙÙŠÙÙ‡Ù’"]},
      {n:27, words:["ÙŠÙØ§","Ù„ÙÙŠÙ’ØªÙÙ‡ÙØ§","ÙƒÙØ§Ù†ÙØªÙ","Ø§Ù„Ù’Ù‚ÙØ§Ø¶ÙÙŠÙØ©Ù"]},
      {n:28, words:["Ù…ÙØ§","Ø£ÙØºÙ’Ù†ÙÙ‰Ù°","Ø¹ÙÙ†ÙÙ‘ÙŠ","Ù…ÙØ§Ù„ÙÙŠÙÙ‡Ù’"]},
      {n:29, words:["Ù‡ÙÙ„ÙÙƒÙ","Ø¹ÙÙ†ÙÙ‘ÙŠ","Ø³ÙÙ„Ù’Ø·ÙÙ°Ù†ÙÙŠÙÙ‡Ù’"]},
      {n:30, words:["Ø®ÙØ°ÙÙˆÙ‡Ù","ÙÙØºÙÙ„ÙÙ‘ÙˆÙ‡Ù"]},
      {n:31, words:["Ø«ÙÙ…ÙÙ‘","Ø§Ù„Ù’Ø¬ÙØ­ÙÙŠÙ…Ù","ØµÙÙ„ÙÙ‘ÙˆÙ‡Ù"]},
      {n:32, words:["Ø«ÙÙ…ÙÙ‘","ÙÙÙŠ","Ø³ÙÙ„Ù’Ø³ÙÙ„ÙØ©Ù","Ø°ÙØ±Ù’Ø¹ÙÙ‡ÙØ§","Ø³ÙØ¨Ù’Ø¹ÙÙˆÙ†Ù","Ø°ÙØ±ÙØ§Ø¹Ù‹Ø§","ÙÙØ§Ø³Ù’Ù„ÙÙƒÙÙˆÙ‡Ù"]},
      {n:33, words:["Ø¥ÙÙ†ÙÙ‘Ù‡Ù","ÙƒÙØ§Ù†Ù","Ù„ÙØ§","ÙŠÙØ¤Ù’Ù…ÙÙ†Ù","Ø¨ÙØ§Ù„Ù„ÙÙ‘Ù‡Ù","Ø§Ù„Ù’Ø¹ÙØ¸ÙÙŠÙ…Ù"]},
      {n:34, words:["ÙˆÙÙ„ÙØ§","ÙŠÙØ­ÙØ¶ÙÙ‘","Ø¹ÙÙ„ÙÙ‰Ù°","Ø·ÙØ¹ÙØ§Ù…Ù","Ø§Ù„Ù’Ù…ÙØ³Ù’ÙƒÙÙŠÙ†Ù"]},
      {n:35, words:["ÙÙÙ„ÙÙŠÙ’Ø³Ù","Ù„ÙÙ‡Ù","Ø§Ù„Ù’ÙŠÙÙˆÙ’Ù…Ù","Ù‡ÙØ§Ù‡ÙÙ†ÙØ§","Ø­ÙÙ…ÙÙŠÙ…ÙŒ"]},
      {n:36, words:["ÙˆÙÙ„ÙØ§","Ø·ÙØ¹ÙØ§Ù…ÙŒ","Ø¥ÙÙ„ÙÙ‘Ø§","Ù…ÙÙ†Ù’","ØºÙØ³Ù’Ù„ÙÙŠÙ†Ù"]},
      {n:37, words:["Ù„ÙÙ‘Ø§","ÙŠÙØ£Ù’ÙƒÙÙ„ÙÙ‡Ù","Ø¥ÙÙ„ÙÙ‘Ø§","Ø§Ù„Ù’Ø®ÙØ§Ø·ÙØ¦ÙÙˆÙ†Ù"]},
      {n:38, words:["ÙÙÙ„ÙØ§","Ø£ÙÙ‚Ù’Ø³ÙÙ…Ù","Ø¨ÙÙ…ÙØ§","ØªÙØ¨Ù’ØµÙØ±ÙÙˆÙ†Ù"]},
      {n:39, words:["ÙˆÙÙ…ÙØ§","Ù„ÙØ§","ØªÙØ¨Ù’ØµÙØ±ÙÙˆÙ†Ù"]},
      {n:40, words:["Ø¥ÙÙ†ÙÙ‘Ù‡Ù","Ù„ÙÙ‚ÙÙˆÙ’Ù„Ù","Ø±ÙØ³ÙÙˆÙ„Ù","ÙƒÙØ±ÙÙŠÙ…Ù"]},
      {n:41, words:["ÙˆÙÙ…ÙØ§","Ù‡ÙÙˆÙ","Ø¨ÙÙ‚ÙÙˆÙ’Ù„Ù","Ø´ÙØ§Ø¹ÙØ±Ù","Ù‚ÙÙ„ÙÙŠÙ„Ù‹Ø§","Ù…ÙÙ‘Ø§","ØªÙØ¤Ù’Ù…ÙÙ†ÙÙˆÙ†Ù"]},
      {n:42, words:["ÙˆÙÙ„ÙØ§","Ø¨ÙÙ‚ÙÙˆÙ’Ù„Ù","ÙƒÙØ§Ù‡ÙÙ†Ù","Ù‚ÙÙ„ÙÙŠÙ„Ù‹Ø§","Ù…ÙÙ‘Ø§","ØªÙØ°ÙÙƒÙÙ‘Ø±ÙÙˆÙ†Ù"]},
      {n:43, words:["ØªÙÙ†Ø²ÙÙŠÙ„ÙŒ","Ù…ÙÙ‘Ù†","Ø±ÙÙ‘Ø¨ÙÙ‘","Ø§Ù„Ù’Ø¹ÙØ§Ù„ÙÙ…ÙÙŠÙ†Ù"]},
      {n:44, words:["ÙˆÙÙ„ÙÙˆÙ’","ØªÙÙ‚ÙÙˆÙÙ‘Ù„Ù","Ø¹ÙÙ„ÙÙŠÙ’Ù†ÙØ§","Ø¨ÙØ¹Ù’Ø¶Ù","Ø§Ù„Ù’Ø£ÙÙ‚ÙØ§ÙˆÙÙŠÙ„Ù"]},
      {n:45, words:["Ù„ÙØ£ÙØ®ÙØ°Ù’Ù†ÙØ§","Ù…ÙÙ†Ù’Ù‡Ù","Ø¨ÙØ§Ù„Ù’ÙŠÙÙ…ÙÙŠÙ†Ù"]},
      {n:46, words:["Ø«ÙÙ…ÙÙ‘","Ù„ÙÙ‚ÙØ·ÙØ¹Ù’Ù†ÙØ§","Ù…ÙÙ†Ù’Ù‡Ù","Ø§Ù„Ù’ÙˆÙØªÙÙŠÙ†Ù"]},
      {n:47, words:["ÙÙÙ…ÙØ§","Ù…ÙÙ†ÙƒÙÙ…","Ù…ÙÙ‘Ù†Ù’","Ø£ÙØ­ÙØ¯Ù","Ø¹ÙÙ†Ù’Ù‡Ù","Ø­ÙØ§Ø¬ÙØ²ÙÙŠÙ†Ù"]},
      {n:48, words:["ÙˆÙØ¥ÙÙ†ÙÙ‘Ù‡Ù","Ù„ÙØªÙØ°Ù’ÙƒÙØ±ÙØ©ÙŒ","Ù„ÙÙ‘Ù„Ù’Ù…ÙØªÙÙ‘Ù‚ÙÙŠÙ†Ù"]},
      {n:49, words:["ÙˆÙØ¥ÙÙ†ÙÙ‘Ø§","Ù„ÙÙ†ÙØ¹Ù’Ù„ÙÙ…Ù","Ø£ÙÙ†ÙÙ‘","Ù…ÙÙ†ÙƒÙÙ…","Ù…ÙÙ‘ÙƒÙØ°ÙÙ‘Ø¨ÙÙŠÙ†Ù"]},
      {n:50, words:["ÙˆÙØ¥ÙÙ†ÙÙ‘Ù‡Ù","Ù„ÙØ­ÙØ³Ù’Ø±ÙØ©ÙŒ","Ø¹ÙÙ„ÙÙ‰","Ø§Ù„Ù’ÙƒÙØ§ÙÙØ±ÙÙŠÙ†Ù"]},
      {n:51, words:["ÙˆÙØ¥ÙÙ†ÙÙ‘Ù‡Ù","Ù„ÙØ­ÙÙ‚ÙÙ‘","Ø§Ù„Ù’ÙŠÙÙ‚ÙÙŠÙ†Ù"]},
      {n:52, words:["ÙÙØ³ÙØ¨ÙÙ‘Ø­Ù’","Ø¨ÙØ§Ø³Ù’Ù…Ù","Ø±ÙØ¨ÙÙ‘ÙƒÙ","Ø§Ù„Ù’Ø¹ÙØ¸ÙÙŠÙ…Ù"]}
    ]
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JUZ METADATA â€” surahs fetched dynamically from API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const JUZ_SURAHS = {
  // Juz 1: Al-Fatihah (already in SURAHS) + Al-Baqarah 1-141
  2:  {name:'Al-Baqarah',       ayahCount:286, bismillah:true,  juz:[1,2,3]},
  // Juz 29
  67: {name:'Al-Mulk',          ayahCount:30,  bismillah:true,  juz:[29]},
  70: {name:'Al-Maarij',        ayahCount:44,  bismillah:true,  juz:[29]},
  71: {name:'Nuh',              ayahCount:28,  bismillah:true,  juz:[29]},
  72: {name:'Al-Jinn',          ayahCount:28,  bismillah:true,  juz:[29]},
  73: {name:'Al-Muzzammil',     ayahCount:20,  bismillah:true,  juz:[29]},
  74: {name:'Al-Muddathir',     ayahCount:56,  bismillah:true,  juz:[29]},
  75: {name:'Al-Qiyamah',       ayahCount:40,  bismillah:false, juz:[29]},
  76: {name:'Al-Insan',         ayahCount:31,  bismillah:true,  juz:[29]},
  77: {name:'Al-Mursalat',      ayahCount:50,  bismillah:true,  juz:[29]},
  // Juz 30
  78: {name:"An-Naba'",         ayahCount:40,  bismillah:true,  juz:[30]},
  79: {name:"An-Nazi'at",       ayahCount:46,  bismillah:true,  juz:[30]},
  80: {name:"'Abasa",           ayahCount:42,  bismillah:true,  juz:[30]},
  81: {name:'At-Takwir',        ayahCount:29,  bismillah:true,  juz:[30]},
  82: {name:'Al-Infitar',       ayahCount:19,  bismillah:true,  juz:[30]},
  83: {name:'Al-Mutaffifin',    ayahCount:36,  bismillah:true,  juz:[30]},
  84: {name:'Al-Inshiqaq',      ayahCount:25,  bismillah:true,  juz:[30]},
  85: {name:'Al-Buruj',         ayahCount:22,  bismillah:true,  juz:[30]},
  86: {name:'At-Tariq',         ayahCount:17,  bismillah:true,  juz:[30]},
  87: {name:"Al-A'la",          ayahCount:19,  bismillah:true,  juz:[30]},
  88: {name:'Al-Ghashiyah',     ayahCount:26,  bismillah:true,  juz:[30]},
  89: {name:'Al-Fajr',          ayahCount:30,  bismillah:true,  juz:[30]},
  90: {name:'Al-Balad',         ayahCount:20,  bismillah:true,  juz:[30]},
  91: {name:'Ash-Shams',        ayahCount:15,  bismillah:true,  juz:[30]},
  92: {name:'Al-Layl',          ayahCount:21,  bismillah:true,  juz:[30]},
  93: {name:'Ad-Duha',          ayahCount:11,  bismillah:true,  juz:[30]},
  94: {name:'Ash-Sharh',        ayahCount:8,   bismillah:true,  juz:[30]},
  95: {name:'At-Tin',           ayahCount:8,   bismillah:true,  juz:[30]},
  96: {name:"Al-'Alaq",         ayahCount:19,  bismillah:true,  juz:[30]},
  97: {name:'Al-Qadr',          ayahCount:5,   bismillah:true,  juz:[30]},
  98: {name:'Al-Bayyinah',      ayahCount:8,   bismillah:true,  juz:[30]},
  99: {name:'Az-Zalzalah',      ayahCount:8,   bismillah:true,  juz:[30]},
  100:{name:"Al-'Adiyat",       ayahCount:11,  bismillah:true,  juz:[30]},
  101:{name:"Al-Qari'ah",       ayahCount:11,  bismillah:true,  juz:[30]},
  102:{name:'At-Takathur',      ayahCount:8,   bismillah:true,  juz:[30]},
  103:{name:"Al-'Asr",          ayahCount:3,   bismillah:true,  juz:[30]},
  104:{name:'Al-Humazah',       ayahCount:9,   bismillah:true,  juz:[30]},
  105:{name:'Al-Fil',           ayahCount:5,   bismillah:true,  juz:[30]},
  106:{name:'Quraish',          ayahCount:4,   bismillah:true,  juz:[30]},
  107:{name:"Al-Ma'un",         ayahCount:7,   bismillah:true,  juz:[30]},
  108:{name:'Al-Kawthar',       ayahCount:3,   bismillah:true,  juz:[30]},
  109:{name:'Al-Kafirun',       ayahCount:6,   bismillah:true,  juz:[30]},
  110:{name:'An-Nasr',          ayahCount:3,   bismillah:true,  juz:[30]},
  111:{name:'Al-Masad',         ayahCount:5,   bismillah:false, juz:[30]},
  // 112, 113, 114 already in SURAHS
};

// Dynamic surah cache: surahNum -> loaded SURAHS-format entry
const dynamicSurahCache = {};

async function loadDynamicSurah(surahNum) {
  // Already in static SURAHS
  if (SURAHS[surahNum]) return SURAHS[surahNum];
  // Already cached
  if (dynamicSurahCache[surahNum]) return dynamicSurahCache[surahNum];

  const meta = JUZ_SURAHS[surahNum];
  if (!meta) return null;

  // Show loading state
  const body = document.getElementById('mushafBody');
  body.innerHTML = `<div style="text-align:center;padding:60px 20px;color:var(--muted);font-family:Inter">
    <div style="font-size:32px;margin-bottom:12px">ğŸ“–</div>
    <div style="font-size:14px;font-weight:600;color:var(--text)">Memuat ${meta.name}...</div>
    <div style="font-size:12px;margin-top:6px">Mengambil data dari server</div>
  </div>`;

  try {
    // Fetch word-by-word data from alquran.cloud
    const res = await fetch(`https://api.alquran.cloud/v1/surah/${surahNum}/quran-uthmani`);
    if (!res.ok) throw new Error('API error ' + res.status);
    const data = await res.json();

    const STRIP_RE = /[Ø€-Ø…Û–-Û¤Û§-Û©]/g;
    const simpleNorm = w => w.replace(/[Ù‹-ÙŸØ-ØšÛ–-Û¿Ù±]/g, '')
                              .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§').replace(/Ù‰/g, 'ÙŠ').replace(/Ø©/g, 'Ù‡');

    const ayahs = [];
    for (const ayah of data.data.ayahs) {
      let words = ayah.text.trim()
        .split(/\s+/)
        .map(w => w.replace(STRIP_RE, '').trim())
        .filter(w => w.length > 0);

      // Strip bismillah prepended to ayah 1
      if (ayah.numberInSurah === 1 && words.length >= 4) {
        const first4 = words.slice(0, 4).map(simpleNorm);
        if (first4[0].includes('Ø¨Ø³Ù…') || first4[0] === 'Ø¨Ø³Ù…') {
          words = words.slice(4);
        }
      }

      ayahs.push({ n: ayah.numberInSurah, words });
    }

    const entry = {
      name: meta.name,
      num: surahNum,
      bismillah: meta.bismillah,
      ayahs,
      _dynamic: true
    };

    dynamicSurahCache[surahNum] = entry;
    // Also inject into SURAHS so all existing code works seamlessly
    SURAHS[surahNum] = entry;
    console.log(`âœ… Dynamic surah ${surahNum} ${meta.name} loaded â€” ${ayahs.length} ayat`);
    return entry;

  } catch(e) {
    console.error('Failed to load surah', surahNum, e);
    body.innerHTML = `<div style="text-align:center;padding:60px 20px;color:#ef6b5a;font-family:Inter">
      <div style="font-size:32px;margin-bottom:12px">âš ï¸</div>
      <div style="font-size:14px;font-weight:600">Gagal memuat ${meta.name}</div>
      <div style="font-size:12px;margin-top:6px;color:var(--muted)">Periksa koneksi internet dan coba lagi</div>
      <button onclick="loadSurah()" style="margin-top:16px;padding:8px 20px;background:var(--gold);border:none;border-radius:8px;color:white;cursor:pointer;font-size:13px">Coba Lagi</button>
    </div>`;
    return null;
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLOBALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentSurah = 68;
let displayMode = 'word';
let allWords = [];
let allAyahs = [];
let cursor = 0;
let sessionActive = false;
let correctCount = 0, wrongCount = 0;
let rec = null;
let recRunning = false;
let processingResult = false;

// Smart Recognition Variables
let lastTranscriptTime = 0;
let silenceTimeout = null;
let transcriptBuffer = [];
let currentAyahIndex = 0;
let autoAdvanceEnabled = true;
let sessionRunStart = -1;   // titik awal sesi baca aktif (untuk retry return)

// Audio Player Globals
let audioPlaying = false;
let audioCurrentRepeat = 0;
let audioCurrentAyah = 0;
let audioTimeoutId = null;

// â”€â”€â”€ Analytics: track patterns of mismatches for debugging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let matchStats = {
  totalProcessed: 0,
  directMatch: 0,
  ngramMatch: 0,
  revNgramMatch: 0,
  skipMatch: 0,
  extraSR: 0,
  mismatches: 0,
  cascadeBreaks: 0,
  recentMismatches: []  // keep last 20 for inspection
};

function logMatchStats() {
  const pct = matchStats.totalProcessed > 0
    ? (matchStats.directMatch / matchStats.totalProcessed * 100).toFixed(1)
    : '0';
  console.log(`ğŸ“Š Match Stats: ${matchStats.totalProcessed} tokens processed, ${pct}% direct match`);
  console.log(`   Ngram: ${matchStats.ngramMatch}, RevNgram: ${matchStats.revNgramMatch}, Skip: ${matchStats.skipMatch}`);
  console.log(`   Mismatches: ${matchStats.mismatches}, Cascade breaks: ${matchStats.cascadeBreaks}`);
  if (matchStats.recentMismatches.length > 0) {
    console.log(`   Recent mismatches (last 5):`, matchStats.recentMismatches.slice(-5));
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DISPLAY MODE SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchDisplayMode(mode) {
  // Mushaf Madani removed â€” always word mode
  renderPage(currentSurah);
  // renderPage is async but we don't need to await here
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIO PLAYER FUNCTIONALITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getAudioUrl(surahNum, ayahNum) {
  const paddedSurah = String(surahNum).padStart(3, '0');
  const paddedAyah = String(ayahNum).padStart(3, '0');
  return `https://everyayah.com/data/Alafasy_128kbps/${paddedSurah}${paddedAyah}.mp3`;
}

async function toggleAudioPlayer() {
  if (audioPlaying) {
    stopAudioPlayer();
  } else {
    startAudioPlayer();
  }
}

function startAudioPlayer() {
  const startAyah = parseInt(document.getElementById('audioStartAyah').value);
  const endAyah = parseInt(document.getElementById('audioEndAyah').value);
  const repeatCount = parseInt(document.getElementById('audioRepeatCount').value);
  const pauseDuration = parseFloat(document.getElementById('audioPause').value) * 1000;

  const surahData = SURAHS[currentSurah];
  if (!surahData) {
    updateAudioStatus('âŒ Surah tidak ditemukan', false);
    return;
  }

  const maxAyah = surahData.ayahs.length;
  if (startAyah < 1 || endAyah > maxAyah || startAyah > endAyah) {
    updateAudioStatus(`âŒ Range ayat tidak valid (1-${maxAyah})`, false);
    return;
  }

  audioPlaying = true;
  audioCurrentRepeat = 0;
  audioCurrentAyah = startAyah;

  document.getElementById('audioPlayBtn').classList.add('playing');
  document.getElementById('audioPlayIcon').textContent = 'â¸ï¸';
  document.getElementById('audioPlayText').textContent = 'Hentikan Audio';

  log(`ğŸ”Š Memutar ${surahData.name} ayat ${startAyah}-${endAyah}, ${repeatCount}x pengulangan`);

  playNextAyah(startAyah, endAyah, repeatCount, pauseDuration);
}

function playNextAyah(startAyah, endAyah, totalRepeats, pauseDuration) {
  if (!audioPlaying) return;

  if (audioCurrentAyah > endAyah) {
    audioCurrentRepeat++;
    if (audioCurrentRepeat >= totalRepeats) {
      stopAudioPlayer();
      updateAudioStatus('âœ… Selesai! Audio telah diputar lengkap', true);
      log(`âœ… Audio selesai - ${totalRepeats} pengulangan`);
      return;
    }
    audioCurrentAyah = startAyah;
  }

  const surahData = SURAHS[currentSurah];
  
  highlightPlayingAyah(audioCurrentAyah);

  const audioUrl = getAudioUrl(currentSurah, audioCurrentAyah);
  const audio = new Audio(audioUrl);

  const repeatText = `Pengulangan ${audioCurrentRepeat + 1}/${totalRepeats}`;
  const ayahText = `${surahData.name} ayat ${audioCurrentAyah}/${endAyah}`;
  updateAudioStatus(`ğŸ”Š ${ayahText} â€¢ ${repeatText}`, true);

  audio.onended = () => {
    audioTimeoutId = setTimeout(() => {
      audioCurrentAyah++;
      playNextAyah(startAyah, endAyah, totalRepeats, pauseDuration);
    }, pauseDuration);
  };

  audio.onerror = () => {
    log(`âš ï¸ Error loading audio untuk ayat ${audioCurrentAyah}`, true);
    audioTimeoutId = setTimeout(() => {
      audioCurrentAyah++;
      playNextAyah(startAyah, endAyah, totalRepeats, pauseDuration);
    }, 500);
  };

  audio.play().catch(err => {
    log(`âš ï¸ Tidak dapat memutar audio: ${err.message}`, true);
    audioTimeoutId = setTimeout(() => {
      audioCurrentAyah++;
      playNextAyah(startAyah, endAyah, totalRepeats, pauseDuration);
    }, 500);
  });
}

function stopAudioPlayer() {
  audioPlaying = false;
  if (audioTimeoutId) {
    clearTimeout(audioTimeoutId);
    audioTimeoutId = null;
  }

  document.getElementById('audioPlayBtn').classList.remove('playing');
  document.getElementById('audioPlayIcon').textContent = 'â–¶ï¸';
  document.getElementById('audioPlayText').textContent = 'Putar Audio';

  clearPlayingAyahHighlight();
  updateAudioStatus('â¸ï¸ Audio dihentikan', false);
  log('â¸ï¸ Pemutaran audio dihentikan');
}

function highlightPlayingAyah(ayahNum) {
  clearPlayingAyahHighlight();
  
  if (allAyahs[ayahNum - 1]) {
    allAyahs[ayahNum - 1].classList.add('playing');
    allAyahs[ayahNum - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

function clearPlayingAyahHighlight() {
  allAyahs.forEach(ayah => ayah.classList.remove('playing'));
}

function updateAudioStatus(text, active) {
  const statusEl = document.getElementById('audioStatus');
  statusEl.textContent = text;
  if (active) {
    statusEl.classList.add('active');
  } else {
    statusEl.classList.remove('active');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Uthmani text cache (API fetch results) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const uthmaniCache = {};

async function fetchUthmaniText(surahNum) {
  if (uthmaniCache[surahNum]) return uthmaniCache[surahNum];
  try {
    const res = await fetch(`https://api.alquran.cloud/v1/surah/${surahNum}/quran-uthmani`);
    if (!res.ok) throw new Error('API error');
    const data = await res.json();
    // Build map: ayahNumber â†’ array of words (split on spaces)
    const ayahMap = {};
    
    // Characters to strip from display words (Quranic structural marks, not harakat)
    // U+06DD Û End of Ayah, U+06DE Û Rub el-Hizb, U+06E9 Û© Sajdah mark
    // U+0600-0603 Quranic annotation signs
    // Strip ALL Quranic annotation/structural marks that aren't part of the word text:
    // U+0600-U+0605: Arabic annotation signs
    // U+06D6-U+06E4: Quranic waqf marks (Û– Û— Û˜ Û™ Ûš Û› Ûœ Û Û ÛŸ Û  Û¡ Û¢ Û£ Û¤)
    // U+06E7-U+06E9: Arabic small high chars, sajdah mark
    // NOTE: U+06E5 Û¥ (small waw) and U+06E6 Û¦ (small ya) are kept â€” they're word-internal
    const STRIP_RE = /[\u0600-\u0605\u06D6-\u06E4\u06E7-\u06E9]/g;
    
    // Bismillah normalized form (to detect if API prepended it to ayah 1)
    const BISMILLAH_NORM = ['Ø¨Ø³Ù…', 'Ø§Ù„Ù„Ù‡', 'Ø§Ù„Ø±Ø­Ù…Ù†', 'Ø§Ù„Ø±Ø­ÙŠÙ…'];
    
    for (const ayah of data.data.ayahs) {
      // Split by whitespace, strip structural markers, filter empties
      let words = ayah.text.trim()
        .split(/\s+/)
        .map(w => w.replace(STRIP_RE, '').trim())
        .filter(w => w.length > 0);
      
      // FIX: quran-uthmani API prepends bismillah to ayah 1 text for most surahs
      // Detect and strip it so our SURAHS word alignment stays correct
      if (ayah.numberInSurah === 1 && words.length >= 4) {
        // Normalize first 4 words and check if they match bismillah
        const simpleNorm = w => w.replace(/[\u064B-\u065F\u0610-\u061A\u06D6-\u06FF\u0671]/g, '')
                                  .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§').replace(/Ù‰/g, 'ÙŠ').replace(/Ø©/g, 'Ù‡');
        const first4 = words.slice(0, 4).map(simpleNorm);
        const isBismillah = first4[0].includes('Ø¨Ø³Ù…') || first4[0] === 'Ø¨Ø³Ù…';
        if (isBismillah) {
          console.log(`  âœ‚ï¸ Stripping bismillah prefix (${words.slice(0,4).join(' ')}) from ayah 1`);
          words = words.slice(4);
        }
      }
      
      ayahMap[ayah.numberInSurah] = words;
    }

    console.log(`ğŸ“– API surah ${surahNum} loaded â€” ayah 1: ${ayahMap[1]?.length} words, ayah 2: ${ayahMap[2]?.length} words`);
    uthmaniCache[surahNum] = ayahMap;
    return ayahMap;
  } catch (e) {
    console.warn('Uthmani API fetch failed, using fallback data:', e);
    return null;
  }
}

async function renderPage(sn) {
  // Load dynamically if not in static SURAHS
  let s = SURAHS[sn];
  if (!s) {
    s = await loadDynamicSurah(sn);
    if (!s) return; // failed to load, error shown in body
  }
  
  document.getElementById('pageTitle').textContent = s.name;
  document.getElementById('pageInfo').textContent = s.ayahs.length + ' ayat';

  const b = document.getElementById('mushafBody');
  b.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted);font-family:Inter">Memuat teks mushaf...</div>';
  allWords = [];
  allAyahs = [];

  // Fetch Uthmani text from API (with waqf marks, correct mad signs)
  const uthmaniMap = await fetchUthmaniText(sn);

  // Merge API words into surah data (keep fallback norms from SURAHS for matching)
  // First clear any stale uthmaniWords from previous loads
  s.ayahs.forEach(ayah => { delete ayah.uthmaniWords; });
  
  if (uthmaniMap) {
    s.ayahs.forEach(ayah => {
      const uthmaniWords = uthmaniMap[ayah.n];
      if (uthmaniWords && uthmaniWords.length > 0) {
        ayah.uthmaniWords = uthmaniWords;
      }
    });
  }

  b.innerHTML = '';

  if (s.bismillah && sn !== 1 && sn !== 9) {
    const bis = document.createElement('div');
    bis.className = 'bismillah';
    // Always use the Uthmanic bismillah text (same for all surahs)
    bis.textContent = 'Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù';
    b.appendChild(bis);
  }

  if (displayMode === 'madani') {
    renderMadaniMode(s, b);
  } else {
    renderWordMode(s, b);
  }

  document.getElementById('audioStartAyah').max = s.ayahs.length;
  document.getElementById('audioEndAyah').max = s.ayahs.length;
  document.getElementById('audioEndAyah').value = Math.min(5, s.ayahs.length);

  cursor = 0;
  currentAyahIndex = 0;
  if (displayMode === 'word') {
    highlightCursor();
    updateCurrentAyahHighlight();
  }
}

function renderWordMode(s, container) {
  s.ayahs.forEach((ayah, ayahIdx) => {
    const row = document.createElement('div');
    row.className = 'ayah-row';
    row.dataset.ayahNum = ayah.n;
    row.dataset.ayahIndex = ayahIdx;
    
    const num = document.createElement('span');
    num.className = 'ayah-number';
    num.textContent = ayah.n;

    // DISPLAY: use Uthmani API words (correct waqf + mad signs)
    // MATCHING: use SURAHS hardcode words (stable normalization)
    const uthmaniWords = ayah.uthmaniWords;
    const matchWords = ayah.words;
    
    // Smart alignment: map SURAHS word index to nearest Uthmani word
    // Handles cases where API may split/merge words slightly differently
    const useUthmani = uthmaniWords && uthmaniWords.length > 0;
    

    
    matchWords.forEach((matchWord, wordIdx) => {
      // Map index proportionally if word counts differ
      let displayWord = matchWord;
      if (useUthmani) {
        if (uthmaniWords.length === matchWords.length) {
          displayWord = uthmaniWords[wordIdx];
        } else {
          // Proportional mapping (rare case)
          const ratio = wordIdx / matchWords.length;
          const uIdx = Math.min(Math.round(ratio * uthmaniWords.length), uthmaniWords.length - 1);
          displayWord = uthmaniWords[uIdx];
        }
      }
      
      const w = document.createElement('span');
      w.className = 'w idle';
      w.textContent = displayWord + ' ';
      w.dataset.wordIndex = allWords.length;
      w.dataset.ayahIndex = ayahIdx;
      const norm = normalizeArabic(matchWord); // normalize the rasm word, not display
      const normStrict = normalizeArabicStrict(matchWord); // preserves Ø£ vs Ø¥
      allWords.push({ 
        el: w, 
        norm,
        normStrict,          // strict norm for short-word hamza comparison
        ref: matchWord,      // original ref word WITH harakat for vowel comparison
        original: displayWord, // display word for retry banner
        ayahIndex: ayahIdx,
        wordIndexInAyah: wordIdx 
      });
      row.appendChild(w);
    });

    row.appendChild(num);
    container.appendChild(row);
    allAyahs.push(row);
  });
}

function renderMadaniMode(s, container) {
  s.ayahs.forEach((ayah, ayahIdx) => {
    const row = document.createElement('div');
    row.className = 'ayah-row madani-mode';
    row.dataset.ayahNum = ayah.n;
    
    const textSpan = document.createElement('span');
    textSpan.className = 'ayah-text-madani';
    // Use Uthmani API words if available for correct display
    const displayText = (ayah.uthmaniWords || ayah.words).join(' ');
    textSpan.textContent = displayText + ' ';
    row.appendChild(textSpan);
    
    const num = document.createElement('span');
    num.className = 'ayah-number';
    num.textContent = ayah.n;
    row.appendChild(num);

    container.appendChild(row);
    allAyahs.push(row);
    
    ayah.words.forEach((word) => {
      const norm = normalizeArabic(word);
      allWords.push({ el: textSpan, norm, ayahRow: row, ayahIndex: ayahIdx });
    });
  });
}

function highlightCursor() {
  if (displayMode === 'madani') return;
  
  allWords.forEach((w, i) => {
    if (!w.el.className || !w.el.className.includes('w ')) return;
    
    if (i === cursor) {
      if (retryMode && i === retryAyahStart) {
        // In retry mode at the restart point: use retry-cursor (yellow on green)
        w.el.className = 'w retry-cursor';
      } else if (w.el.className === 'w idle' || w.el.className === 'w skipped' || w.el.className === 'w passed') {
        w.el.className = 'w cursor';
      }
      // If already 'correct' or 'wrong', keep their color
    } else if (w.el.className === 'w cursor' || w.el.className === 'w retry-cursor') {
      // This word WAS the cursor but no longer is
      // If it became correct through validation, it would already be 'w correct'
      // Otherwise restore to idle
      w.el.className = 'w idle';
    } else if (i < cursor && w.el.className === 'w idle') {
      w.el.className = 'w passed';
    }
    // All other states (correct, wrong, skipped, passed) â€” leave unchanged
  });
}

function updateCurrentAyahHighlight() {
  allAyahs.forEach((ayah, idx) => {
    ayah.classList.toggle('current-reading', idx === currentAyahIndex);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NORMALIZE - STRICT VERSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€â”€ Normalization â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function normalizeArabic(text) {
  if (!text || typeof text !== 'string') return '';
  return text
    // Full harakat + Quranic symbols strip
    .replace(/[Ù‹-ÙŸØ-ØšÛ–-ÛœÛŸ-Û¤Û§Û¨Ûª-Û­Ù°]/g, '')
    .replace(/[Ø£Ø¥Ø¢Ù±]/g, 'Ø§')
    .replace(/Ù‰/g, 'ÙŠ')
    .replace(/Ø©/g, 'Ù‡')
    .replace(/Ù€/g, '')   // tatweel
    .trim();
}

// Strict normalization: preserves Ø£ (fathah hamza) vs Ø¥ (kasrah hamza).
// ar-SA SR outputs these as different letters â€” they are different Arabic words:
//   Ø£ÙÙ† (An) â†’ SR: Ø£Ù†   vs   Ø¥ÙÙ† (In) â†’ SR: Ø¥Ù†   (very common Quran error)
//   Ø£ÙÙ…Ù’ (Am) â†’ SR: Ø£Ù…  vs   Ø¥ÙÙ…ÙÙ‘Ø§   â†’ SR: Ø¥Ù…Ø§
// Used in wordSimStrict() for short words (â‰¤5 chars) where this distinction matters.
function normalizeArabicStrict(text) {
  if (!text || typeof text !== 'string') return '';
  return text
    .replace(/[\u064B-\u065F\u0610-\u061A\u06D6-\u06E4\u06E7-\u06E9]/g, '')
    .replace(/[\u0622\u0671]/g, '\u0627')
    .replace(/Ù‰/g, 'ÙŠ')
    .replace(/Ø©/g, 'Ù‡')
    .replace(/Ù€/g, '')
    .trim();
}

function alternateNormalize(text) {
  if (!text || typeof text !== 'string') return '';
  return normalizeArabic(text)
    .replace(/Ø¡/g, '')
    .replace(/Ø¦/g, 'ÙŠ')
    .replace(/Ø¤/g, 'Ùˆ')
    .trim();
}

// â”€â”€â”€ Levenshtein edit distance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function editDist(a, b) {
  const m = a.length, n = b.length;
  if (!m) return n; if (!n) return m;
  const dp = Array.from({length: m + 1}, (_, i) => [i, ...Array(n).fill(0)]);
  for (let j = 0; j <= n; j++) dp[0][j] = j;
  for (let i = 1; i <= m; i++)
    for (let j = 1; j <= n; j++)
      dp[i][j] = a[i-1] === b[j-1] ? dp[i-1][j-1]
        : 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
  return dp[m][n];
}

// â”€â”€â”€ Spoken candidates (handle SR transcription quirks + tajweed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spokenCandidates(spoken) {
  const s = normalizeArabic(spoken);
  const c = new Set([s, alternateNormalize(spoken)]);
  
  // â”€â”€ SR PREFIX QUIRKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (s.startsWith('Ø§Ù„') && s.length > 3) { c.add(s.slice(2)); c.add('Ù„' + s.slice(2)); }
  if (s.startsWith('ÙˆØ§Ù„') && s.length > 4) { c.add(s.slice(3)); c.add('Ù„' + s.slice(3)); }
  
  // â”€â”€ TAJWEED: Ø§Ù„Ø§ (SR) = Ø£ÙÙ† + Ù„ÙÙ‘Ø§ merged â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ONLY fires for exact token "Ø§Ù„Ø§" â€” not generic, to prevent over-matching
  if (s === 'Ø§Ù„Ø§' || s === 'Ø§Ù„Ø§') {
    c.add('Ù„Ø§');   // matches ref Ù„ÙÙ‘Ø§
    c.add('Ø§Ù†');   // matches ref Ø£ÙÙ† â€” for bigram matching
    c.add('Ø§Ù†Ù„Ø§'); // merged bigram form
  }
  if (s.startsWith('Ø§Ù„Ø§') && s.length > 3) { c.add('Ù„Ø§' + s.slice(3)); }
  if (s.startsWith('Ù„Ø§') && s.length > 2) { c.add('Ø§Ù„Ø§' + s.slice(2)); }

  // â”€â”€ TAJWEED: dropped initial Ø§ (alif wasl) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Ø§ØºÙ’Ø¯ÙÙˆØ§ â†’ SR hears "ØºØ¯ÙˆØ§". Only add prefix for words >= 4 chars (alif wasl
  // only occurs on longer words; prevents short-word false matches)
  const ARABIC_CONSONANTS = 'Ø¨ØªØ«Ø¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙŠ';
  if (s.length >= 4 && ARABIC_CONSONANTS.includes(s[0])) {
    c.add('Ø§' + s);
  }
  if (s.length >= 4 && s[0] === 'Ø§' && ARABIC_CONSONANTS.includes(s[1] || '')) {
    c.add(s.slice(1));
  }

  // â”€â”€ TAJWEED: dropped hamza Ø¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Ù…ÙÙ‘Ø´ÙÙ‘Ø§Ø¡Ù â†’ SR hears "Ù…Ø´Ø§". Only for words >= 3 chars to prevent Ø¥Ù†Ø§â†’Ø¥Ù†Ø§Ø¡ etc.
  if (s.endsWith('Ø§') && s.length >= 3) {
    c.add(s + 'Ø¡');
  }
  if (s.endsWith('Ø¡') && s.length >= 3) {
    c.add(s.slice(0, -1));
  }

  // â”€â”€ TAJWEED: IQLAB â€” tanwin/nun + Ø¨ = SR hears trailing Ù… on previous word â”€â”€
  // e.g. Ù…ÙÙ‘Ø´ÙÙ‘Ø§Ø¡Ù Ø¨ÙÙ†ÙÙ…ÙÙŠÙ…Ù â†’ SR hears "Ù…Ø´Ø§Ø¡Ù…" or "Ù…Ø´Ø§Ø¦Ù…" (tanwin+Ø¨ merged as Ù…)
  //      Ù‡ÙÙ…ÙÙ‘Ø§Ø²Ù â†’ SR may hear "Ù‡Ù…Ø§Ø²Ù…" when followed by Ù…ÙÙ‘Ø´ÙÙ‘Ø§Ø¡Ù
  //      Ø¹ÙØªÙÙ„ÙÙ‘ â†’ SR may hear "Ø¹ØªÙ„Ù…" when followed by Ø¨ÙØ¹Ù’Ø¯Ù
  // Idgham/iqlab: spoken ends with Ù… â†’ strip it (ref has no trailing Ù…)
  if (s.endsWith('Ù…') && s.length >= 3) {
    c.add(s.slice(0, -1));        // Ù‡Ù…Ø§Ø²Ù… â†’ Ù‡Ù…Ø§Ø²
    c.add(s.slice(0, -1) + 'Ù†'); // Ø¹ØªÙ„Ù… â†’ Ø¹ØªÙ„Ù† (tanwin variant)
  }
  // Iqlab with Ø¦Ù… or ÙŠÙ… suffix (SR inserts ÙŠ/Ø¦ before Ù… due to hamza)
  if ((s.endsWith('Ø¦Ù…') || s.endsWith('ÙŠÙ…')) && s.length >= 4) {
    c.add(s.slice(0, -2));        // Ù…Ø´Ø§Ø¦Ù… â†’ Ù…Ø´Ø§, then hamza rule adds Ù…Ø´Ø§Ø¡
    c.add(s.slice(0, -2) + 'Ø¡'); // Ù…Ø´Ø§Ø¦Ù… â†’ Ù…Ø´Ø§Ø¡ directly
  }

  // â”€â”€ Ø§Ù† / Ø§Ù†ÙŠ / Ø§Ù†Ø§ variants (short particles only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (s === 'Ø§Ù†') { c.add('Ø§Ù†'); c.add('Ø§Ù†ÙŠ'); c.add('Ø§Ù†Ø§'); c.add('Ø§'); }
  if (s === 'Ø§Ù†ÙŠ') { c.add('Ø§Ù†'); c.add('Ø§Ù†Ø§'); }
  if (s.startsWith('Ø§Ù†ÙŠ') && s.length > 3) { c.add('Ø§Ù†' + s.slice(3)); }
  if (s === 'Ø§Ù†Ø§') { c.add('Ø§Ù†'); c.add('Ø§Ù†ÙŠ'); }
  if (s === 'Ø§') { c.add('Ø§Ù†'); c.add('Ø§Ù†ÙŠ'); }
  if (s.startsWith('Ø§Ù†') && s.length > 2) { c.add('Ø§Ù†ÙŠ' + s.slice(2)); }
  
  // â”€â”€ SR SUFFIX: trailing Ø§ drop (only for >= 4 chars, prevents Ø¥Ø°â†’Ø¥Ø°Ø§ inflation) 
  if (s.endsWith('Ø§') && s.length >= 4) c.add(s.slice(0, -1));
  // NO generic "add trailing Ø§" â€” too broad, causes Ø¥Ø°â†’Ø¥Ø°Ø§â†’matches Ø¥Ù†Ø§

  // â”€â”€ ÙŠÙ†/ÙˆÙ† confusion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (s.endsWith('ÙŠÙ†')) { c.add(s.slice(0, -2) + 'ÙˆÙ†'); }
  if (s.endsWith('ÙˆÙ†')) { c.add(s.slice(0, -2) + 'ÙŠÙ†'); }
  
  return [...c].filter(Boolean);
}

// â”€â”€â”€ Muqattaat letter names â†’ single chars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LETTER_NAMES = {
  'Ù†ÙˆÙ†':'Ù†','Ù‚Ø§Ù':'Ù‚','ØµØ§Ø¯':'Øµ','Ø³ÙŠÙ†':'Ø³','Ø´ÙŠÙ†':'Ø´','Ù…ÙŠÙ…':'Ù…',
  'Ù„Ø§Ù…':'Ù„','ÙƒØ§Ù':'Ùƒ','Ø¹ÙŠÙ†':'Ø¹','Ø·Ø§Ø¡':'Ø·','Ø­Ø§Ø¡':'Ø­','ÙŠØ§Ø¡':'ÙŠ',
  'Ø§Ù„Ù':'Ø§','Ø±Ø§':'Ø±','Ù‡Ø§Ø¡':'Ù‡','ÙˆØ§Ùˆ':'Ùˆ','Ø¨Ø§Ø¡':'Ø¨','ÙØ§Ø¡':'Ù',
  'Ù†Ù†':'Ù†','Ù‚Ù':'Ù‚',
};


// â”€â”€â”€ N-gram coalescing: merge 2-3 ref words to match SR multi-word output â”€â”€â”€â”€â”€
// SR often hears "Ø£ÙÙ†Ù Ø§ØºÙ’Ø¯ÙÙˆØ§" as single token "Ø§ØºØ¯ÙˆØ§" (no space)
function refNgrams(refWords, startIdx, maxN = 3) {
  const grams = [];
  for (let n = 1; n <= Math.min(maxN, refWords.length - startIdx); n++) {
    const slice = refWords.slice(startIdx, startIdx + n);
    const merged = slice.map(w => w.norm || '').join('');  // no space!
    if (merged) grams.push({ merged, count: n });
  }
  return grams;
}


// â”€â”€â”€ Reverse N-gram: SR split 1 ref word into 2-3 spoken tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// e.g. "Ø£ÙÙˆÙ’Ø³ÙØ·ÙÙ‡ÙÙ…Ù’" â†’ SR hears "Ø§ÙˆØ³Ø·" + "Ù‡Ù…" (2 tokens)
function spokenNgrams(spokenTokens, startIdx, maxN = 3) {
  const grams = [];
  for (let n = 1; n <= Math.min(maxN, spokenTokens.length - startIdx); n++) {
    const slice = spokenTokens.slice(startIdx, startIdx + n);
    const merged = slice.join('');  // concat NO space
    if (merged) grams.push({ merged, count: n });
  }
  return grams;
}

// â”€â”€â”€ Phonetic coalescing: handle shadda/idgham fusion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// "Ù„ÙÙ‘Ø§" (shadda on lam) often transcribed as "Ù„Ø§" (no shadda marker)
// "Ø£ÙÙˆÙ’Ø³ÙØ·ÙÙ‡ÙÙ…Ù’" â†’ "Ø§ÙˆØ³Ø·Ù‡Ù…" (hamza/sukun dropped)
function phoneticNorm(text) {
  if (!text) return '';
  return alternateNormalize(text)
    .replace(/^Ù„Ø§/g, 'Ù„Ø§')      // normalize laa variants
    .replace(/Ø¤/g, 'Ùˆ')         // hamza on waw
    .replace(/Ø¦/g, 'ÙŠ');        // hamza on ya
}

// â”€â”€â”€ Similarity between two normalized strings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function simNorm(s, r) {
  if (!s || !r) return 0;
  if (s === r) return 1;

  // â”€â”€ ABSOLUTE RULE: Ù (fa) vs Ùˆ (wa) must NEVER match when same root â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const sFirst = s[0], rFirst = r[0];
  if (s.length >= 2 && r.length >= 2) {
    const sRoot = s.slice(1), rRoot = r.slice(1);
    if ((sFirst === 'Ù' && rFirst === 'Ùˆ') || (sFirst === 'Ùˆ' && rFirst === 'Ù')) {
      // Only hard-block if roots are very similar (genuine fa/wa swap)
      if (editDist(sRoot, rRoot) <= 1) return 0;
    }
  }

  const maxLen = Math.max(s.length, r.length);
  const dist = editDist(s, r);
  let sim = 1 - dist / maxLen;
  // Strong penalty when first letter differs
  if (sFirst !== rFirst) sim *= 0.70;
  // Penalty for big length mismatch
  const lr = Math.min(s.length, r.length) / maxLen;
  if (lr < 0.65) sim *= lr;
  return Math.max(0, sim);
}

// Hard check: returns true if spoken has Ù where ref has Ùˆ or vice versa
// Only applies when the root (after waw/fa prefix) is the SAME â€” i.e. genuine swap
// Does NOT fire when waw is just a conjunction prefix on a different root
function hasFaWaConflict(spoken, refNorm) {
  const sn = normalizeArabic(spoken);
  const rn = refNorm;
  if (!sn || !rn) return false;
  // Strip Ø§Ù„ prefix then check
  const sStrip = sn.startsWith('Ø§Ù„') ? sn.slice(2) : sn;
  const rStrip = rn.startsWith('Ø§Ù„') ? rn.slice(2) : rn;
  if (!sStrip || !rStrip) return false;
  const sFirst = sStrip[0], rFirst = rStrip[0];
  // Only conflict if first letters are genuinely Ù vs Ùˆ
  if (!((sFirst === 'Ù' && rFirst === 'Ùˆ') || (sFirst === 'Ùˆ' && rFirst === 'Ù'))) return false;
  // CRITICAL: only block if the ROOT (after the Ù/Ùˆ) is the same
  // e.g. ÙÙ„Ù…Ø§ vs ÙˆÙ„Ù…Ø§ â†’ same root â†’ conflict
  // e.g. ÙØ§Ù† vs ÙˆØ§Ù† â†’ same root â†’ conflict  
  // e.g. ÙˆÙ‡Ùˆ vs ÙÙ‡Ùˆ â†’ same root â†’ conflict
  // But: ÙˆØ¥Ù† (spoken) vs ÙÙ„Ø§ (ref) â†’ different roots, no conflict (edit distance handles it)
  const sRoot = sStrip.slice(1);
  const rRoot = rStrip.slice(1);
  if (!sRoot || !rRoot) return false;
  // Conflict only if roots are very similar (edit distance â‰¤ 1)
  return editDist(sRoot, rRoot) <= 1;
}

const MATCH_THRESHOLD = 0.72;

// â”€â”€â”€ Extract main vowels (harakat) from Arabic text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Returns array of vowel chars per consonant position
// We only care about fathah (Ù), kasrah (Ù), dhammah (Ù) â€” not sukun/shadda/tanwin
const FATHAH  = '\u064E'; // Ù
const KASRAH  = '\u0650'; // Ù  
const DHAMMAH = '\u064F'; // Ù

function extractVowelSequence(text) {
  if (!text) return [];
  const vowels = [];
  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    // Skip diacritics themselves
    if (c >= '\u064B' && c <= '\u065F') continue;
    // For each consonant, check what vowel follows
    let v = null;
    if (i + 1 < text.length) {
      const next = text[i + 1];
      if (next === FATHAH)  v = 'a';
      else if (next === KASRAH)  v = 'i';
      else if (next === DHAMMAH) v = 'u';
    }
    vowels.push(v); // null = no explicit vowel (sukun or end)
  }
  return vowels.filter(v => v !== null); // only keep explicit vowels
}

// â”€â”€â”€ Harakat penalty: compare vowel sequences of spoken vs ref â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Returns a multiplier [0.5, 1.0]: 1.0 = vowels match, lower = mismatch
// Only penalizes when BOTH spoken and ref have harakat (SR does include them for ar-SA)
function harakatPenalty(spokenRaw, refRaw) {
  // refRaw is the original ref word WITH harakat (from SURAHS data)
  // spokenRaw is the SR transcript which often includes harakat for ar-SA
  if (!spokenRaw || !refRaw) return 1.0;
  
  const spokenVowels = extractVowelSequence(spokenRaw);
  const refVowels = extractVowelSequence(refRaw);
  
  // Need at least 2 vowels in each to make a meaningful comparison
  // Short words or words without harakat: no penalty
  if (spokenVowels.length < 1 || refVowels.length < 1) return 1.0;
  
  // Compare up to min(len) vowels
  const compareLen = Math.min(spokenVowels.length, refVowels.length, 4);
  let mismatches = 0;
  for (let i = 0; i < compareLen; i++) {
    if (spokenVowels[i] !== refVowels[i]) mismatches++;
  }
  
  const mismatchRate = mismatches / compareLen;
  
  // Penalty scale: 
  // 0% mismatch = 1.0 (no penalty)
  // 50%+ mismatch = 0.60 (significant penalty, pushes below MATCH_THRESHOLD)
  // 100% mismatch = 0.50 (heavy penalty)
  if (mismatchRate === 0) return 1.0;
  if (mismatchRate <= 0.25) return 0.92; // minor mismatch (1 of 4 vowels)
  if (mismatchRate <= 0.5)  return 0.78; // moderate â€” "Am" vs "Im" in 2-vowel word
  return 0.65; // heavy mismatch
}

// â”€â”€â”€ Main word similarity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function wordSim(spokenRaw, refNorm) {
  if (!refNorm) return 0;

  // â”€â”€ ABSOLUTE: reject Ù vs Ùˆ mismatch BEFORE any scoring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (hasFaWaConflict(spokenRaw, refNorm)) {
    console.log(`ğŸš« FA/WA conflict: spoken="${spokenRaw}" vs ref="${refNorm}" â†’ score=0`);
    return 0;
  }

  // â”€â”€ Also try matching against ref with Ø¡ stripped (ref-side hamza tolerance) â”€â”€
  // Ù…Ø´Ø§Ø¡ (ref) should match Ù…Ø´Ø§ (SR) even if candidate generation misses it
  const refAlt = refNorm.replace(/Ø¡/g, ''); // strip hamza from ref
  if (refAlt !== refNorm) {
    // Check spoken candidates against hamza-stripped ref
    const altScore = Math.max(...spokenCandidates(spokenRaw).map(c => simNorm(c, refAlt)));
    if (altScore >= MATCH_THRESHOLD) return altScore;
  }

  // â”€â”€ Also try: ref starts with Ø§ (alif wasl), match spoken without initial Ø§ â”€â”€
  // Ø§ØºØ¯ÙˆØ§ (ref) should match ØºØ¯ÙˆØ§ (SR) where alif wasl was absorbed
  if (refNorm.length >= 3 && refNorm[0] === 'Ø§') {
    const refNoAlif = refNorm.slice(1);
    const noAlifScore = Math.max(...spokenCandidates(spokenRaw).map(c => simNorm(c, refNoAlif)));
    if (noAlifScore >= MATCH_THRESHOLD) return noAlifScore * 0.95; // slight discount
  }

  // Special handling for very short words (Ø£ÙÙ†Ù, Ø£ÙÙ†, etc.)
  if (refNorm.length <= 2) {
    const candidates = spokenCandidates(spokenRaw);
    for (const c of candidates) {
      if (c === refNorm) return 1.0;
      if (c.length <= 3 && c[0] === refNorm[0]) return 0.85;
      if (c.includes(refNorm) || refNorm.includes(c)) return 0.80;
    }
    const best = Math.max(...candidates.map(c => simNorm(c, refNorm)));
    if (best > 0.5) return Math.max(0.75, best);
    return best;
  }
  
  // Muqattaat: single-char reference (Ù†ØŒ Ù‚ØŒ Øµâ€¦)
  if (refNorm.length === 1) {
    for (const c of spokenCandidates(spokenRaw)) {
      if (c === refNorm || LETTER_NAMES[c] === refNorm || c[0] === refNorm[0]) return 0.95;
    }
    return 0;
  }
  
  // Short muqattaat (Ø§Ù„Ù…ØŒ ÙŠØ³â€¦)
  if (refNorm.length <= 4) {
    const sn = normalizeArabic(spokenRaw);
    if (LETTER_NAMES[sn] && normalizeArabic(LETTER_NAMES[sn]) === refNorm) return 1;
    if (sn[0] === refNorm[0] && sn.length <= refNorm.length * 3) {
      const base = Math.max(...spokenCandidates(spokenRaw).map(c => simNorm(c, refNorm)));
      return Math.max(0.78, base);
    }
  }
  return Math.max(...spokenCandidates(spokenRaw).map(c => simNorm(c, refNorm)));
}

// Kept for any existing callers
function isSimilarWord(w1, w2) {
  return wordSim(w1, normalizeArabic(w2)) >= MATCH_THRESHOLD;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SMART SPEECH RECOGNITION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupRec() {
  if (rec) return true;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return false;

  rec = new SR();
  rec.lang = 'ar-SA';
  rec.continuous = true;
  rec.interimResults = true; // Enable interim results for better responsiveness
  rec.maxAlternatives = 5; // Increased for better matching

  rec.onstart = () => {
    recRunning = true;
    document.getElementById('btnMic').classList.add('live');
    document.getElementById('btnMic').textContent = 'â¸ï¸';
    document.getElementById('micLabel').textContent = 'Mendengarkan...';
    document.getElementById('micSub').textContent = 'Otomatis mengikuti bacaan Anda';
    setDot('rec', 'Smart tracking aktif');
    document.getElementById('wave').classList.add('show');
    log('ğŸ§  Smart Recognition aktif â€” baca dengan natural, sistem akan mengikuti');
  };

  rec.onresult = (e) => {
    if (!sessionActive || processingResult) return;
    if (window.srWarmingUp) {
      console.log('ğŸ”‡ Warm-up period â€” ignoring result');
      return;
    }
    
    const lastIdx = e.results.length - 1;
    const result = e.results[lastIdx];
    
    // Try all alternatives if available (not just [0])
    let transcript = '';
    let foundValidTranscript = false;
    
    for (let i = 0; i < Math.min(result.length, 3); i++) {
      const alt = result[i].transcript.trim();
      if (alt && alt.length > 0) {
        transcript = alt;
        foundValidTranscript = true;
        if (i > 0) console.log(`ğŸ“ Using alternative ${i}: "${alt}"`);
        break;
      }
    }
    
    // If no valid transcript found, skip
    if (!foundValidTranscript) {
      console.warn('âš ï¸ All alternatives empty â€” SR heard noise/silence');
      return;
    }
    
    // Show interim results in real-time
    if (!result.isFinal) {
      document.getElementById('tText').textContent = transcript + ' â³';
      document.getElementById('tText').classList.add('live');
      console.log(`ğŸ¤ Interim: "${transcript.slice(0, 30)}..."`);
      return;
    }
    
    // Final result processing
    document.getElementById('tText').textContent = transcript;
    document.getElementById('tText').classList.add('live');
    setTimeout(() => document.getElementById('tText').classList.remove('live'), 2000);
    
    console.log(`âœ… SR Final: "${transcript}" (buffer now: ${transcriptBuffer.length + 1} chunks)`);
    
    lastTranscriptTime = Date.now();
    transcriptBuffer.push(transcript);
    
    // Clear silence timeout and set new one
    clearTimeout(silenceTimeout);
    silenceTimeout = setTimeout(() => {
      console.log(`â±ï¸ 10ms silence reached â€” processing buffer of ${transcriptBuffer.length} chunks`);
      processBufferedTranscripts();
    }, 10); // 10ms â€” very fast response
    
    // Also process immediately if buffer gets large
    if (transcriptBuffer.length >= 3) {
      console.log(`ğŸ“¦ Buffer full (${transcriptBuffer.length} chunks) â€” processing immediately`);
      clearTimeout(silenceTimeout);
      processBufferedTranscripts();
    }
  };

  rec.onerror = (e) => {
    if (e.error === 'not-allowed') {
      log('âŒ Izinkan akses mikrofon di browser', true);
      setMicOff();
      sessionActive = false;
      recRunning = false;
    } else if (e.error === 'no-speech') {
      // Don't show error for no-speech, just continue
    } else if (e.error !== 'aborted') {
      log('âš ï¸ Error: ' + e.error);
    }
  };

  rec.onend = () => {
    if (sessionActive && recRunning) {
      // Auto-restart to keep listening
      setTimeout(() => {
        if (sessionActive && recRunning) {
          try {
            rec.start();
          } catch(e) {
            if (e.name !== 'InvalidStateError') {
              console.error('Restart error:', e);
            }
          }
        }
      }, 100);
    } else {
      setMicOff();
    }
  };

  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SMART TRANSCRIPT PROCESSING â€” Ayah-level DTW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// DTW: align spoken sequence to reference sequence, return match ratio
function dtwScore(spokenArr, refArr) {
  const m = spokenArr.length, n = refArr.length;
  if (!m || !n) return 0;
  const INF = -1e9;
  const dp = Array.from({length: m+1}, () => new Float32Array(n+1).fill(INF));
  dp[0][0] = 0;
  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      const ws = wordSim(spokenArr[i-1], refArr[j-1]);
      const best = Math.max(
        dp[i-1][j-1],          // match
        dp[i-1][j]   - 0.30,   // skip spoken (SR hallucinated) â€” raised penalty
        dp[i][j-1]   - 0.30    // skip ref (user mumbled) â€” raised penalty
      );
      if (best > INF / 2) dp[i][j] = best + ws;
    }
  }
  // Best score ending anywhere in reference (partial alignment ok)
  let best = INF;
  for (let j = 1; j <= n; j++) if (dp[m][j] > best) best = dp[m][j];
  // Normalize: divide by spoken length
  return best > INF/2 ? best / m : 0;
}

function processBufferedTranscripts() {
  if (!transcriptBuffer.length || cursor >= allWords.length) {
    transcriptBuffer = []; return;
  }

  processingResult = true;
  const fullTranscript = transcriptBuffer.join(' ');
  transcriptBuffer = [];
  window.emptyTranscriptCount = 0;

  const spokenTokens = fullTranscript.trim().split(/\s+/).filter(Boolean);
  if (!spokenTokens.length) {
    console.warn('âš ï¸ Empty transcript');
    processingResult = false; return;
  }

  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log(`ğŸ¯ "${fullTranscript.slice(0,60)}" [${spokenTokens.length} tokens]`);

  // â”€â”€ Record where this reading session chunk started (for retry return point)
  if (sessionRunStart < 0) sessionRunStart = cursor;

  // â”€â”€ Collect reference words: CURRENT AYAH ONLY, strictly â”€â”€
  // NEVER peek into the next ayah within one utterance.
  // Rationale: if SR captures trailing words from next ayah (user reading smoothly),
  // those extra tokens simply won't find a match and the loop stops â€” safe.
  // But if we DO peek and match them, cursor jumps ahead and the NEXT utterance
  // falsely validates as correct (the bug seen in ayat 3â†’4â†’5 skip).
  const currentAyahIdx = cursor < allWords.length ? allWords[cursor].ayahIndex : currentAyahIndex;
  const remainingWords = [];
  for (let i = cursor; i < allWords.length; i++) {
    if (allWords[i].ayahIndex !== currentAyahIdx) break;
    remainingWords.push({ idx: i, norm: allWords[i].norm, normStrict: allWords[i].normStrict, ref: allWords[i].ref, original: allWords[i].original, ayahIndex: allWords[i].ayahIndex });
  }

  // Quick sanity: DTW score against the window
  const refNorms = remainingWords.map(w => w.norm);
  const windowScore = dtwScore(spokenTokens, refNorms);
  console.log(`   Window DTW score: ${windowScore.toFixed(3)} (${remainingWords.length} ref words)`);

  // â”€â”€ Sanity check: is this transcript plausibly matching current position? â”€â”€
  // If window score is very low â†’ user is likely reading the wrong ayah/position.
  // We distinguish two cases:
  //   A) Very short transcript (1-2 tokens) with low score â†’ might be noise, wait
  //   B) Longer transcript with low score â†’ user definitely reading wrong place â†’ ERROR
  const isLikelyNoise = windowScore < 0.30 && spokenTokens.length <= 2;
  const isWrongPosition = windowScore < 0.20 && spokenTokens.length >= 2;
  
  if (isLikelyNoise) {
    console.log(`âš ï¸ Short transcript, low score (${windowScore.toFixed(3)}) â€” likely noise, ignoring`);
    processingResult = false;
    return;
  }

  // â”€â”€ FIRST-WORD GATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Purpose: detect when user reads a completely different ayah/position.
  // 
  // Strategy: check if spoken[0] matches ref[cursor].
  // STRICT mode (cursor at start of ayah): must match, else ERROR immediately.
  // LOOSE mode (cursor mid-ayah): if spoken[0] doesn't match, also try spoken[0]
  //   against ref[cursor+1] and ref[cursor+2] â€” SR might have swallowed one word.
  //   If still no match â†’ ERROR.
  //
  // This catches "user reads ayah N+1 while cursor at ayah N" without blocking
  // legitimate cases like SR missing a word at start of an utterance mid-ayah.
  if (remainingWords.length > 0) {
    const firstRefNorm = remainingWords[0].norm;
    const firstSpoken = spokenTokens[0];
    const firstWS = wordSim(firstSpoken, firstRefNorm);
    
    // Try bigram: ref[0]+ref[1] vs spoken[0]
    let bigramWS = 0;
    if (remainingWords.length >= 2) {
      const bg = remainingWords[0].norm + remainingWords[1].norm;
      bigramWS = Math.max(...spokenCandidates(firstSpoken).map(c => simNorm(c, bg)),
                          simNorm(normalizeArabic(firstSpoken), bg));
    }

    // Is cursor at the very first word of this ayah?
    const isAtAyahStart = cursor === 0 || 
      (cursor > 0 && allWords[cursor - 1].ayahIndex !== currentAyahIdx);
    
    let firstWordMatches = firstWS >= MATCH_THRESHOLD || bigramWS >= 0.72;
    
    // Mid-ayah: also try next 1-2 ref words (SR may have missed a word)
    if (!firstWordMatches && !isAtAyahStart && remainingWords.length >= 2) {
      const ws1 = wordSim(firstSpoken, remainingWords[1].norm);
      if (ws1 >= MATCH_THRESHOLD) firstWordMatches = true;
      if (!firstWordMatches && remainingWords.length >= 3) {
        const ws2 = wordSim(firstSpoken, remainingWords[2].norm);
        if (ws2 >= MATCH_THRESHOLD) firstWordMatches = true;
      }
    }
    
    console.log(`   ğŸ”‘ First-word gate: spoken="${firstSpoken}" vs ref="${firstRefNorm}" â†’ ws=${firstWS.toFixed(2)}, bigram=${bigramWS.toFixed(2)}, ayahStart=${isAtAyahStart}, pass=${firstWordMatches}`);
    
    if (!firstWordMatches) {
      console.log(`âŒ First-word gate FAILED â€” user reading wrong position`);
      const cursorWord = allWords[cursor];
      if (cursorWord && cursorWord.el.className !== 'w correct') {
        cursorWord.el.className = 'w wrong';
        wrongCount++;
      }
      playWrongSound();
      enterRetryMode(cursor);
      setDot('warn', 'âš ï¸ Posisi salah');
      matchStats.mismatches++;
      updateStats();
      processingResult = false;
      return;
    }
  }

  // â”€â”€ Greedy per-word match: advance as far as spoken tokens reach â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let matchedAny = false, hasError = false;
  let correctInBatch = 0, wrongInBatch = 0;
  let firstWrongIdx = -1;
  let lastCorrectCursor = cursor;

  let si = 0;
  let refSkipped = 0;
  const MAX_LEADING_SKIP = 0; // No leading skip â€” must match from current cursor position

  for (let wi = 0; wi < remainingWords.length && si < spokenTokens.length; wi++) {
    const wObj = allWords[remainingWords[wi].idx];
    if (!wObj || !wObj.norm) continue;

    // â”€â”€ Try single-word match first â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Look-ahead limited to si+2: prevents system from skipping spoken tokens
    // and finding a match much later (which would wrongly validate skipped content)
    let bestWS = 0, bestSI = -1;
    for (let t = si; t < Math.min(si + 2, spokenTokens.length); t++) {
      let ws = wordSim(spokenTokens[t], wObj.norm);

      // â”€â”€ SHORT WORD STRICT CHECK (â‰¤5 chars): preserve Ø£ vs Ø¥ distinction â”€â”€â”€â”€â”€â”€
      // For short words, ar-SA SR outputs Ø£Ù† vs Ø¥Ù† as different tokens.
      // normalizeArabic() merges both to Ø§Ù†, losing the distinction.
      // normStrict() keeps Ø£/Ø¥ separate â†’ if spoken Ø£Ù† vs ref Ø¥Ù† â†’ score drops.
      if (wObj.normStrict && wObj.norm.length <= 5) {
        const spokenStrict = normalizeArabicStrict(spokenTokens[t]);
        // If strict norms differ but loose norms match â†’ harakat error detected
        if (spokenStrict !== wObj.normStrict) {
          // Check: is the difference ONLY in Ø£ vs Ø¥ (hamza fathah vs kasrah)?
          const spokenLoose = normalizeArabic(spokenTokens[t]);
          if (spokenLoose === wObj.norm) {
            // Consonants match but hamza form differs â†’ harakat error
            console.log(`   ğŸ”¤ Hamza harakat error: spoken="${spokenTokens[t]}"(${spokenStrict}) vs ref="${wObj.ref}"(${wObj.normStrict}) â†’ penalized`);
            ws *= 0.60; // Heavy penalty â€” pushes below MATCH_THRESHOLD 0.72
          }
        }
      }

      // â”€â”€ HARAKAT PENALTY (when SR includes diacritics in output) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (ws >= 0.55 && wObj.ref) {
        const penalty = harakatPenalty(spokenTokens[t], wObj.ref);
        if (penalty < 1.0) {
          console.log(`   ğŸ”¤ Harakat penalty: spoken="${spokenTokens[t]}" ref="${wObj.ref}" penalty=${penalty.toFixed(2)}`);
          ws *= penalty;
        }
      }

      if (ws > bestWS) { bestWS = ws; bestSI = t; }
    }

    // â”€â”€ Try ref BIGRAM: merge ref[wi] + ref[wi+1] to match ONE spoken token â”€â”€
    // Handles tajweed cases where two short ref words sound like one SR token
    // e.g. Ø£ÙÙ†+Ù„ÙÙ‘Ø§ â†’ SR outputs "Ø§Ù„Ø§"; Ù‡ÙÙ…ÙÙ‘Ø§Ø²Ù+Ù…ÙÙ‘Ø´ÙÙ‘Ø§Ø¡Ù â†’ SR outputs "Ù‡Ù…Ø§Ø²Ù…Ø´Ø§Ø¡"
    let bigramMatched = false;
    if (wi + 1 < remainingWords.length) {
      const wObj2 = allWords[remainingWords[wi + 1].idx];
      if (wObj2 && wObj2.norm) {
        const bigramNorm = wObj.norm + wObj2.norm; // merged norm of 2 ref words
        let bestBigramWS = 0, bestBigramSI = -1;
        for (let t = si; t < Math.min(si + 3, spokenTokens.length); t++) {
          const spokenNorm = normalizeArabic(spokenTokens[t]);
          const candidates = spokenCandidates(spokenTokens[t]);
          let bgWS = Math.max(
            ...candidates.map(c => simNorm(c, bigramNorm)),
            simNorm(spokenNorm, bigramNorm)
          );
          if (bgWS > bestBigramWS) { bestBigramWS = bgWS; bestBigramSI = t; }
        }
        
        if (bestBigramWS >= 0.72) {
          console.log(`   ğŸ”— Bigram: "${spokenTokens[bestBigramSI]}" ~ "${wObj.norm}+${wObj2.norm}" (${bestBigramWS.toFixed(2)})`);
          wObj.el.className = 'w correct';
          wObj2.el.className = 'w correct';
          correctCount += 2; correctInBatch += 2;
          si = bestBigramSI + 1;
          lastCorrectCursor = remainingWords[wi + 1].idx + 1;
          matchedAny = true;
          refSkipped = 0;
          wi++;
          bigramMatched = true;
        }
      }
    }
    if (bigramMatched) continue;

    // â”€â”€ Normal single-word result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (bestWS >= MATCH_THRESHOLD) {
      wObj.el.className = 'w correct';
      correctCount++; correctInBatch++;
      if (bestSI >= 0) si = bestSI + 1;
      lastCorrectCursor = remainingWords[wi].idx + 1;
      matchedAny = true;
      refSkipped = 0;
    } else if (bestWS >= 0.65) {
      // Partial match â€” SR quirk on long/complex Quranic words only
      wObj.el.className = 'w correct';
      correctCount++; correctInBatch++;
      console.log(`   ğŸŸ¡ Partial: "${spokenTokens[bestSI] || '?'}" ~ "${wObj.norm}" (${bestWS.toFixed(2)})`);
      if (bestSI >= 0) si = bestSI + 1;
      lastCorrectCursor = remainingWords[wi].idx + 1;
      matchedAny = true;
      refSkipped = 0;
    } else {
      // No match for this ref word
      // Only flag as wrong if in the SAME ayah as cursor start
      if (remainingWords[wi].ayahIndex === currentAyahIdx && wObj.el.className !== 'w correct') {
        wObj.el.className = 'w wrong';
        wrongCount++; wrongInBatch++;
        hasError = true;
        if (firstWrongIdx < 0) firstWrongIdx = remainingWords[wi].idx;
      }
      break;
    }
  }

  // â”€â”€ Handle case: nothing matched at all â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // User spoke something but it doesn't match current position â†’ treat as ERROR
  if (!matchedAny) {
    console.log(`âš ï¸ No words matched â€” user likely reading wrong position`);
    // Mark the current cursor word as wrong
    const cursorWord = allWords[cursor];
    if (cursorWord && cursorWord.el.className !== 'w correct' && cursorWord.ayahIndex === currentAyahIdx) {
      cursorWord.el.className = 'w wrong';
      wrongCount++; wrongInBatch++;
      hasError = true;
      firstWrongIdx = cursor;
    }
    // If still no error (e.g. cursor word is already correct), just warn silently
    if (!hasError) {
      matchStats.mismatches++;
      setDot('warn', 'âš ï¸ Bacaan tidak terdeteksi jelas');
      updateStats();
      processingResult = false;
      return;
    }
  }

  // â”€â”€ Advance cursor to how far user correctly read â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (correctInBatch > 0 && !hasError) {
    if (lastCorrectCursor > cursor) {
      cursor = lastCorrectCursor;
      const newAyah = cursor < allWords.length ? allWords[cursor].ayahIndex : currentAyahIndex;
      if (newAyah !== currentAyahIndex) {
        currentAyahIndex = newAyah;
        updateCurrentAyahHighlight();
        log(`ğŸ“– Pindah ke ayat ${currentAyahIndex + 1}`);
      }
      highlightCursor();
      allWords[cursor]?.el?.closest('.ayah-row')
        ?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  } else if (correctInBatch > 0 && hasError) {
    // Error detected â€” do NOT advance cursor past error
    // Keep cursor at where it was before this batch (retry mode will reset it)
    // Don't update cursor here â€” enterRetryMode will set it to sessionRunStart
  }

  // â”€â”€ Analytics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  matchStats.totalProcessed += spokenTokens.length;
  if (correctInBatch > 0) matchStats.directMatch += correctInBatch;
  if (wrongInBatch > 0) {
    matchStats.mismatches += wrongInBatch;
    matchStats.recentMismatches.push({
      sw: spokenTokens.slice(0,3).join(' ').slice(0,20),
      exp: `cursor ${cursor}`,
      score: windowScore.toFixed(2)
    });
    if (matchStats.recentMismatches.length > 20) matchStats.recentMismatches.shift();
  }

  console.log(`ğŸ“Š Done: cursorâ†’${cursor}, correct=${correctInBatch}, errors=${hasError}`);
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

  if (hasError && firstWrongIdx >= 0) {
    playWrongSound();
    // Reset any words marked correct in this batch (from cursor to firstWrongIdx)
    // since enterRetryMode will re-evaluate and re-highlight them
    // (enterRetryMode will mark them green itself based on what's in the current ayah)
    for (let i = cursor; i < firstWrongIdx; i++) {
      if (allWords[i]?.el?.className === 'w correct') {
        // keep â€” enterRetryMode will re-mark them appropriately
      }
    }
    // Reset any additional wrong words after first wrong â†’ idle
    for (let i = firstWrongIdx + 1; i < allWords.length; i++) {
      if (allWords[i]?.el?.className === 'w wrong') {
        allWords[i].el.className = 'w idle';
        wrongCount--;
      }
    }
    enterRetryMode(firstWrongIdx);
  } else if (correctInBatch > 0) {
    playCorrectSound();
    exitRetryMode();
    // Reset session run start for next chunk
    sessionRunStart = cursor;
  }

  if (hasError)        setDot('warn', 'âš ï¸ Ada kesalahan');
  else if (matchedAny) setDot('ok', 'âœ“ Bagus!');

  updateStats();
  processingResult = false;
  if (cursor >= allWords.length) onSurahComplete();
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RETRY MODE â€” ketika salah, user kembali ke awal sesi bacaan
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let retryMode = false;
let retryCursor = -1;       // index kata yang salah (ditandai merah)
let retryAyahStart = -1;    // index awal sesi bacaan (kursor emas â†’ titik harus ulang dari sini)

function enterRetryMode(wrongWordIdx) {
  retryMode = true;
  retryCursor = wrongWordIdx;

  const wrongWord = allWords[wrongWordIdx];
  if (!wrongWord) return;

  // Titik kembali = awal ayat tempat kata salah berada
  // (selalu kembali ke awal ayat, bukan hanya sessionRunStart,
  //  agar user mengulang SELURUH ayat dari awal)
  const wrongAyah = wrongWord.ayahIndex;
  let returnIdx = wrongWordIdx;
  for (let i = wrongWordIdx - 1; i >= 0; i--) {
    if (allWords[i].ayahIndex === wrongAyah) returnIdx = i; else break;
  }

  retryAyahStart = returnIdx;

  // Visual state:
  // - Kata SEBELUM returnIdx (ayat-ayat sebelumnya): tetap sebagaimana adanya (correct/passed)
  // - Kata dari returnIdx sampai SEBELUM kata salah: highlight HIJAU (sudah benar di sesi ini)
  // - Kata yang salah: MERAH
  // - Kata setelah kata salah: idle
  
  // Reset kata setelah kata salah â†’ idle
  for (let i = wrongWordIdx + 1; i < allWords.length; i++) {
    if (allWords[i]?.el?.className === 'w correct' || allWords[i]?.el?.className === 'w wrong') {
      allWords[i].el.className = 'w idle';
    }
  }

  // Kata dari returnIdx s.d. sebelum wrongWordIdx: tandai hijau (benar dalam batch ini)
  for (let i = returnIdx; i < wrongWordIdx; i++) {
    if (allWords[i]?.el && allWords[i].el.className !== 'w correct') {
      allWords[i].el.className = 'w correct';
    }
  }

  // Pastikan kata yang salah tetap merah
  if (wrongWord.el) wrongWord.el.className = 'w wrong';

  // Set cursor ke titik kembali (awal ayat)
  cursor = returnIdx;
  // Tandai kata di returnIdx sebagai retry-cursor (kuning di atas hijau)
  if (allWords[returnIdx]?.el) {
    allWords[returnIdx].el.className = 'w retry-cursor';
  }
  currentAyahIndex = wrongAyah;
  updateCurrentAyahHighlight();

  // Reset sessionRunStart agar sesi retry dimulai dari awal ayat
  sessionRunStart = returnIdx;

  // Banner
  const wrongAyahNum = wrongWord.ayahIndex + 1;
  document.getElementById('retryAyahNum').textContent = `AYAT ${wrongAyahNum}`;
  document.getElementById('retryWord').textContent = wrongWord.original || wrongWord.norm;
  document.getElementById('retryBanner').style.display = 'flex';

  // Scroll agar kata salah (merah) kelihatan
  wrongWord.el.closest('.ayah-row')?.scrollIntoView({ behavior: 'smooth', block: 'center' });

  log(`ğŸ” Salah di kata "${wrongWord.original}" â€” ulangi dari awal ayat ${wrongAyahNum}`);
  setDot('warn', 'ğŸ” Ulangi dari posisi kursor kuning');
}

function exitRetryMode() {
  // Clean up any retry-cursor styling before exiting
  allWords.forEach(w => {
    if (w.el?.className === 'w retry-cursor') {
      w.el.className = 'w idle';
    }
  });
  retryMode = false;
  retryCursor = -1;
  retryAyahStart = -1;
  document.getElementById('retryBanner').style.display = 'none';
}

function skipWrongWord() {
  // Lewati sampai akhir ayat tempat kata salah berada, lanjut ke ayat berikutnya
  if (retryCursor >= 0 && retryCursor < allWords.length) {
    const wrongAyahIndex = allWords[retryCursor].ayahIndex;
    let nextIdx = retryCursor;
    while (nextIdx < allWords.length && allWords[nextIdx].ayahIndex === wrongAyahIndex) {
      if (allWords[nextIdx].el.className !== 'w correct') {
        allWords[nextIdx].el.className = 'w skipped';
      }
      nextIdx++;
    }
    cursor = nextIdx;
    if (cursor < allWords.length) {
      currentAyahIndex = allWords[cursor].ayahIndex;
    }
    sessionRunStart = cursor;
  }
  exitRetryMode();
  highlightCursor();
  updateCurrentAyahHighlight();
  log('â­ Ayat dilewati â€” lanjut ke ayat berikutnya');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
  if (tab === 'sambung') initSambungSelects();
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  document.getElementById('tabcontent-' + tab).classList.add('active');
}
function playCorrectSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    
    // Play two pleasant tones (like a "ding")
    const frequencies = [800, 1000];
    frequencies.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      
      osc.frequency.value = freq;
      osc.type = 'sine';
      
      const startTime = ctx.currentTime + i * 0.05;
      gain.gain.setValueAtTime(0.1, startTime);
      gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.15);
      
      osc.start(startTime);
      osc.stop(startTime + 0.15);
    });
  } catch(e) {
    console.error('Audio context error:', e);
  }
}

function playWrongSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    
    // Lower frequency for "wrong" sound
    osc.frequency.value = 200;
    osc.type = 'sawtooth';
    
    gain.gain.setValueAtTime(0.15, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);
    
    osc.start();
    osc.stop(ctx.currentTime + 0.25);
  } catch(e) {
    console.error('Audio context error:', e);
  }
}

function beepWrong() {
  playWrongSound();
}

function onSurahComplete() {
  stopSession();
  setDot('ok', 'ğŸ‰ Selesai!');
  log('ğŸ‰ Alhamdulillah! Surah selesai â€” Benar: ' + correctCount + ' | Salah: ' + wrongCount);
  document.getElementById('tText').textContent = 'Masyaa Allah! ğŸŒ™';
  document.getElementById('micLabel').textContent = 'Selesai!';
  document.getElementById('micSub').textContent = 'Tekan untuk mulai ulang';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SESSION CONTROL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSession() {
  if (sessionActive) stopSession();
  else startSession();
}

async function startSession() {
  if (displayMode === 'madani') {
    log('â„¹ï¸ Mode Mushaf Madani: gunakan untuk membaca, bukan tracking');
    return;
  }

  // Ensure mic permission once â€” keeps stream alive so browser won't ask again
  const micOk = await ensureMicPermission();
  if (!micOk) {
    log('âŒ Izinkan akses mikrofon di browser', true);
    return;
  }
  
  if (!rec && !setupRec()) {
    log('âŒ Browser tidak support Speech Recognition', true);
    return;
  }

  sessionActive = true;
  transcriptBuffer = [];
  lastTranscriptTime = Date.now();
  sessionRunStart = cursor; // catat posisi awal sesi
  
  // Warm-up flag: ignore first 500ms of results (mic stabilization)
  window.srWarmingUp = true;
  setTimeout(() => {
    window.srWarmingUp = false;
    console.log('âœ… Warm-up complete â€” tracking active');
    log('âœ… Siap â€” mulai membaca sekarang');
  }, 500);

  if (!recRunning) {
    try {
      rec.start();
      log('ğŸ¤ Memulai mikrofon... tunggu "LIVE" sebelum baca');
    } catch(e) {
      log('âš ï¸ Error: ' + e.message, true);
      sessionActive = false;
    }
  } else {
    setDot('rec', 'Smart tracking aktif');
    document.getElementById('wave').classList.add('show');
    document.getElementById('btnMic').classList.add('live');
    log('â–¶ï¸ Melanjutkan sesi â€” baca dengan natural');
  }
}

function stopSession() {
  sessionActive = false;
  clearTimeout(silenceTimeout);
  transcriptBuffer = [];
  setMicOff();
}

function setMicOff() {
  document.getElementById('wave').classList.remove('show');
  document.getElementById('btnMic').classList.remove('live');
  document.getElementById('btnMic').textContent = 'ğŸ™ï¸';
  document.getElementById('micLabel').textContent = 'Mulai Sesi';
  document.getElementById('micSub').textContent = 'Smart tracking: otomatis mengikuti';
  setDot('', 'Sesi dijeda');
}

function setDot(state, text) {
  document.getElementById('sdot').className = 'sdot' + (state ? ' '+state : '');
  document.getElementById('stext').textContent = text;
}

function log(msg, err) {
  const b = document.getElementById('logBar');
  b.textContent = msg;
  b.className = 'log-bar' + (err ? ' err' : '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
  const total = allWords.length;
  const pct = total ? Math.round(cursor/total*100) : 0;
  const wrongs = allWords.filter(w => w.el && w.el.className === 'w wrong').length;
  const corrects = allWords.filter(w => w.el && w.el.className === 'w correct').length;
  document.getElementById('stOk').textContent  = corrects;
  document.getElementById('stErr').textContent = wrongs;
  document.getElementById('stPos').textContent = cursor + 1 > total ? total : cursor + 1;
  document.getElementById('progFill').style.width = pct + '%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function jumpBack() {
  cursor = Math.max(0, cursor - 5);
  for (let i = cursor; i < allWords.length; i++) {
    if (allWords[i].el.className && allWords[i].el.className.includes('w ')) {
      allWords[i].el.className = 'w idle';
    }
  }
  if (cursor < allWords.length) {
    currentAyahIndex = allWords[cursor].ayahIndex;
    updateCurrentAyahHighlight();
  }
  highlightCursor();
  log('â® Mundur ke kata ' + (cursor+1));
}

function skipForward() {
  if (cursor < allWords.length) {
    // Mark as "skipped" (not wrong, just skipped by user)
    allWords[cursor].el.className = 'w skipped';
    cursor++;
    if (cursor < allWords.length) {
      currentAyahIndex = allWords[cursor].ayahIndex;
      updateCurrentAyahHighlight();
    }
    highlightCursor();
    updateStats();
    log(`â­ Lewati ke kata ${cursor + 1}: "${allWords[cursor]?.original || 'selesai'}"`);
  }
}

// New function: Mark current word as correct manually (for SR issues)
function markCorrect() {
  if (cursor < allWords.length) {
    allWords[cursor].el.className = 'w correct';
    correctCount++;
    cursor++;
    if (cursor < allWords.length) {
      currentAyahIndex = allWords[cursor].ayahIndex;
      updateCurrentAyahHighlight();
    }
    highlightCursor();
    updateStats();
    playCorrectSound();
    log(`âœ… Ditandai benar â€” lanjut ke kata ${cursor + 1}`);
  }
}

function resetSession() {
  sessionActive = false;
  clearTimeout(silenceTimeout);
  transcriptBuffer = [];
  setMicOff();
  correctCount = 0; wrongCount = 0; cursor = 0; currentAyahIndex = 0;
  processingResult = false; sessionRunStart = -1;
  allWords.forEach(w => { 
    if (w.el.className && w.el.className.includes('w ')) {
      w.el.className = 'w idle'; 
    }
  });
  highlightCursor();
  updateCurrentAyahHighlight();
  document.getElementById('tText').textContent = 'â€”';
  document.getElementById('tText').classList.remove('live');
  updateStats();
  log('â†º Reset â€” tekan ğŸ™ï¸ untuk mulai sesi baru');
}

async function loadSurah() {
  currentSurah = parseInt(document.getElementById("surahSel").value);
  correctCount = 0; wrongCount = 0; cursor = 0; currentAyahIndex = 0;
  processingResult = false; sessionRunStart = -1;
  transcriptBuffer = [];
  clearTimeout(silenceTimeout);
  
  if (audioPlaying) stopAudioPlayer();
  
  document.getElementById("tText").textContent = "â€”";
  document.getElementById("tText").classList.remove("live");

  // For dynamic surahs, load first then update UI
  const surahName = SURAHS[currentSurah]?.name || JUZ_SURAHS[currentSurah]?.name || '...';
  log("ğŸ“– Memuat " + surahName + "...");

  await renderPage(currentSurah);
  updateStats();
  
  const surahData = SURAHS[currentSurah];
  if (surahData) {
    document.getElementById('startAyahNum').max = surahData.ayahs.length;
    document.getElementById('startAyahNum').value = 1;
    updateStartPosition();
    log("ğŸ“– " + surahData.name + " dimuat â€” siap untuk tracking");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  START POSITION FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStartPosition() {
  const startAyah = parseInt(document.getElementById('startAyahNum').value);
  const surahData = SURAHS[currentSurah];
  
  if (!surahData) return;
  
  const maxAyah = surahData.ayahs.length;
  if (startAyah < 1 || startAyah > maxAyah) {
    document.getElementById('startInfo').textContent = `âŒ Ayat tidak valid (1-${maxAyah})`;
    document.getElementById('startInfo').style.color = '#ef6b5a';
    return;
  }
  
  document.getElementById('startInfo').textContent = `Akan mulai dari ayat ${startAyah}`;
  document.getElementById('startInfo').style.color = '';
}

function goToStartPosition() {
  const startAyah = parseInt(document.getElementById('startAyahNum').value);
  const surahData = SURAHS[currentSurah];
  
  if (!surahData) return;
  
  const maxAyah = surahData.ayahs.length;
  if (startAyah < 1 || startAyah > maxAyah) {
    log(`âŒ Ayat tidak valid. Pilih antara 1-${maxAyah}`, true);
    return;
  }
  
  // Find the first word index of the target ayah
  let targetWordIndex = 0;
  let targetAyahIndex = startAyah - 1; // Convert to 0-based index
  
  for (let i = 0; i < allWords.length; i++) {
    if (allWords[i].ayahIndex === targetAyahIndex) {
      targetWordIndex = i;
      break;
    }
  }
  
  // Reset words before this position to idle
  for (let i = 0; i < targetWordIndex; i++) {
    if (allWords[i].el.className && allWords[i].el.className.includes('w ')) {
      allWords[i].el.className = 'w passed';
    }
  }
  
  // Reset words from this position onwards to idle
  for (let i = targetWordIndex; i < allWords.length; i++) {
    if (allWords[i].el.className && allWords[i].el.className.includes('w ')) {
      allWords[i].el.className = 'w idle';
    }
  }
  
  // Set cursor to the start position
  cursor = targetWordIndex;
  currentAyahIndex = targetAyahIndex;
  
  // Update highlights
  highlightCursor();
  updateCurrentAyahHighlight();
  
  // Scroll to the ayah
  if (allAyahs[targetAyahIndex]) {
    allAyahs[targetAyahIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  
  log(`ğŸ“ Posisi diatur ke ayat ${startAyah} â€” siap untuk muroja'ah`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  const sel = document.getElementById('surahSel');
  // Combine static SURAHS + JUZ_SURAHS for the dropdown
  const allSurahEntries = new Map();
  Object.entries(SURAHS).forEach(([n,s]) => allSurahEntries.set(parseInt(n), s.name));
  Object.entries(JUZ_SURAHS).forEach(([n,s]) => {
    if (!allSurahEntries.has(parseInt(n))) allSurahEntries.set(parseInt(n), s.name);
  });
  [...allSurahEntries.entries()].sort((a,b) => a[0]-b[0]).forEach(([n, name]) => {
    const o = document.createElement('option');
    o.value = n; o.textContent = n + '. ' + name;
    if (n === currentSurah) o.selected = true;
    sel.appendChild(o);
  });

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    log('âŒ Gunakan Chrome untuk Speech Recognition', true);
    document.getElementById('btnMic').disabled = true;
  } else {
    log('ğŸ§  Smart Recognition siap â€” akan otomatis mengikuti bacaan Anda');
  }

  renderPage(currentSurah);
  // Set max value for start ayah input
  const surahData = SURAHS[currentSurah];
  if (surahData) {
    document.getElementById('startAyahNum').max = surahData.ayahs.length;
    updateStartPosition();
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PERSISTENT MIC PERMISSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Request mic permission once on first use, keep stream alive
// so browser doesn't ask again on each SR restart.
let globalMicStream = null;

async function ensureMicPermission() {
  if (globalMicStream) return true; // already have permission
  try {
    globalMicStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    console.log('âœ… Mic permission granted â€” stream kept alive');
    return true;
  } catch (err) {
    console.error('âŒ Mic permission denied:', err);
    return false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAMBUNG AYAT MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sambungActive = false;
let sambungRec = null;
let sambungRecRunning = false;

// Multi-surah config: array of { surahNum, fromAyah, toAyah }
let sambungSurahRanges = [];

let sambungPromptSurah = -1;   // surah num of prompted ayah
let sambungPromptAyahN = -1;   // ayat number prompted by system
let sambungTargetSurah = -1;   // surah num of target ayah
let sambungTargetAyahN = -1;   // ayat number user must recite
let sambungScoreOk = 0;
let sambungScoreErr = 0;
let sambungBuffer = [];
let sambungSilenceTimeout = null;
let sambungCurrentAudio = null;
let sambungWaitingForUser = false;

function initSambungSelects() {
  const list = document.getElementById('sambungSurahList');
  if (list.children.length > 0) return;

  // Combine static + dynamic surah metadata for sambung list
  const allForSambung = new Map();
  Object.entries(SURAHS).forEach(([n,s]) => allForSambung.set(parseInt(n), {name:s.name, ayahCount:s.ayahs.length}));
  Object.entries(JUZ_SURAHS).forEach(([n,s]) => {
    if (!allForSambung.has(parseInt(n))) allForSambung.set(parseInt(n), {name:s.name, ayahCount:s.ayahCount});
  });
  [...allForSambung.entries()].sort((a,b) => a[0]-b[0]).forEach(([num, meta]) => {
    const s = {name: meta.name, ayahs: {length: meta.ayahCount}};
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:7px;cursor:pointer;transition:background 0.15s';
    row.onmouseenter = () => row.style.background = 'rgba(255,255,255,0.05)';
    row.onmouseleave = () => row.style.background = '';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = `sc_${num}`;
    cb.value = num;
    cb.style.cssText = 'width:15px;height:15px;accent-color:var(--gold);cursor:pointer;flex-shrink:0';
    cb.onchange = () => onSambungCheckboxChange(num, cb.checked, {name: s.name, ayahs: {length: meta.ayahCount}});

    const lbl = document.createElement('label');
    lbl.htmlFor = `sc_${num}`;
    lbl.style.cssText = 'font-size:12px;color:var(--text);cursor:pointer;flex:1';
    lbl.textContent = `${num}. ${s.name} (${meta.ayahCount} ayat)`;

    row.appendChild(cb);
    row.appendChild(lbl);
    row.onclick = (e) => { if (e.target !== cb) { cb.checked = !cb.checked; onSambungCheckboxChange(num, cb.checked, {name: s.name, ayahs: {length: meta.ayahCount}}); } };
    list.appendChild(row);
  });
}

function onSambungCheckboxChange(surahNum, checked, surahData) {
  const maxAyah = surahData.ayahs.length;
  const configDiv = document.getElementById('sambungRangeConfig');

  if (checked) {
    // Add range row for this surah
    const row = document.createElement('div');
    row.id = `srange_${surahNum}`;
    row.style.cssText = 'background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;display:flex;flex-direction:column;gap:6px';
    row.innerHTML = `
      <div style="font-size:11px;font-weight:700;color:var(--gold-light);text-transform:uppercase;letter-spacing:0.5px">${surahNum}. ${surahData.name}</div>
      <div style="display:flex;align-items:center;gap:8px">
        <span style="font-size:11px;color:var(--muted);min-width:55px">Dari Ayat</span>
        <input type="number" id="sfrom_${surahNum}" value="1" min="1" max="${maxAyah}"
          style="flex:1;background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:5px 8px;font-size:13px;text-align:center">
        <span style="font-size:11px;color:var(--muted)">â€“</span>
        <input type="number" id="sto_${surahNum}" value="${maxAyah}" min="1" max="${maxAyah}"
          style="flex:1;background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:5px 8px;font-size:13px;text-align:center">
        <span style="font-size:11px;color:var(--muted);min-width:30px">/ ${maxAyah}</span>
      </div>`;
    configDiv.appendChild(row);
  } else {
    // Remove range row
    const row = document.getElementById(`srange_${surahNum}`);
    if (row) row.remove();
  }
}

function startSambungMode() {
  // Collect selected surahs and their ranges
  sambungSurahRanges = [];
  const checkboxes = document.querySelectorAll('#sambungSurahList input[type=checkbox]:checked');
  
  if (checkboxes.length === 0) {
    alert('Pilih minimal 1 surah dulu');
    return;
  }

  let hasError = false;
  checkboxes.forEach(cb => {
    const num = parseInt(cb.value);
    const data = SURAHS[num];
    const maxAyah = data.ayahs.length;
    const from = parseInt(document.getElementById(`sfrom_${num}`)?.value || 1);
    const to   = parseInt(document.getElementById(`sto_${num}`)?.value   || maxAyah);

    if (from < 1 || to > maxAyah || from >= to) {
      alert(`Range tidak valid untuk ${data.name}. Range harus minimal 2 ayat dan dalam batas 1â€“${maxAyah}`);
      hasError = true;
      return;
    }
    sambungSurahRanges.push({ surahNum: num, fromAyah: from, toAyah: to });
  });

  if (hasError || sambungSurahRanges.length === 0) return;

  sambungScoreOk = 0;
  sambungScoreErr = 0;
  sambungActive = true;
  document.getElementById('sambungSetup').style.display = 'none';
  document.getElementById('sambungActive').style.display = 'flex';
  document.getElementById('sambungResult').style.display = 'none';
  updateSambungScore();
  nextSambung();
}

function stopSambungMode() {
  sambungActive = false;
  sambungWaitingForUser = false;
  stopSambungRec();
  if (sambungCurrentAudio) { sambungCurrentAudio.pause(); sambungCurrentAudio = null; }
  if (sambungSilenceTimeout) { clearTimeout(sambungSilenceTimeout); sambungSilenceTimeout = null; }
  document.getElementById('sambungSetup').style.display = 'block';
  document.getElementById('sambungActive').style.display = 'none';
  document.getElementById('sambungResult').style.display = 'none';
  setSambungDot('idle', 'Selesai');
}

async function nextSambung() {
  stopSambungRec();
  sambungWaitingForUser = false;
  document.getElementById('sambungResult').style.display = 'none';
  document.getElementById('sambungTranscript').textContent = 'â€”';
  setSambungDot('idle', 'Memilih ayat...');

  // Pick random surah from selected ranges (weighted by range size)
  let pool = [];
  sambungSurahRanges.forEach(r => {
    for (let n = r.fromAyah; n <= r.toAyah - 1; n++) {
      pool.push({ surahNum: r.surahNum, ayahN: n });
    }
  });

  if (pool.length === 0) {
    setSambungDot('warn', 'âš ï¸ Tidak ada ayat dalam range yang valid');
    return;
  }

  const pick = pool[Math.floor(Math.random() * pool.length)];
  sambungPromptSurah = pick.surahNum;
  sambungPromptAyahN = pick.ayahN;
  sambungTargetSurah = pick.surahNum;

  // Ensure dynamic surah is loaded before use
  let data = SURAHS[sambungPromptSurah];
  if (!data) {
    setSambungDot('idle', 'ğŸ“– Memuat surah...');
    data = await loadDynamicSurah(sambungPromptSurah);
    if (!data) { setSambungDot('warn', 'âš ï¸ Gagal memuat surah'); return; }
  }
  const promptAyahObj = data.ayahs.find(a => a.n === sambungPromptAyahN);
  // target = next ayah in same surah
  const promptIdx = data.ayahs.findIndex(a => a.n === sambungPromptAyahN);
  const targetAyahObj = data.ayahs[promptIdx + 1];
  sambungTargetAyahN = targetAyahObj.n;

  document.getElementById('sambungAyahInfo').textContent = `${data.name} â€¢ Ayat ${sambungPromptAyahN}`;
  document.getElementById('sambungAyahText').textContent = promptAyahObj.words.join(' ');

  setSambungDot('idle', 'ğŸ”Š Sistem sedang membaca...');
  document.getElementById('sambungMicBtn').disabled = true;
  document.getElementById('sambungMicLabel').textContent = 'Tunggu...';
  document.getElementById('sambungMicSub').textContent = 'Sistem sedang membaca';

  playSambungAudio(sambungPromptSurah, sambungPromptAyahN, () => {
    if (!sambungActive) return;
    sambungWaitingForUser = true;
    setSambungDot('idle', 'ğŸ™ï¸ Sambung ayat ' + sambungTargetAyahN + ' â€” tekan mikrofon');
    document.getElementById('sambungMicBtn').disabled = false;
    document.getElementById('sambungMicLabel').textContent = 'Sambung Ayat ' + sambungTargetAyahN;
    document.getElementById('sambungMicSub').textContent = 'Tekan untuk bicara';
  });
}

function playSambungAudio(surahNum, ayahNum, onDone) {
  if (sambungCurrentAudio) { sambungCurrentAudio.pause(); sambungCurrentAudio = null; }
  const url = getAudioUrl(surahNum, ayahNum);
  const audio = new Audio(url);
  sambungCurrentAudio = audio;
  const replayBtn = document.getElementById('sambungReplayBtn');
  if (replayBtn) replayBtn.disabled = true;

  audio.onended = () => {
    sambungCurrentAudio = null;
    if (replayBtn) replayBtn.disabled = false;
    if (onDone) onDone();
  };
  audio.onerror = () => {
    sambungCurrentAudio = null;
    if (replayBtn) replayBtn.disabled = false;
    setSambungDot('warn', 'âš ï¸ Audio gagal dimuat â€” langsung sambung');
    if (onDone) onDone();
  };
  audio.play().catch(() => {
    if (replayBtn) replayBtn.disabled = false;
    if (onDone) onDone();
  });
}

function sambungReplayAudio() {
  if (!sambungActive) return;
  setSambungDot('idle', 'ğŸ”Š Memutar ulang...');
  document.getElementById('sambungMicBtn').disabled = true;
  sambungWaitingForUser = false;
  stopSambungRec();
  playSambungAudio(sambungPromptSurah, sambungPromptAyahN, () => {
    if (!sambungActive) return;
    sambungWaitingForUser = true;
    setSambungDot('idle', 'ğŸ™ï¸ Sambung ayat ' + sambungTargetAyahN);
    document.getElementById('sambungMicBtn').disabled = false;
  });
}

async function toggleSambungSession() {
  if (!sambungWaitingForUser) return;
  if (sambungRecRunning) {
    stopSambungRec();
    processSambungBuffer();
  } else {
    // Ensure mic permission first (once only)
    const ok = await ensureMicPermission();
    if (!ok) {
      setSambungDot('warn', 'âŒ Izinkan akses mikrofon');
      return;
    }
    startSambungRec();
  }
}

function startSambungRec() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { setSambungDot('warn', 'âŒ Gunakan Chrome'); return; }

  sambungBuffer = [];
  if (!sambungRec) {
    sambungRec = new SR();
    sambungRec.lang = 'ar-SA';
    sambungRec.continuous = true;
    sambungRec.interimResults = true;
    sambungRec.maxAlternatives = 3;

    sambungRec.onresult = (e) => {
      let finalText = '';
      for (let i = e.resultIndex; i < e.results.length; i++) {
        if (e.results[i].isFinal) finalText += e.results[i][0].transcript + ' ';
      }
      if (finalText.trim()) {
        sambungBuffer.push(finalText.trim());
        document.getElementById('sambungTranscript').textContent = sambungBuffer.join(' ');
        clearTimeout(sambungSilenceTimeout);
        sambungSilenceTimeout = setTimeout(processSambungBuffer, 1500);
      }
    };

    sambungRec.onend = () => {
      sambungRecRunning = false;
      document.getElementById('sambungMicBtn').textContent = 'ğŸ™ï¸';
      document.getElementById('sambungMicBtn').style.background = '';
      document.getElementById('sambungMicSub').textContent = 'Tekan untuk bicara';
    };

    sambungRec.onerror = (e) => {
      sambungRecRunning = false;
      if (e.error === 'not-allowed') {
        setSambungDot('warn', 'âŒ Izinkan akses mikrofon');
        globalMicStream = null; // reset so next attempt asks again
      } else if (e.error !== 'no-speech' && e.error !== 'aborted') {
        setSambungDot('warn', 'âš ï¸ Error SR: ' + e.error);
      }
    };
  }

  try {
    sambungRec.start();
    sambungRecRunning = true;
    document.getElementById('sambungMicBtn').textContent = 'â¹ï¸';
    document.getElementById('sambungMicBtn').style.background = 'rgba(239,107,90,0.3)';
    setSambungDot('live', 'ğŸ™ï¸ Sedang mendengarkan...');
    document.getElementById('sambungMicSub').textContent = 'Tekan lagi untuk selesai';
  } catch(e) {
    setSambungDot('warn', 'âŒ Gagal mulai mic');
  }
}

function stopSambungRec() {
  if (sambungRec && sambungRecRunning) {
    try { sambungRec.stop(); } catch(e) {}
    sambungRecRunning = false;
  }
  clearTimeout(sambungSilenceTimeout);
  const btn = document.getElementById('sambungMicBtn');
  if (btn) { btn.textContent = 'ğŸ™ï¸'; btn.style.background = ''; }
}

function processSambungBuffer() {
  clearTimeout(sambungSilenceTimeout);
  stopSambungRec();
  sambungWaitingForUser = false;
  if (!sambungActive) return;

  const spokenRaw = sambungBuffer.join(' ').trim();
  sambungBuffer = [];

  if (!spokenRaw) {
    setSambungDot('warn', 'âš ï¸ Tidak ada bacaan terdeteksi');
    sambungWaitingForUser = true;
    return;
  }

  const data = SURAHS[sambungTargetSurah];
  const targetAyah = data.ayahs.find(a => a.n === sambungTargetAyahN);
  if (!targetAyah) return;

  const result = validateSambung(spokenRaw, targetAyah.words);
  showSambungResult(result, targetAyah.words);
}

function validateSambung(spokenRaw, refWords) {
  const spokenTokens = spokenRaw.trim().split(/\s+/).filter(Boolean);
  if (!spokenTokens.length) return { ok: false, score: 0, detail: 'Tidak ada bacaan' };

  // First word gate â€” must match
  const firstRefNorm = normalizeArabic(refWords[0]);
  const firstWS = wordSim(spokenTokens[0], firstRefNorm);
  if (firstWS < MATCH_THRESHOLD) {
    return { ok: false, score: 0, detail: 'Kata pertama tidak cocok' };
  }

  // Count sequential matches
  let matched = 0;
  let si = 0;
  for (let wi = 0; wi < refWords.length && si < spokenTokens.length; wi++) {
    const refNorm = normalizeArabic(refWords[wi]);
    const ws = wordSim(spokenTokens[si], refNorm);
    if (ws >= MATCH_THRESHOLD) {
      matched++; si++;
    } else if (wi + 1 < refWords.length) {
      // try bigram
      const bg = refNorm + normalizeArabic(refWords[wi + 1]);
      const bgWS = simNorm(normalizeArabic(spokenTokens[si]), bg);
      if (bgWS >= 0.72) { matched += 2; si++; wi++; }
      else break;
    } else break;
  }

  const minRequired = Math.max(1, Math.ceil(refWords.length * 0.5));
  const ok = matched >= minRequired;
  return { ok, score: matched / refWords.length, matched, total: refWords.length, detail: `${matched}/${refWords.length} kata cocok` };
}

function showSambungResult(result, refWords) {
  const data = SURAHS[sambungTargetSurah];
  const resultDiv  = document.getElementById('sambungResult');
  const msgDiv     = document.getElementById('sambungResultMsg');
  const expectedDiv = document.getElementById('sambungExpected');
  const labelDiv   = document.getElementById('sambungResultLabel');

  expectedDiv.textContent = refWords.join(' ');

  if (result.ok) {
    sambungScoreOk++;
    labelDiv.textContent = `âœ… Benar â€” Ayat ${sambungTargetAyahN} ${data.name}`;
    msgDiv.textContent = `Masyaa Allah! ${result.detail}`;
    msgDiv.style.cssText = 'font-size:13px;font-weight:600;text-align:center;padding:10px;border-radius:8px;background:rgba(93,186,125,0.15);color:#5dba7d;border:1px solid rgba(93,186,125,0.3)';
    setSambungDot('ok', 'âœ… Sambungan benar!');
    playCorrectSound();
  } else {
    sambungScoreErr++;
    labelDiv.textContent = `âŒ Salah â€” Ayat ${sambungTargetAyahN} ${data.name}`;
    msgDiv.textContent = result.score === 0 ? `Bukan ayat yang tepat â€” ${result.detail}` : `Kurang tepat â€” ${result.detail}`;
    msgDiv.style.cssText = 'font-size:13px;font-weight:600;text-align:center;padding:10px;border-radius:8px;background:rgba(239,107,90,0.15);color:#ef6b5a;border:1px solid rgba(239,107,90,0.3)';
    setSambungDot('warn', 'âŒ Sambungan salah');
    playWrongSound();
  }

  resultDiv.style.display = 'block';
  updateSambungScore();
  resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function updateSambungScore() {
  document.getElementById('sambungOk').textContent = sambungScoreOk;
  document.getElementById('sambungErr').textContent = sambungScoreErr;
  document.getElementById('sambungTotal').textContent = sambungScoreOk + sambungScoreErr;
}

function setSambungDot(type, text) {
  const dot = document.getElementById('sambungDot');
  const txt = document.getElementById('sambungText');
  if (!dot || !txt) return;
  dot.className = 'sdot';
  if (type === 'ok')        { dot.style.background = '#5dba7d'; dot.style.animation = ''; }
  else if (type === 'warn') { dot.style.background = '#ef6b5a'; dot.style.animation = ''; }
  else if (type === 'live') { dot.style.background = '#f59e0b'; dot.style.animation = 'pulse 1s infinite'; }
  else                      { dot.style.background = 'rgba(255,255,255,0.2)'; dot.style.animation = ''; }
  txt.textContent = text;
}


window.addEventListener('DOMContentLoaded', () => {
  init();
  initSambungSelects();
});
</script>
</body>
</html>
